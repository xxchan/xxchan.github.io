<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.9.5">Jekyll</generator><link href="https://xxchan.me/feed.xml" rel="self" type="application/atom+xml" /><link href="https://xxchan.me/" rel="alternate" type="text/html" /><updated>2024-06-20T14:57:22+00:00</updated><id>https://xxchan.me/feed.xml</id><title type="html">XX&apos;s Blog</title><subtitle>Just some random thoughts of mine.</subtitle><author><name>xxchan</name></author><entry><title type="html">Why English Quote (&apos;) looks bad in my blog?</title><link href="https://xxchan.me/misc/2024/06/12/quotation-mark.html" rel="alternate" type="text/html" title="Why English Quote (&apos;) looks bad in my blog?" /><published>2024-06-12T00:00:00+00:00</published><updated>2024-06-12T00:00:00+00:00</updated><id>https://xxchan.me/misc/2024/06/12/quotation-mark</id><content type="html" xml:base="https://xxchan.me/misc/2024/06/12/quotation-mark.html"><![CDATA[<p>As you might have noticed, I write blogs in both Chinese and English. My approach to multilingual blogs is straightforward and somewhat brute-force: I simply put them together without a language switcher or any filtering. Admittedly, I haven't figured out how to implement this in Jekyll due to a lack of motivation.</p>

<p>One issue I encountered was the font, as Chinese characters looked unattractive with the default settings. I also don't want different configurations for each language, but some Chinese fonts don't support English characters. Currently, I'm using <a href="https://fonts.google.com/noto/specimen/Noto+Serif+SC">Noto Serif SC</a>, which looks decent enough.</p>

<p>This setup works well for the most part, except for two small, puzzling clouds..</p>
<ol>
  <li>The HTML header is <code class="language-plaintext highlighter-rouge">&lt;html lang="zh"&gt;</code> for all pages. I'm unsure of the impact, so I haven't have enough motivation to address it yet.</li>
  <li>(The main topic of this post) The quotation mark <code class="language-plaintext highlighter-rouge">'</code> is displayed as a full-width character (<code class="language-plaintext highlighter-rouge">â€™</code>), which looks quite strange.</li>
</ol>

<p><img src="/assets/img/quotation-mark.png" alt="quotation-mark.png" /></p>

<p>Initially, I thought it was a font issue. However, testing revealed that the Noto Serif SC font could render <code class="language-plaintext highlighter-rouge">'</code> nicely. Copying the rendered character showed it was indeed converted to <code class="language-plaintext highlighter-rouge">â€™</code>, rather than just being rendered differently.</p>

<p>I suspected it might be a Jekyll issue, but found no similar questions. Eventually, I broadened my search to "Jekyll Quotes" and discovered some related issues: <a href="https://github.com/jekyll/jekyll/issues/1858">All quotes in markup text had to be escaped Â· Issue #1858 Â· jekyll/jekyll</a>. In their case, the quotation mark was even more problematic. I tried escaping it in my blog with <code class="language-plaintext highlighter-rouge">\'</code>, which could also solve my issue.</p>

<p><img src="/assets/img/quotation-mark-2.png" alt="quotation-mark-2.png" /></p>

<p>I began to realize that it's a feature (not a bug) of the markdown processor (not Jekyll), called "smart quotes", which performs the conversion. And here's a blog about the rationale behind it: <a href="https://webdesignledger.com/common-typography-mistakes-apostrophes-versus-quotation-marks/">Common Typography Mistakes: Apostrophes Versus Quotation Marks</a></p>

<p>To summarize, the reason why <code class="language-plaintext highlighter-rouge">'</code> looks bad in my blog is because it's first converted to <code class="language-plaintext highlighter-rouge">â€™</code>, and since I'm using a Chinese font, it is rendered in full-width, which looks awkward among English words.</p>

<p>Why aren't others complaining about this? Perhaps because few people mix English and Chinese posts together..</p>

<p>How should I solve this problem? According to the post mentioned, the conversion is legitimate, and the quotation mark should not be used. 
However, this would require using different fonts for English and Chinese. 
I'd rather not be so "correct" and opt for a simpler workaround: disable the "smart quotes" feature and live with the quotation marks.</p>

<hr />

<p>At this point, I'm considering whether I should switch to a better multilingual solution or even abandon Jekyll altogether. 
Maybe I should develop my own blog without using any static site generator, as my blog is noting fancy just markdown to HTML?</p>

<blockquote>
  <p>Static Site Generators are an example of the template method pattern, where the framework provides the overall control flow, but also includes copious extension points for customizing behaviors. Template method allows for some code re-use at the cost of obscure and indirect control flow. This pattern pays off when you have many different invocations of template method with few, if any, non-trivial customizations. Conversely, a template method with a single, highly customized call-site probably should be refactored away in favor of direct control flow.</p>

  <p>If you maintain dozens mostly identical websites, you definitely need a static site generator. If you have only one site to maintain, you might consider writing the overall scaffolding yourself.</p>

  <p><a href="https://matklad.github.io/2023/11/07/dta-oriented-blogging.html">Data Oriented Blogging</a> by matklad</p>
</blockquote>]]></content><author><name>xxchan</name></author><category term="Misc" /><summary type="html"><![CDATA[As you might have noticed, I write blogs in both Chinese and English. My approach to multilingual blogs is straightforward and somewhat brute-force: I simply put them together without a language switcher or any filtering. Admittedly, I haven't figured out how to implement this in Jekyll due to a lack of motivation.]]></summary></entry><entry><title type="html">New site for This Week in RisingWave</title><link href="https://xxchan.me/this-week-in-risingwave/2023/04/02/twirw-migration.html" rel="alternate" type="text/html" title="New site for This Week in RisingWave" /><published>2023-04-02T00:00:00+00:00</published><updated>2023-04-02T00:00:00+00:00</updated><id>https://xxchan.me/this-week-in-risingwave/2023/04/02/twirw-migration</id><content type="html" xml:base="https://xxchan.me/this-week-in-risingwave/2023/04/02/twirw-migration.html"><![CDATA[<p>This Week in RisingWave is now migrated to a new dedicated site: <a href="https://this-week-in-risingwave.vercel.app">this-week-in-risingwave.vercel.app</a>.</p>

<p>By the way, xxchan's blog also has a new domain name: <a href="https://xxchan.me">xxchan.me</a>. The old domain name <a href="https://xxchan.github.io">xxchan.github.io</a> should still work.</p>

<p>Please tell me if any of the links or other things like RSS are broken! Thanks! ğŸ¥°</p>]]></content><author><name>xxchan</name></author><category term="This-Week-in-RisingWave" /><summary type="html"><![CDATA[This Week in RisingWave is now migrated to a new dedicated site: this-week-in-risingwave.vercel.app.]]></summary></entry><entry><title type="html">Stupidly effective ways to optimize Rust compile time</title><link href="https://xxchan.me/cs/2023/02/17/optimize-rust-comptime-en.html" rel="alternate" type="text/html" title="Stupidly effective ways to optimize Rust compile time" /><published>2023-02-17T00:00:00+00:00</published><updated>2023-02-17T00:00:00+00:00</updated><id>https://xxchan.me/cs/2023/02/17/optimize-rust-comptime-en</id><content type="html" xml:base="https://xxchan.me/cs/2023/02/17/optimize-rust-comptime-en.html"><![CDATA[<p><a href="/cs/2023/02/11/optimize-rust-comptime.html">æœ¬æ–‡çš„ä¸­æ–‡ç‰ˆ</a></p>

<p>Although there are often complaints saying Rust's compilation speed is notorious slow, our project <a href="https://github.com/risingwavelabs/risingwave">RisingWave</a> is not very slow to compile, especially since previously contributors like (<a href="https://github.com/skyzh">skyzh</a>, <a href="https://github.com/bugenzhao">BugenZhao</a>) have put in a lot of effort. After using an M1 MacBook Pro, compiling is not a problem at all. A full debug compilation only takes 2-3 minutes.</p>

<p>However, over time, more and more things have been added to our CI, making it increasingly bloated. The main workflow now takes about 40 minutes, while the PR workflow takes about 25 minutes 30 seconds. Although it is still not intolerably slow, it is already noticeably slower than before.</p>

<p>So a few days ago, I decided to spend some time researching whether I could optimize the compilation speed a bit more.</p>

<p>What shocked me was that there were some very simple methods that, with just a little effort, produced astonishing results. I feel like I can describe them as low-hanging fruits, silver bullets, or even free lunch ğŸ¤¯.</p>

<hr />

<p>P.S. I highly recommend <a href="https://github.com/matklad">matklad</a>'s blog (He is the original author of IntelliJ Rust and rust-analyzer):</p>
<ul>
  <li><a href="https://matklad.github.io/2021/09/04/fast-rust-builds.html">Fast Rust Builds</a></li>
  <li><a href="https://matklad.github.io/2021/02/27/delete-cargo-integration-tests.html">Delete Cargo Integration Tests</a></li>
</ul>

<p>Most of the methods I used are discussed there, and he explains them clearly. If not otherwise indicated, all quotes in this article come from there.</p>

<p>Although there are quite some articles talking about how to optimize Rust compilation speed (e.g., <a href="https://endler.dev/2020/rust-compile-times/">Tips for Faster Rust Compile Times</a>), I still want to write another one to share my step-by-step process. Each optimization point comes with a corresponding PR, and you can combine the <a href="https://github.com/risingwavelabs/risingwave/commits/main?after=d8198fa138003e1f1431053f4f5f09e4a5fa8fd8+69&amp;branch=main&amp;qualified_name=refs%2Fheads%2Fmain">commit history</a> to see the effect of each optimization point by comparing the CI pages before and after its PR.</p>

<hr />

<p>P.P.S. Results after optimization: main workflow is now 27 minutes at the fastest, and PR workflow is now 16 minutes at the fastest, with most taking around 17-19 minutes.</p>

<h2 id="valuable-data-and-charts-to-find-the-bottlenecks">Valuable data and charts to find the bottlenecks</h2>

<blockquote>
  <p>Build times are a fairly easy optimization problem: itâ€™s trivial to get direct feedback (just time the build), there are a bunch of tools for profiling, and you donâ€™t even need to come up with a representative benchmark.</p>
</blockquote>

<p>When trying to optimize anything, it would be good to have some profiling data and charts to find out the bottlenecks. Luckily, we do have some nice ones for optimizing CI time.</p>

<h3 id="ci-waterfall--dag-graph">CI Waterfall &amp; DAG Graph</h3>

<p>We use Buildkite for our CI, and the normal view of a page (such as <a href="https://buildkite.com/risingwavelabs/pull-request/builds/17099">Build #17099</a>) looks like this:</p>

<p><img src="/assets/img/comptime/buildkite-1.png" alt="buildkite-1.png" /></p>

<p>Buildkite has two very useful hidden pages, located at <code class="language-plaintext highlighter-rouge">/waterfall</code> and <code class="language-plaintext highlighter-rouge">/dag</code>, respectively, which show:</p>

<p><img src="/assets/img/comptime/buildkite-waterfall.png" alt="buildkite-waterfall.png" /></p>

<p><img src="/assets/img/comptime/buildkite-dag.png" alt="buildkite-dag.png" /></p>

<p>From the waferfall graph, we can see recovery test finishes last. Two large steps finish before it: build (deterministic simulation) and check. The DAG graph shows that recovery test depends only on simulation build, so we can forget about the check step for now, and conclude the biggest bottleneck is in the path of simulation build -&gt; recovery test.</p>

<h3 id="cargo-build---timings"><code class="language-plaintext highlighter-rouge">cargo build --timings</code></h3>

<p>Cargo comes with built-in support for profiling build times (it was stabilized last year), which can be enabled by running <a href="https://doc.rust-lang.org/cargo/reference/timings.html"><code class="language-plaintext highlighter-rouge">cargo build --timings</code></a>. It produces output like this:</p>

<p><img src="/assets/img/comptime/timings.png" alt="timings.png" /></p>

<p>We can see that the compilation times for some dependencies such as <code class="language-plaintext highlighter-rouge">zstd-sys</code> and <code class="language-plaintext highlighter-rouge">protobuf-src</code> are very long, so we should try to optimize them.</p>

<h2 id="step-1-compilation-cache">Step 1: Compilation cache</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7799">ci: try sccache #7799</a></p>

<blockquote>
  <p>If you think about it, itâ€™s pretty obvious how a good caching strategy for CI should work.</p>

  <p>Unfortunately, almost nobody does this.</p>
</blockquote>

<p><a href="https://xuanwo.io/en-us/reports/2023-04/">Why should you give Sccache a try?</a> With xuanwo's strong recommendation, I was very tempted to try sccache, which was also a major trigger for my optimization efforts this time.</p>

<p>It's so easy to use. Just add two environment variables to start it up:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> RUSTC_WRAPPER=sccache</span>
<span class="k">ENV</span><span class="s"> SCCACHE_BUCKET=ci-sccache-bucket</span>
</code></pre></div></div>
<p>(Well, behind the scenes, you actually need to study Buildkite and AWS configurations - which are also very simple. Buildkite can obtain permissions through IAM roles, so I just need to a policy for the role to access an S3 bucket, without the need to configure things like secret keys. I had been thinking about whether I could echo the key out in CI before, but it seems there's no need to worry about that. ğŸ˜„)</p>

<p>The effect was immediately apparent, reducing the simulation build time by 2.5 minutes and the non-bottleneck debug build time by 4 minutes. Although it didn't bring about a qualitative change, why not make use of the (almost free) quantitative change?</p>

<h2 id="step-2-remove-unused-dependencies">Step 2: Remove unused dependencies</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7816">build: remove unused deps #7816</a></p>

<p>All dependencies declared in <code class="language-plaintext highlighter-rouge">Cargo.toml</code> will be compiled regardless of whether they are actually used or not. Moreover, they may introduce unnecessary synchronization points, affecting the parallelism of compilation.</p>

<p>An old tool <a href="https://github.com/est31/cargo-udeps">cargo-udeps</a> is used to remove unused dependencies. But firstly, it does not support automatic fixing, and it is also very slow. Also, I had an impression that it cannot be used together with <code class="language-plaintext highlighter-rouge">workspace-hack</code>. This has led to RisingWave not cleaning up unused dependencies for a long time â€“ a typical broken window effect ğŸ¥²!</p>

<p>In an issue of <code class="language-plaintext highlighter-rouge">cargo-udeps</code> about automatic fix, someone mentioned <a href="https://github.com/bnjbvr/cargo-machete"><code class="language-plaintext highlighter-rouge">cargo-machete</code></a>. Without many investigation I just gave it a shot, hoping it works. It turned out to be very fast and there were not many false positives! Although there were a few small problems (see the commit history of the above PR), they were easily fixed.</p>

<p>The author of <code class="language-plaintext highlighter-rouge">cargo-machete</code> has a <a href="https://blog.benj.me/2022/04/27/cargo-machete/">blog</a> introducing the harm of unused dependencies and the solution of <code class="language-plaintext highlighter-rouge">cargo-machete</code>. Specifically, <code class="language-plaintext highlighter-rouge">cargo-udeps</code> first compiles the project via <code class="language-plaintext highlighter-rouge">cargo check</code> and then analyzes it, while <code class="language-plaintext highlighter-rouge">cargo-machete</code> uses a simple and stupid approach: just <code class="language-plaintext highlighter-rouge">ripgrep</code> it.</p>

<p>This PR immediately removed dozens of unused dependencies, which surprised me again ğŸ¤¯. Unfortunately, the CI time did not decrease further, which seems to indicate that sccache works very wellâ€¦ I roughly tested it locally, and it was faster by about ten to twenty seconds. It seems not a thing, but anyway it's free :)</p>

<hr />

<p>P.S. In fact, <code class="language-plaintext highlighter-rouge">cargo-udeps</code> can also be used with <code class="language-plaintext highlighter-rouge">workspace-hack</code> by configuring it: <a href="https://github.com/risingwavelabs/risingwave/pull/7836">feat(risedev): add <code class="language-plaintext highlighter-rouge">check-udeps</code> #7836</a></p>

<h2 id="step-3-disable-incremental-compilation">Step 3: Disable incremental compilation</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7838">build: disable incremental build in CI #7838</a></p>

<p>After finishing the previous two steps, I almost wanted to finish my work, but I still felt a bit itchy and thought that the simulation build was still a little slow. So I decided to do some profiling. Then I saw the monsters in the <code class="language-plaintext highlighter-rouge">--timings</code> graph that I posted above. I felt that it didn't make sense.</p>

<p>I tried to search the possible reasons why the build artifacts can be non-cacheable for sccache, and found that incremental compilation is a big caveat. I tried to disable it immediately and was shocked again. The effect was stupidly good:</p>

<p><img src="/assets/img/comptime/timings-2.png" alt="timings-2" /></p>

<p>This instantly reduced the time for simulation build by 4 minutesâ€¦</p>

<p>Actually, we turned off incremental compilation for our debug build a long time ago:</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[profile.ci-dev]</span>
<span class="py">incremental</span> <span class="p">=</span> <span class="kc">false</span>
</code></pre></div></div>

<p>But when we added a new build profile <code class="language-plaintext highlighter-rouge">ci-sim</code> later, we didn't consider this issue. If you think about it, you can find although incremental compilation is good, it doesn't make sense in CI!</p>

<blockquote>
  <p>CI builds often are closer to from-scratch builds, as changes are typically much bigger than from a local edit-compile cycle. For from-scratch builds, incremental adds an extra dependency-tracking overhead. It also significantly increases the amount of IO and the size of <code class="language-plaintext highlighter-rouge">./target</code>, which make caching less effective.</p>
</blockquote>

<p>So I simply added a global env var in CI to turn it off once and for all.</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> CARGO_INCREMENTAL=0</span>
</code></pre></div></div>

<h2 id="step-4-single-binary-integration-test">Step 4: Single binary integration test</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7842">build: single-binary integration test #7842</a></p>

<p>It's another <em>stupidly effective</em> optimization. tl;dr:</p>

<p>Donâ€™t do this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tests/
  foo.rs
  bar.rs
</code></pre></div></div>

<p>Do this instead:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tests/
  integration/
    main.rs
    foo.rs
    bar.rs
</code></pre></div></div>

<p>It's because every file under <code class="language-plaintext highlighter-rouge">tests/</code> will be compiled into a separate binary (meaning every one will link dependencies). Apart from slow compilation, this can even slow down test runnings (a flaw in <code class="language-plaintext highlighter-rouge">cargo test</code>).</p>

<p>This optimization didn't reduce our test time (probably due to the superiority of <code class="language-plaintext highlighter-rouge">cargo nextest</code>), but it immediately reduced the compilation time by another 2 minutesâ€¦ It's also a bit funny that it also reduced the time for uploading/downloading, compressing/decompressing artifacts by 2 minutesâ€¦(although the latter did not affect the bottleneck).</p>

<h2 id="some-previous-efforts">Some previous efforts</h2>

<p>The above is the main process of my optimization this time, and now I can finally be satisfied with the work. Finally, I would like to summarize some of our previous efforts for reference.</p>

<ul>
  <li>Use <a href="https://github.com/nextest-rs/nextest"><code class="language-plaintext highlighter-rouge">cargo nextest</code></a> instead of <code class="language-plaintext highlighter-rouge">cargo test</code>.</li>
  <li>Use the <code class="language-plaintext highlighter-rouge">workspace-hack</code> technique: see <a href="https://docs.rs/cargo-hakari/latest/cargo_hakari/about/index.html"><code class="language-plaintext highlighter-rouge">cargo hakari</code></a>.</li>
  <li>Add cache to the cargo registry, or use the recently stabilized <a href="https://blog.rust-lang.org/inside-rust/2023/01/30/cargo-sparse-protocol.html">sparse index</a>.</li>
  <li>Split a huge crate into multiple smaller crates.</li>
  <li>Try to reduce linking time: linking takes a lot of time and is single-threaded, so it may probably become a bottleneck.
    <ul>
      <li>Use a faster linker: <code class="language-plaintext highlighter-rouge">mold</code> for Linux, <code class="language-plaintext highlighter-rouge">zld</code> for macOS. <code class="language-plaintext highlighter-rouge">lld</code> is the most mature option for production use.</li>
      <li>Turn off Link Time Optimization (LTO) on debug builds.</li>
    </ul>
  </li>
  <li>Trade-off between compile time and performance: The total time of CI is compile time + test time, so whether to turn on compile optimization (including LTO mentioned above), and how much to turn on, is actually a trade-off between the two. You can test and adjust that in order to achieve an overall optimal choice. For example, here's our build profile tuned by <a href="https://github.com/bugenzhao">BugenZhao</a>:</li>
</ul>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># The profile used for CI in pull requests.</span>
<span class="c"># External dependencies are built with optimization enabled, while crates in this workspace are built</span>
<span class="c"># with `dev` profile and full debug info. This is a trade-off between build time and e2e test time.</span>
<span class="nn">[profile.ci-dev]</span>
<span class="py">inherits</span> <span class="p">=</span> <span class="s">"dev"</span>
<span class="py">incremental</span> <span class="p">=</span> <span class="kc">false</span>
<span class="nn">[profile.ci-dev.package."*"]</span> <span class="c"># external dependencies</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">1</span>
<span class="nn">[profile.ci-dev.package."tokio"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nn">[profile.ci-dev.package."async_stack_trace"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nn">[profile.ci-dev.package."indextree"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nn">[profile.ci-dev.package."task_stats_alloc"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>

<span class="c"># The profile used for deterministic simulation tests in CI.</span>
<span class="c"># The simulator can only run single-threaded, so optimization is required to make the running time</span>
<span class="c"># reasonable. The optimization level is customized to speed up the build.</span>
<span class="nn">[profile.ci-sim]</span>
<span class="py">inherits</span> <span class="p">=</span> <span class="s">"dev"</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">2</span>
<span class="py">incremental</span> <span class="p">=</span> <span class="kc">false</span>
</code></pre></div></div>

<p>For more optimization techniques, you may refer to other posts like <a href="https://endler.dev/2020/rust-compile-times/">Tips for Faster Rust Compile Times</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Things like CI and DX are easy to become messy if they are not taken care of regularly. My story shows that if you do some maintenance from time to time, you may get unexpected gains. A little effort can bring huge improvements.</p>

<p>Finally I'd like to quote matklad's <a href="https://matklad.github.io/2021/09/04/fast-rust-builds.html">blog</a> again as a conclusion:</p>

<blockquote>
  <p>Compilation time is a <em>multiplier</em> for basically everything. Whether you want to ship more features, to make code faster, to adapt to a change of requirements, or to attract new contributors, build time is a factor in that.</p>

  <p>It also is a non-linear factor. Just waiting for the compiler is the smaller problem. The big one is losing the state of the flow or (worse) mental context switch to do something else while the code is compiling. One minute of work for the compiler wastes more than one minute of work for the human.</p>
</blockquote>

<p>Let's take some time to prevent "<em>broken windows</em>". The effort would pay off!</p>]]></content><author><name>xxchan</name></author><category term="CS" /><summary type="html"><![CDATA[How I reduced 10 minutes of CI time without much effort]]></summary></entry><entry><title type="html">æˆ‘å¦‚ä½•åŠ¨åŠ¨å°æ‰‹å°±è®© CI æ—¶é—´å‡å°‘äº† 10 åˆ†é’Ÿ</title><link href="https://xxchan.me/cs/2023/02/11/optimize-rust-comptime.html" rel="alternate" type="text/html" title="æˆ‘å¦‚ä½•åŠ¨åŠ¨å°æ‰‹å°±è®© CI æ—¶é—´å‡å°‘äº† 10 åˆ†é’Ÿ" /><published>2023-02-11T00:00:00+00:00</published><updated>2023-02-11T00:00:00+00:00</updated><id>https://xxchan.me/cs/2023/02/11/optimize-rust-comptime</id><content type="html" xml:base="https://xxchan.me/cs/2023/02/11/optimize-rust-comptime.html"><![CDATA[<p><a href="/cs/2023/02/17/optimize-rust-comptime-en.html">English version of this post</a></p>

<p>è™½ç„¶ç»å¸¸æœ‰é€¸é—»æŠ±æ€¨ Rust ç¼–è¯‘é€Ÿåº¦è‡­åæ˜­è‘—åœ°æ…¢ï¼Œä½†æˆ‘ä»¬çš„é¡¹ç›® <a href="https://github.com/risingwavelabs/risingwave">RisingWave</a> åœ¨ç»è¿‡å‰äººæ¯”å¦‚ï¼ˆ<a href="https://github.com/skyzh">skyzh</a>ï¼Œ<a href="https://github.com/bugenzhao">BugenZhao</a>ï¼‰çš„ä¸€äº›åŠªåŠ›åï¼Œç¼–è¯‘é€Ÿåº¦å¹¶ä¸ç®—æ…¢ï¼Œç‰¹åˆ«æ˜¯æˆ‘è‡ªä»ç”¨ä¸Š M1 çš„ Macbook Pro åï¼Œç¼–è¯‘é€Ÿåº¦æ ¹æœ¬ä¸æ˜¯é—®é¢˜ï¼Œå…¨é‡ debug ç¼–è¯‘ä¹Ÿå°±ä¸¤ä¸‰åˆ†é’Ÿã€‚</p>

<p>ç„¶è€Œéšç€æ—¶é—´æ¨ç§»ï¼ŒCI é‡ŒåŠ äº†è¶Šæ¥è¶Šå¤šçš„ä¸œè¥¿ï¼Œè¶Šæ¥è¶Šè‡ƒè‚¿äº†ã€‚ç°åœ¨ main workflow éœ€è¦å¤§æ¦‚ 40minï¼ŒPR workflow éœ€è¦å¤§æ¦‚ 25min30sã€‚è™½ç„¶å¹¶ä¸ç®—ç‰¹åˆ«æ…¢ï¼Œä½†æ˜¯å¯ä»¥ä½“æ„Ÿåˆ°æ¯”ä»¥å‰å˜æ…¢äº†ä¸å°‘ã€‚</p>

<p>äºæ˜¯æˆ‘å‰ä¸¤å¤©å¿ƒè¡€æ¥æ½®ï¼Œå†³å®šèŠ±ç‚¹æ—¶é—´ç ”ç©¶ä¸€ä¸‹èƒ½ä¸èƒ½å†ä¼˜åŒ–ä¸€ç‚¹ç¼–è¯‘é€Ÿåº¦ã€‚</p>

<p>ä»¤æˆ‘éå¸¸éœ‡æƒŠçš„æ˜¯ï¼Œæ²¡æƒ³åˆ°å­˜åœ¨ç€ä¸€äº›éå¸¸ç®€å•çš„æ–¹æ³•ï¼ŒåŠ¨åŠ¨å°æ‰‹å°±äº§ç”Ÿäº†æƒŠäººçš„æˆæ•ˆã€‚æ„Ÿè§‰å®Œå…¨å¯ä»¥ç”¨ low-hanging fruitsã€silver bullet ç”šè‡³æ˜¯ free lunch æ¥å½¢å®¹ğŸ¤¯ã€‚</p>

<hr />

<p>P.S. å¾ˆæ¨è <a href="https://github.com/matklad">matklad</a>ï¼ˆIntelliJ Rust å’Œ rust-analyzer çš„åŸä½œè€…ï¼‰çš„ blogï¼š</p>
<ul>
  <li><a href="https://matklad.github.io/2021/09/04/fast-rust-builds.html">Fast Rust Builds</a></li>
  <li><a href="https://matklad.github.io/2021/02/27/delete-cargo-integration-tests.html">Delete Cargo Integration Tests</a></li>
</ul>

<p>æˆ‘ç”¨åˆ°çš„å¤§éƒ¨åˆ†æ–¹æ³•è¿™é‡Œé¢éƒ½æœ‰è®²åˆ°ï¼Œè€Œä¸”ä»–è®²çš„æ¸…æ™°æ˜äº†ã€‚å¦‚æœæ²¡æœ‰å¦å¤–è¯´æ˜ï¼Œé‚£ä¹ˆæ–‡ä¸­çš„ quote éƒ½æ¥è‡ªè¿™é‡Œã€‚</p>

<p>æœ¬æ–‡ç®—æ˜¯æˆ‘çš„å®è·µè®°å½•ï¼Œæˆ–è€…å¤§æ¦‚å¯ä»¥ä¹Ÿå½“æˆä¸€ä¸ª tl; dr ç‰ˆã€‚æ¯ä¸€ä¸ªä¼˜åŒ–ç‚¹éƒ½å¸¦ä¸Šäº†ç›¸åº”çš„ PRï¼Œå¯ä»¥ç»“åˆ <a href="https://github.com/risingwavelabs/risingwave/commits/main?after=d8198fa138003e1f1431053f4f5f09e4a5fa8fd8+69&amp;branch=main&amp;qualified_name=refs%2Fheads%2Fmain">commit history</a> ç‚¹å¼€æ¯ä¸ªä¼˜åŒ–ç‚¹å‰åçš„é¡µé¢å¯¹æ¯”æ•ˆæœã€‚</p>

<hr />

<p>P.P.S. ä¼˜åŒ–å®Œçš„ç»“æœï¼šmain æœ€å¿« 27minï¼ŒPR æœ€å¿« 16minï¼Œå¤§å¤šåœ¨ 17-19min å·¦å³ã€‚</p>

<h2 id="å¯ä¾›å‚è€ƒçš„æ•°æ®å›¾è¡¨">å¯ä¾›å‚è€ƒçš„æ•°æ®ã€å›¾è¡¨</h2>

<blockquote>
  <p>Build times are a fairly easy optimization problem: itâ€™s trivial to get direct feedback (just time the build), there are a bunch of tools for profiling, and you donâ€™t even need to come up with a representative benchmark.</p>
</blockquote>

<p>å‰ä¸¤å¤©åœ¨ç ”ç©¶ <a href="/cs/2023/02/08/profiling-101.html">profiling</a>ï¼Œé‚£ç°åœ¨æåˆ°è¦ä¼˜åŒ–ï¼Œå½“ç„¶åº”è¯¥çœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ•°æ®ã€å›¾è¡¨çœ‹çœ‹ï¼Œæ‰¾åˆ°ç“¶é¢ˆåœ¨å“ªé‡Œå†æ¥ä¼˜åŒ–ã€‚</p>

<h3 id="ci-waterfall--dag-graph">CI waterfall &amp; dag graph</h3>

<p>æˆ‘ä»¬çš„ CI ç”¨çš„æ˜¯ Buildkiteï¼Œæ­£å¸¸ç‚¹å¼€ä¸€ä¸ªé¡µé¢ï¼ˆä¾‹å¦‚ <a href="https://buildkite.com/risingwavelabs/pull-request/builds/17099">Build #17099</a>ï¼‰é•¿è¿™æ ·ï¼š</p>

<p><img src="/assets/img/comptime/buildkite-1.png" alt="buildkite-1.png" /></p>

<p>Buildkite æœ‰ä¸¤ä¸ªéå¸¸å¥½ç”¨çš„éšè—é¡µé¢ï¼Œåˆ†åˆ«æ˜¯åœ¨ <code class="language-plaintext highlighter-rouge">/waterfall</code> å’Œ <code class="language-plaintext highlighter-rouge">/dag</code> é‡Œï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>

<p><img src="/assets/img/comptime/buildkite-waterfall.png" alt="buildkite-waterfall.png" /></p>

<p><img src="/assets/img/comptime/buildkite-dag.png" alt="buildkite-dag.png" /></p>

<p>ä»å›¾ä¸Šæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹å‡ºï¼Œæœ€å¤§çš„ç“¶é¢ˆæ˜¯ simulation build -&gt; recovery test</p>

<h3 id="cargo-build---timings"><code class="language-plaintext highlighter-rouge">cargo build --timings</code></h3>

<p>Cargo è‡ªå¸¦ profiling ç¼–è¯‘æ—¶é—´çš„æ”¯æŒï¼ˆè²Œä¼¼æ˜¯å»å¹´ stablize çš„ï¼‰ï¼Œé€šè¿‡ <a href="https://doc.rust-lang.org/cargo/reference/timings.html">cargo build â€“timings</a> å¯ç”¨ï¼Œå®ƒé•¿è¿™æ ·ï¼š</p>

<p><img src="/assets/img/comptime/timings.png" alt="timings.png" /></p>

<p>å¯ä»¥å‘ç° <code class="language-plaintext highlighter-rouge">zstd-sys</code> ï¼Œ <code class="language-plaintext highlighter-rouge">protobuf-src</code> ç­‰å‡ ä¸ªä¾èµ–çš„ç¼–è¯‘æ—¶é—´éå¸¸é•¿ï¼Œåº”è¯¥æƒ³åŠæ³•çœ‹çœ‹èƒ½ä¸èƒ½ä¼˜åŒ–æ‰ã€‚</p>

<h2 id="step-1-compilation-cache">Step 1: Compilation cache</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7799">ci: try sccache #7799</a></p>

<blockquote>
  <p>If you think about it, itâ€™s pretty obvious how a good caching strategy for CI should work.</p>

  <p>Unfortunately, almost nobody does this.</p>
</blockquote>

<p><a href="https://xuanwo.io/reports/2023-04/">2023-04: ä¸ºä»€ä¹ˆä½ è¯¥è¯•è¯• Sccacheï¼Ÿ</a> åœ¨ xuanwo çš„å¤§åŠ›é¼“å¹ä¸‹ï¼Œæˆ‘éå¸¸å¿ƒåŠ¨ï¼Œä¹Ÿæƒ³å°è¯•ä¸€ä¸‹ sccacheã€‚è¿™ä¹Ÿç®—æ˜¯æˆ‘è¿™æ¬¡æä¼˜åŒ–çš„ä¸€å¤§ triggerã€‚</p>

<p>ä¸ç”¨å¤šè¯´ï¼Œéå¸¸ç®€å•å¥½ç”¨ã€‚åªéœ€åŠ ä¸¤ä¸ªç¯å¢ƒå˜é‡å°±ä¸€é”®å¯åŠ¨äº†ï¼š</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> RUSTC_WRAPPER=sccache</span>
<span class="k">ENV</span><span class="s"> SCCACHE_BUCKET=ci-sccache-bucket</span>
</code></pre></div></div>

<p>ï¼ˆåœ¨è¿™èƒŒåå…¶å®éœ€è¦ç ”ç©¶ä¸€ä¸‹ Buildkite å’Œ AWS çš„é…ç½®â€”â€”å®é™…ä¸Šä¹Ÿéå¸¸å‚»ç“œã€‚Buildkite å¯ä»¥é€šè¿‡ IAM Role æ¥è·å¾—æƒé™ï¼ŒåŠ ä¸€ä¸ª S3 bucket çš„ policy å°± work äº†ï¼Œå®Œå…¨ä¸ç”¨é…ç½® secret key ä¹‹ç±»çš„ä¸œè¥¿ã€‚æˆ‘ä¹‹å‰è¿˜åœ¨æ€è€ƒèƒ½ä¸èƒ½åœ¨ CI é‡ŒæŠŠ key echo å‡ºæ¥ï¼Œçœ‹æ¥æ˜¯å®Œå…¨ä¸ç”¨æ‹…å¿ƒè¿™ç§äº‹ğŸ˜„ï¼‰</p>

<p>æ•ˆæœç«‹ç«¿è§å½±ï¼Œsimulation build å‡å°‘äº† 2.5minï¼Œéç“¶é¢ˆçš„ debug build å‡å°‘äº† 4minã€‚è™½ç„¶å¹¶æ²¡æœ‰è´¨å˜ï¼Œä½†æ˜¯å…è´¹çš„é‡å˜ä½•ä¹è€Œä¸ä¸ºå‘¢ï¼Ÿ</p>

<h2 id="step-2-remove-unused-dependencies">Step 2: Remove unused dependencies</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7816">build: remove unused deps #7816</a></p>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">Cargo.toml</code> ä¸­å£°æ˜çš„ä¾èµ–ä¸ç®¡å®é™…ä¸Šæœ‰æ²¡æœ‰ç”¨åˆ°ï¼Œéƒ½ä¼šè¢«ç¼–è¯‘ã€‚æ›´ç”šå®ƒå¯èƒ½ä¼šå¼•å…¥ä¸å¿…è¦çš„ syncronization pointï¼Œå½±å“ç¼–è¯‘çš„å¹¶è¡Œåº¦ã€‚</p>

<p>æœ‰ä¸ªè€å·¥å…· <a href="https://github.com/est31/cargo-udeps">cargo-udeps</a> å°±æ˜¯å¹²è¿™ä¸ªçš„ï¼Œä½†æ˜¯é¦–å…ˆå®ƒå¹¶ä¸æ”¯æŒè‡ªåŠ¨ä¿®å¤ï¼Œè€Œä¸”å®ƒå¾ˆæ…¢ã€‚å¦å¤–å°è±¡ä¸­æœ‰ä¸€ä¸ªæ¯›ç—…æ˜¯å®ƒä¸èƒ½å’Œ <code class="language-plaintext highlighter-rouge">workspace-hack</code> ä¸€èµ·ç”¨ã€‚è¿™å¯¼è‡´ RisingWave ä¸­é•¿æœŸæ²¡æœ‰æ¸…ç†è¿‡ unused dependenciesã€‚å…¸å‹çš„ç ´çª—æ•ˆåº”ğŸ¥²ï¼</p>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">cargo-udeps</code> é‡Œå…³äºè‡ªåŠ¨ fix çš„ issue ä¸‹é¢çœ‹åˆ°æœ‰äººæäº† <a href="https://github.com/bnjbvr/cargo-machete"> <code class="language-plaintext highlighter-rouge">cargo-machete</code> </a>ï¼ˆè¿™ä¸ªåå­—æ˜¯å¤§ç åˆ€çš„æ„æ€ğŸ¤£ï¼‰ï¼Œè§‰å¾—æ˜¯éª¡å­æ˜¯é©¬æ‹‰å‡ºæ¥é›é›ï¼Œå‘ç°å®ƒè·‘çš„é£å¿«ï¼Œä¹Ÿæ²¡æœ‰å‡ ä¸ª false postiveã€‚è™½ç„¶æœ‰å‡ ä¸ªå°é—®é¢˜ï¼ˆå‚è€ƒä¸Šé¢ PR çš„ commit historyï¼‰ï¼Œä½†æ˜¯éƒ½èƒ½å®¹æ˜“åœ°ä¿®æ‰ã€‚</p>

<p>å¤§ç åˆ€çš„ä½œè€…æœ‰ä¸€ç¯‡ <a href="https://blog.benj.me/2022/04/27/cargo-machete/">blog</a> ä»‹ç»äº† unused dependencies çš„å±å®³ä»¥åŠ <code class="language-plaintext highlighter-rouge">cargo-machete</code> çš„è§£æ³•ã€‚å…·ä½“è¯´æ¥ï¼Œ<code class="language-plaintext highlighter-rouge">cargo-udeps</code> æ˜¯ç”¨ <code class="language-plaintext highlighter-rouge">cargo check</code> å…ˆç¼–è¯‘äº†ä¸€éå†åˆ†æçš„ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">cargo-machete</code> æ˜¯ç®€å•ç²—æš´çš„ <code class="language-plaintext highlighter-rouge">ripgrep</code>ã€‚</p>

<p>è¿™ä¸ª PR ä¸€ä¸‹å­åˆ æ‰äº†å¤§å‡ åä¸ª udepsï¼Œä¹Ÿæ˜¯è®©æˆ‘å¤§åƒä¸€æƒŠğŸ¤¯ã€‚å¯æƒœçš„æ˜¯ï¼ŒCI çš„æ—¶é—´å¹¶æ²¡æœ‰è¿›ä¸€æ­¥ç¼©çŸ­ï¼Œæ„Ÿè§‰è¿™ä¾§é¢è¯´æ˜äº† cache æ•ˆæœå¾ˆå¥½â€¦â€¦æˆ‘æœ¬åœ°ç²—ç•¥åœ°æµ‹äº†ä¸€ä¸‹ï¼Œå¤§æ¦‚å¿«äº†åå‡ äºŒåç§’ã€‚èšŠå­è…¿ä¹Ÿæ˜¯è‚‰å˜›ï¼Œanyway it's free!</p>

<hr />

<p>P.S. å…¶å® <code class="language-plaintext highlighter-rouge">cargo-udeps</code> é…ä¸€ä¸‹ä¹Ÿæ˜¯èƒ½å’Œ <code class="language-plaintext highlighter-rouge">workspace-hack</code> ç”¨çš„ï¼š<a href="https://github.com/risingwavelabs/risingwave/pull/7836">feat(risedev): add <code class="language-plaintext highlighter-rouge">check-udeps</code> #7836</a></p>

<h2 id="step-3-disable-incremental-compilation">Step 3: Disable incremental compilation</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7838">build: disable incremental build in CI #7838</a></p>

<p>å¹²å®Œä¸Šé¢ä¸¤ä¸ªå°å·¥ä½œä¹‹åæœ¬æ¥å·²ç»æƒ³æ”¶å·¥äº†ï¼Œä½†æœ‰ç‚¹å¿ƒç—’ç—’ï¼Œè§‰å¾— simulation build è¿˜æ˜¯æœ‰ç‚¹æ…¢ã€‚äºæ˜¯æˆ‘å†³å®š profiling ä¸€ä¸‹çœ‹çœ‹ã€‚ç„¶åå°±çœ‹åˆ°äº†ä¸€å¼€å§‹è´´çš„ <code class="language-plaintext highlighter-rouge">--timings</code> çš„å›¾ä¸­çš„å‡ ä¸ªåºç„¶å¤§ç‰©ï¼Œæˆ‘è§‰å¾—è¿™å¾ˆä¸ make senseã€‚</p>

<p>æˆ‘æœäº†æœ sccache non-cacheable çš„åŸå› ï¼Œå‘ç° incremental compilation æ˜¯ä¸ªå¾ˆå¤§çš„ caveatï¼Œç«‹é©¬å°è¯•äº†ä¸€ä¸‹ï¼Œç„¶åæˆ‘å†æ¬¡éœ‡æƒŠäº†ï¼Œæ•ˆæœ <em>stupidly</em> å¥½ï¼š</p>

<p><img src="/assets/img/comptime/timings-2.png" alt="timings-2" /></p>

<p>è¿™è®© simulation build çš„æ—¶é—´ç¬é—´ä¸‹é™äº† 4 åˆ†é’Ÿâ€¦â€¦</p>

<p>å®é™…ä¸Šæˆ‘ä»¬çš„ debug build æ˜¯å¾ˆæ—©ä¹‹å‰å°±å…³æ‰äº† incremental compilationï¼š</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[profile.ci-dev]</span>
<span class="py">incremental</span> <span class="p">=</span> <span class="kc">false</span>
</code></pre></div></div>

<p>ä½†æ˜¯åæ¥åŠ ä¸Šæ–°çš„ build profile çš„æ—¶å€™æ²¡æœ‰è€ƒè™‘åˆ°è¿™ä¸ªé—®é¢˜ã€‚ä»”ç»†æƒ³ä¸€æƒ³ï¼Œincremental compilation è™½å¥½ï¼Œä½†å®ƒåœ¨ CI é‡Œä¸å¤ª make sense å•Šï¼</p>

<blockquote>
  <p>CI builds often are closer to from-scratch builds, as changes are typically much bigger than from a local edit-compile cycle. For from-scratch builds, incremental adds an extra dependency-tracking overhead. It also significantly increases the amount of IO and the size of <code class="language-plaintext highlighter-rouge">./target</code>, which make caching less effective.</p>
</blockquote>

<p>äºæ˜¯æˆ‘å¹²è„†åœ¨ CI é‡ŒåŠ äº†ä¸ªå…¨å±€çš„ env var æ¥æŠŠå®ƒå…³æ‰ï¼Œä¸€åŠ³æ°¸é€¸ã€‚</p>

<h2 id="step-4-single-binary-integration-test">Step 4: Single binary integration test</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7842">build: single-binary integration test #7842</a></p>

<p>åˆæ˜¯ä¸€ä¸ª <em>stupidly effective</em> çš„ä¼˜åŒ–ã€‚tl;dr:</p>

<p>Donâ€™t do this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tests/
  foo.rs
  bar.rs
</code></pre></div></div>

<p>Do this instead:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tests/
  integration/
    main.rs
    foo.rs
    bar.rs
</code></pre></div></div>

<p>å› ä¸º <code class="language-plaintext highlighter-rouge">tests/</code> ä¸‹é¢çš„æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šç¼–è¯‘æˆä¸€ä¸ªå•ç‹¬çš„ binaryï¼ˆæ„å‘³ç€ä¼šæ¯ä¸ªéƒ½ link ä¸€ä¸‹ä¾èµ–ï¼‰ã€‚é™¤äº†ç¼–è¯‘æ…¢ï¼Œè¿™ç”šè‡³è¿˜å¯èƒ½å¯¼è‡´æµ‹è¯•è·‘çš„æ…¢ï¼ˆ<code class="language-plaintext highlighter-rouge">cargo test</code> çš„ç¼ºé™·ï¼‰ã€‚</p>

<p>è¿™ä¸ªä¼˜åŒ–æ²¡æœ‰å‡å°‘æˆ‘ä»¬çš„æµ‹è¯•æ—¶é—´ï¼ˆå¯èƒ½æ˜¯å› ä¸º <code class="language-plaintext highlighter-rouge">cargo nextest</code> çš„ä¼˜è¶Šæ€§ï¼‰ï¼Œä½†å®ƒä¸€ä¸‹å­åˆå‡å°‘äº†å¿« 2 åˆ†é’Ÿçš„ç¼–è¯‘æ—¶é—´â€¦â€¦å¦å¤–è¯´æ¥æœ‰ç‚¹å¯ç¬‘çš„æ˜¯ï¼Œå®ƒè¿˜å‡å°‘äº† 2 åˆ†é’Ÿçš„ artifacts ä¸Šä¼ ä¸‹è½½ã€å‹ç¼©è§£å‹çš„æ—¶é—´â€¦â€¦ï¼ˆè™½ç„¶åè€…åœ¨ç“¶é¢ˆä¸Šå¹¶æ²¡æœ‰å½±å“ï¼‰</p>

<h2 id="å…¶ä»–ä¸€äº›å…ˆå‰å°±å­˜åœ¨çš„ä¼˜åŒ–">å…¶ä»–ä¸€äº›å…ˆå‰å°±å­˜åœ¨çš„ä¼˜åŒ–</h2>

<p>ä»¥ä¸Šå°±æ˜¯æˆ‘è¿™æ¬¡ä¼˜åŒ–çš„ä¸»è¦è¿‡ç¨‹äº†ï¼Œè¿™ä¸‹ç»ˆäºå¯ä»¥å¿ƒæ»¡æ„è¶³åœ°æ”¶å·¥äº†ã€‚æœ€åæƒ³å†æ€»ç»“ä¸€äº›å‰äººçš„åŠªåŠ›ï¼Œä»¥ä¾›å‚è€ƒã€‚</p>

<ul>
  <li>ä½¿ç”¨ <a href="https://github.com/nextest-rs/nextest"><code class="language-plaintext highlighter-rouge">cargo nextest</code></a> æ›¿ä»£ <code class="language-plaintext highlighter-rouge">cargo test</code>ã€‚</li>
  <li>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">workspace-hack</code> æŠ€æœ¯ï¼šè§ <a href="https://docs.rs/cargo-hakari/latest/cargo_hakari/about/index.html"><code class="language-plaintext highlighter-rouge">cargo hakari</code></a>ã€‚</li>
  <li>ç»™ cargo registry åŠ  cacheï¼Œæˆ–è€…ä½¿ç”¨åˆšåˆš stablize çš„ sparse indexï¼Œå¯å‚è€ƒ <a href="https://github.com/dcjanus">DCjanus</a> çš„è¿™ç¯‡ <a href="https://blog.dcjanus.com/posts/cargo-registry-index-in-http/">blog</a>ã€‚</li>
  <li>æŠŠå·¨å¤§çš„ crate æ‹†åˆ†æˆå¤šä¸ªå° createã€‚</li>
  <li>link time çš„ä¼˜åŒ–ï¼šlink å¾ˆèŠ±æ—¶é—´ï¼Œè€Œä¸”æ˜¯å•çº¿ç¨‹çš„ï¼Œå¾ˆå¯èƒ½æˆä¸ºç“¶é¢ˆ
    <ul>
      <li>ä½¿ç”¨æ›´å¿«çš„ linkerï¼š<code class="language-plaintext highlighter-rouge">mold</code> for Linux, <code class="language-plaintext highlighter-rouge">zld</code> for macOS. <code class="language-plaintext highlighter-rouge">lld</code> is the most mature option for production use.</li>
      <li>åœ¨ debug build ä¸Šå…³æ‰ Link Time Optimization (LTO)ã€‚</li>
    </ul>
  </li>
  <li>Trade-off between compile time and performanceï¼šCI çš„æ€»æ—¶é—´æ˜¯ç¼–è¯‘+æµ‹è¯•ï¼Œé‚£ä¹ˆç¼–è¯‘ä¼˜åŒ–ï¼ˆåŒ…æ‹¬ä¸Šé¢çš„ LTOï¼‰å¼€ä¸å¼€ï¼Œå¼€å¤šå°‘å®é™…ä¸Šå°±æ˜¯åœ¨å‰åè€…ä¹‹é—´ trade-offï¼Œå¯ä»¥è°ƒæ•´æµ‹è¯•æ¥è¾¾åˆ°ä¸€ä¸ªæ•´ä½“æœ€ä¼˜çš„é€‰æ‹©ã€‚ä¾‹å¦‚ bugen gg åœ¨æˆ‘ä»¬çš„ build profile ä¸Šçš„éªšæ“ä½œï¼š</li>
</ul>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># The profile used for CI in pull requests.</span>
<span class="c"># External dependencies are built with optimization enabled, while crates in this workspace are built</span>
<span class="c"># with `dev` profile and full debug info. This is a trade-off between build time and e2e test time.</span>
<span class="nn">[profile.ci-dev]</span>
<span class="py">inherits</span> <span class="p">=</span> <span class="s">"dev"</span>
<span class="py">incremental</span> <span class="p">=</span> <span class="kc">false</span>
<span class="nn">[profile.ci-dev.package."*"]</span> <span class="c"># external dependencies</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">1</span>
<span class="nn">[profile.ci-dev.package."tokio"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nn">[profile.ci-dev.package."async_stack_trace"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nn">[profile.ci-dev.package."indextree"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nn">[profile.ci-dev.package."task_stats_alloc"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>

<span class="c"># The profile used for deterministic simulation tests in CI.</span>
<span class="c"># The simulator can only run single-threaded, so optimization is required to make the running time</span>
<span class="c"># reasonable. The optimization level is customized to speed up the build.</span>
<span class="nn">[profile.ci-sim]</span>
<span class="py">inherits</span> <span class="p">=</span> <span class="s">"dev"</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">2</span>
<span class="py">incremental</span> <span class="p">=</span> <span class="kc">false</span>
</code></pre></div></div>

<p>é™¤æ­¤ä»¥å¤–çš„æ›´å¤šä¼˜åŒ–ä¹Ÿæœ‰å¾ˆå¤šäººéƒ½æ€»ç»“è¿‡ï¼Œæˆ‘å°±ä¸å¤šè¯´ï¼ˆä¸æ‡‚ï¼‰äº†ï¼Œä¾‹å¦‚è¿™ç¯‡ blogï¼š<a href="https://endler.dev/2020/rust-compile-times/">Tips for Faster Rust Compile Times</a></p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>CIã€å¼€å‘è€…ä½“éªŒè¿™ç§ä¸œè¥¿å¾ˆå®¹æ˜“å°±ä¼šåœ¨æ— äººç…§æ–™çš„æƒ…å†µä¸‹å˜å¾—æ‚è‰ä¸›ç”Ÿï¼Œä½†å¦‚æœå®šæœŸæ‰“ç†ä¸€ä¸‹ï¼Œå¯èƒ½ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„æ”¶è·ï¼Œä¸€ç‚¹ç‚¹å¾®å°çš„åŠªåŠ›å°±å¸¦æ¥å·¨å¤§çš„æå‡ã€‚</p>

<p>æœ€åå†æ‘˜ä¸¤æ®µ matklad <a href="https://matklad.github.io/2021/09/04/fast-rust-builds.html">blog</a> é‡Œçš„è¯ä½œç»“ï¼š</p>

<blockquote>
  <p>Compilation time is a <em>multiplier</em> for basically everything. Whether you want to ship more features, to make code faster, to adapt to a change of requirements, or to attract new contributors, build time is a factor in that.</p>

  <p>It also is a non-linear factor. Just waiting for the compiler is the smaller problem. The big one is losing the state of the flow or (worse) mental context switch to do something else while the code is compiling. One minute of work for the compiler wastes more than one minute of work for the human.</p>
</blockquote>]]></content><author><name>xxchan</name></author><category term="CS" /><summary type="html"><![CDATA[Stupidly effective ways to optimize Rust compile time]]></summary></entry><entry><title type="html">Profiling 101</title><link href="https://xxchan.me/cs/2023/02/08/profiling-101.html" rel="alternate" type="text/html" title="Profiling 101" /><published>2023-02-08T00:00:00+00:00</published><updated>2023-02-08T00:00:00+00:00</updated><id>https://xxchan.me/cs/2023/02/08/profiling-101</id><content type="html" xml:base="https://xxchan.me/cs/2023/02/08/profiling-101.html"><![CDATA[<p>ä»¥å‰ä¹Ÿæµ…å°è¾„æ­¢åœ°è¯•å›¾ profile è¿‡ï¼Œä½†æ˜¯è¢«ä¸€å¤§å †æ¦‚å¿µå’Œå·¥å…·æçš„å¤´æ˜è„‘æ¶¨ï¼Œå…¨æ˜¯é—®é¢˜ï¼š</p>
<ul>
  <li>ä»€ä¹ˆæ˜¯ profilingï¼Œè¿™ä¸ªè¯ä»€ä¹ˆæ„æ€ï¼Ÿ</li>
  <li>CPU profiling å’Œ memory profiling æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆéƒ½æ˜¯ç«ç„°å›¾ï¼Ÿ</li>
  <li>Instrument åˆæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</li>
  <li>Golang çš„ pprof package å’Œ pprof tool æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li>
  <li>Mac çš„ XCode Instruments å¯ä»¥æ¯”è¾ƒå‚»ç“œå¼åœ° profileï¼Œä½†æ˜¯æ²¡æœ‰ flamegraphï¼Œæ€ä¹ˆåŠï¼Ÿ</li>
</ul>

<p>ç„¶åå¹³æ—¶è¦ä¹ˆæ²¡æœ‰éœ€æ±‚ç”¨ä¸åˆ° profilingï¼Œè¦ä¹ˆé‡åˆ°é—®é¢˜å¾ˆæ€¥ï¼Œå°±ç—…æ€¥ä¹±æŠ•åŒ»ï¼Œå„ç§å·¥å…·çè¯•ä¸€é€šï¼Œæœ€åä¸äº†äº†ä¹‹ï¼Œä¹Ÿæ²¡ææ‡‚åœ¨å¹²ä»€ä¹ˆã€‚</p>

<p>è¿™ä¸¤å¤©åœ¨å°è¯•ç”¨ profiling å·¥å…·æŸ¥å†…å­˜é—®é¢˜ï¼Œè™½ç„¶æœ€åé—®é¢˜æ²¡è®©æˆ‘çœ‹å‡ºæ¥ï¼Œä½†æ˜¯è¿™å›ç»ˆäºåŸºæœ¬ææ‡‚ä»–ä»¬åˆ°åº•æ˜¯åœ¨å¹²ä»€ä¹ˆäº†ï¼Œè¶çƒ­æ‰“é“æ°´ä¸€ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ã€‚</p>

<p>æœ¬æ–‡ä¸åŒ…æ‹¬ï¼šå¦‚ä½•æ ¹æ® profiling çš„ç»“æœæ¥è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼ˆè¿™æ˜¯æœ€ç»ˆç›®æ ‡ï¼Œéœ€è¦å¤§é‡ç»éªŒï¼‰ï¼Œprofiling çš„å„ç§å…·ä½“å®ç°æŠ€æœ¯ã€‚</p>

<p>æœ¬æ–‡ä¸»è¦ç§‘æ™®åŸºæœ¬æ¦‚å¿µï¼Œç†è§£ profiling åœ¨å¹²ä»€ä¹ˆï¼Œè¿™ç®—æ˜¯ä¸€åˆ‡åç»­å·¥ä½œçš„å‰æã€‚å› æ­¤æœ¬æ–‡ç›®æ ‡è¯»è€…æ˜¯åƒæˆ‘ä¸€æ ·å¯èƒ½å¬è¯´è¿‡ä¸€äº›ï¼Œä½†æ˜¯æ²¡æ€ä¹ˆä¸Šæ‰‹æè¿‡ profilingï¼Œå¯¹åŸºæœ¬æ¦‚å¿µä¹Ÿä¸å¤ªç†è§£çš„æœ‹å‹ã€‚</p>

<h2 id="tl-dr">TL; DR</h2>

<p>Profiling å…¶å®åŒ…æ‹¬<em>åˆ†å¼€</em>çš„ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ol>
  <li>æ”¶é›†ç¨‹åºè¿è¡Œçš„ä¿¡æ¯</li>
  <li>åˆ†æ/å±•ç¤ºä¿¡æ¯</li>
</ol>

<p>Flamegraph åªæ˜¯ä¸€ç§æ•°æ®å¯è§†åŒ–æ–¹æ³•ï¼Œå±äº profiling çš„ç¬¬äºŒæ­¥ã€‚å®ƒä¸åŒ…æ‹¬ç¬¬ä¸€æ­¥æ”¶é›†ä¿¡æ¯ï¼Œprofiling ä¹Ÿå¯ä»¥ä¸ç”¨å®ƒæ¥å±•ç¤ºä¿¡æ¯ã€‚</p>

<h2 id="ä»€ä¹ˆæ˜¯-flamegraph">ä»€ä¹ˆæ˜¯ flamegraph</h2>

<p>å°±ç®—ä¸å¤ªæ‡‚ profiling åŸç†æˆ–è€…å®è·µï¼Œçœ‹åˆ°è¿™æ ·çš„ç«ç„°å›¾ä¹Ÿä¼šè§‰å¾—éå¸¸ç›´è§‚ï¼ŒåŸºæœ¬ä¸Šèƒ½çŒœä¸ªå¤§æ¦‚æ˜¯ä»€ä¹ˆæ„æ€ã€‚</p>

<p><img src="https://camo.githubusercontent.com/eecfbf00e6cc5baf6ae2b66283573d765f8fe29f1d3df10f4ce3423d942c0af3/687474703a2f2f7777772e6272656e64616e67726567672e636f6d2f466c616d654772617068732f6370752d626173682d666c616d6567726170682e737667" alt="Example" /></p>

<p>è¿™ä¸€å®šç¨‹åº¦ä¸Šå¯¼è‡´å¯¹é—¨å¤–æ±‰æ¥è¯´æåˆ° profiling å’Œ flamegraph å°±è§‰å¾—æ˜¯ç»‘å®šåœ¨ä¸€èµ·çš„ä¸¤ä¸ªæ¦‚å¿µï¼Œä½†å®é™…ä¸Šä¸æ˜¯ã€‚</p>

<p>å…¶å®å®ƒåªæ˜¯ä¸€ç§å¯è§†åŒ–å·¥å…·ï¼Œåªè´Ÿè´£å±•ç¤ºä¿¡æ¯ã€‚å®ƒçš„ input å¯ä»¥æ˜¯ä»»ä½•é•¿å¾—åƒ <strong>stacktrace</strong> çš„ä¸œè¥¿ã€‚å®ƒçš„ä¸»è¦ä¼˜ç‚¹ä¹Ÿæ­£æ˜¯å¯ä»¥æ˜äº†åœ°çœ‹å‡º stacktrace å’Œå æ¯”ã€‚</p>

<p><strong><a href="https://github.com/brendangregg/FlameGraph">brendangregg/FlameGraph</a></strong> è¿™ä¸ª repo ä½œè€… Brendan Gregg æ˜¯ flamegraph çš„å‘æ˜è€…ã€‚è¿™ä¸ª repo é‡ŒåŒ…å«äº†ä¸€ç³»åˆ—ï¼ˆperl å†™çš„ï¼‰flamegraph å·¥å…·ã€‚é‡Œé¢åŒ…æ‹¬ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">flamegraph.pl</code> æ˜¯æœ€é‡è¦çš„ç”¨æ¥ç”Ÿæˆ flamegraph SVG å›¾ç‰‡çš„å·¥å…·</li>
  <li><code class="language-plaintext highlighter-rouge">stackcollapse-*.pl</code> ç³»åˆ—å¯ä»¥æŠŠå„ç§æ ¼å¼çš„ stacktrace è½¬æ¢æˆ <code class="language-plaintext highlighter-rouge">flamegraph.pl</code> çš„ input æ ¼å¼</li>
</ul>

<p>æ‰€ä»¥å®é™…ä¸Šæˆ‘æ‰‹å†™ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">flamegraph.pl</code> çš„è¾“å…¥æ ¼å¼çš„ä¸œè¥¿ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ª flamegraphã€‚ä¾‹å¦‚è¿™æ ·ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a 1
a;b 0
a;b;c 1
a;b;c;e 1.5
a;b;d 2
</code></pre></div></div>

<p><img src="/assets/img/flamegraph.svg" alt="flamegraph.svg" /></p>

<p>ä¸Šé¢è¿™ä¸ªä¾‹å­åº”è¯¥å¾ˆå¥½åœ°è§£é‡Šäº† flamegraph çš„åŸç†ã€‚æ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªå‡½æ•°çš„å®Œæ•´çš„è°ƒç”¨æ ˆï¼Œæœ€åä¸€ä¸ªæ•°å­—æ˜¯å®ƒ<em>è‡ªå·±</em>çš„ï¼ˆæ—¶é—´/å†…å­˜/â€¦ï¼‰å ç”¨æ•°é‡ã€‚</p>

<h3 id="æŠŠ-stacktrace-è½¬æ¢æˆ-flamegraph">æŠŠ stacktrace è½¬æ¢æˆ flamegraph</h3>

<p>ç°åœ¨å¾ˆå¤š profiling å·¥å…·åº”è¯¥éƒ½å¯ä»¥ç›´æ¥ç”Ÿæˆ flamegraphï¼Œå¦‚æœä¸è¡Œçš„è¯ï¼Œå¯ä»¥è‡ªå·±æƒ³åŠæ³•å¼„ä¸ªè„šæœ¬è½¬æ¢ä¸€ä¸‹ã€‚ä¾‹å¦‚ XCode Instruments å…¶å®å¯ä»¥å¯¼å‡ºï¼ˆå®ƒé‡Œé¢å« Deep Copyâ€¦ å¹¶ä¸”è¿˜éœ€è¦å…ˆé€‰ä¸­æ‰å¥½å¯¼ï¼‰è¿™æ ·çš„ stacktrace æ–‡æœ¬ï¼ˆå†…å­˜ï¼ŒCPU ä»€ä¹ˆçš„éƒ½å¯ä»¥å¯¼ï¼‰ ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Allocation
Bytes Used	Count		Symbol Name
   9.75 KB     100.0%	56	 	_pthread_start
   9.75 KB     100.0%	56	 	 std::sys::unix::thread::Thread::new::thread_start::h8134a9cc26f143c2
...

# Time Profiler
Weight	Self Weight		Symbol Name
74.00 ms  100.0%	0 s	 	thread_start
74.00 ms  100.0%	0 s	 	 _pthread_start
74.00 ms  100.0%	0 s	 	  std::sys::unix::thread::Thread::new::thread_start::h8134a9cc26f143c2
...

# CPU Profiler
Weight	Self Weight		Symbol Name
34.35 Mc  100.0%	-	 	thread_start
34.35 Mc  100.0%	-	 	 _pthread_start
34.35 Mc  100.0%	-	 	  std::sys::unix::thread::Thread::new::thread_start::h8134a9cc26f143c2
...
</code></pre></div></div>

<p>æˆ‘æƒ³è¦æŠŠ Allocationï¼ˆå†…å­˜ profileï¼‰çš„ç»“æœå¼„æˆ flamegraphï¼Œå‘ç°æ²¡æœ‰ç°æˆçš„å·¥å…·ã€‚ä¸Šé¢çš„å·¥å…·åŒ…é‡Œæœ‰ä¸€ä¸ª <a href="https://github.com/brendangregg/FlameGraph/blob/master/stackcollapse-instruments.pl"> <code class="language-plaintext highlighter-rouge">stackcollapse-instruments.pl</code> </a>ï¼Œå®é™…ä¸Šå¤„ç†çš„æ˜¯ Time Profiler çš„æ ¼å¼ï¼š</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;&gt;</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">chomp</span><span class="p">;</span>
	<span class="sr">/\d+\.\d+ (?:min|s|ms)\s+\d+\.\d+%\s+(\d+(?:\.\d+)?) (min|s|ms)\t \t(\s*)(.+)/</span> <span class="ow">or</span> <span class="nb">die</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$func</span> <span class="o">=</span> <span class="err">$</span><span class="mi">4</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$depth</span> <span class="o">=</span> <span class="nb">length</span> <span class="p">(</span><span class="err">$</span><span class="mi">3</span><span class="p">);</span>
	<span class="nv">$stack</span> <span class="p">[</span><span class="nv">$depth</span><span class="p">]</span> <span class="o">=</span> <span class="err">$</span><span class="mi">4</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$i</span> <span class="p">(</span><span class="mi">0</span> <span class="o">..</span> <span class="nv">$depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="nv">$stack</span> <span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
		<span class="k">print</span> <span class="p">"</span><span class="s2">;</span><span class="p">";</span>
	<span class="p">}</span>

	<span class="k">my</span> <span class="nv">$time</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="err">$</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="mi">2</span> <span class="ow">eq</span> <span class="p">"</span><span class="s2">min</span><span class="p">")</span> <span class="p">{</span>
		<span class="nv">$time</span> <span class="o">*=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="err">$</span><span class="mi">2</span> <span class="ow">eq</span> <span class="p">"</span><span class="s2">s</span><span class="p">")</span> <span class="p">{</span>
		<span class="nv">$time</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nb">printf</span><span class="p">("</span><span class="s2">%s %.0f</span><span class="se">\n</span><span class="p">",</span> <span class="nv">$func</span><span class="p">,</span> <span class="nv">$time</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ª perl ä»£ç å’Œæ­£åˆ™è¡¨è¾¾å¼è™½ç„¶éƒ½çœ‹ä¸æ‡‚ï¼Œä½†æ˜¯å¯ä»¥ç›®æµ‹æ„Ÿå—ä¸€ä¸‹å°±æ˜¯å…ˆåšä¸ªåŒ¹é…ï¼Œç„¶åæ ¹æ®ç©ºæ ¼ç¼©è¿›çš„æ•°é‡å¤„ç† stackï¼Œæœ€åå†æŠŠæ—¶é—´å•ä½è½¬æ¢ä¸€ä¸‹å°±è¡Œäº†ã€‚</p>

<p>ç¥­å‡º <a href="https://regex101.com/"> <code class="language-plaintext highlighter-rouge">regex101</code> </a>ï¼ˆå…¶å®æˆ‘ä¹Ÿç¬¬ä¸€æ¬¡ç”¨ï¼‰é‰´å®šä¸€ä¸‹æ­£åˆ™è¡¨è¾¾å¼ï¼š</p>

<p><img src="/assets/img/regex.png" alt="regex.png" /></p>

<p>å†å›å¤´ç»“åˆä»£ç ä¸­ <code class="language-plaintext highlighter-rouge">$2, $3, $4</code> çš„ç”¨æ³•ï¼Œå¯ä»¥éå¸¸ç¡®ä¿¡æ¯ä¸ªå˜é‡çš„å«ä¹‰ã€‚</p>

<p>ç„¶åæƒ³è¦è½¬ Allocation çš„æ ¼å¼çš„è¯ï¼Œä¾è‘«èŠ¦ç”»ç“¢å°æ”¹ä¸€ä¸‹æ­£åˆ™è¡¨è¾¾å¼å’Œå•ä½å°±è¡Œäº†ï¼ˆå¯ä»¥ç»“åˆ regex101 çš„ debug åŠŸèƒ½ï¼Œçœ‹æ­£åˆ™åŒ¹é…åˆ°å“ªå„¿æŒ‚äº†ï¼Œç›¸å½“å¥½ç”¨ï¼‰ã€‚æ³¨æ„ Allocation çš„ä¿¡æ¯é‡Œé»˜è®¤ä¸åŒ…æ‹¬ <em>Self Bytes</em>ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰“å¼€ä¸€ä¸‹ã€‚</p>

<h2 id="ä»€ä¹ˆæ˜¯-profiling">ä»€ä¹ˆæ˜¯ profiling</h2>

<h3 id="profiling-è¿™ä¸ªè¯çš„å«ä¹‰">profiling è¿™ä¸ªè¯çš„å«ä¹‰</h3>

<p>ç¿»äº†ç¿»è¯å…¸å’Œ wiki çš„è§£é‡Šï¼š</p>

<blockquote>
  <p>the recording and analysis of a person's psychological and behavioral characteristics, so as to assess or predict their capabilities in a certain sphere or to assist in identifying a particular subgroup of people</p>
</blockquote>

<blockquote>
  <p><strong>Profiling</strong>, the extrapolation of information about something, based on known qualities</p>
</blockquote>

<p>æ„Ÿè§‰æ˜¯ä¸ªéå¸¸ general çš„è¯ï¼Œä½†æ„Ÿè§‰å·®ä¸å¤šå°±æ˜¯é€šè¿‡æ”¶é›†ä¿¡æ¯ï¼ˆè§‚æµ‹ï¼‰æ¥åˆ†ææ¨æ–­çš„æ„æ€ã€‚å¸¸è§å…¶ä»–ç”¨æ³•åŒ…æ‹¬å¿ƒç†å­¦ä¸­çš„ç½ªçŠ¯å¿ƒç†ç”»åƒä¾§å†™ï¼Œéƒ½å·®ä¸å¤šæ˜¯ä¸€å›äº‹ã€‚</p>

<p>ä»ç¬¬ä¸€ä¸ªè§£é‡Šä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œprofiling å…¶å®æœ‰ä¸¤ä¸ªæ­¥éª¤ï¼šæ”¶é›†ä¿¡æ¯å’Œåˆ†æä¿¡æ¯ã€‚ä¾‹å¦‚ golang è‡ªå¸¦çš„ <a href="https://pkg.go.dev/runtime/pprof">pprof åŒ…</a>æä¾›äº†å¤šç§æ–¹å¼å¯ç”¨ profilingï¼šgo testã€HTTP æœåŠ¡ã€æ‰‹åŠ¨åœ¨ç¨‹åºé‡Œå¯ç”¨ï¼Œå…¶å®åšçš„äº‹æƒ…éƒ½æ˜¯æ”¶é›†ä¿¡æ¯ã€‚ä»¥å‰æˆ‘è¿˜æä¸æ¸…æ¥šå®ƒå’Œ pprof tool çš„å…³ç³»ï¼Œå®é™…ä¸Šåè€…æ˜¯ä¸ªåˆ†æã€å¯è§†åŒ–å·¥å…·ï¼Œå‰è€…æ”¶é›†ä¿¡æ¯ï¼Œæ”¶é›†æˆåè€…å®šä¹‰çš„è¾“å…¥æ ¼å¼ã€‚</p>

<h3 id="æ”¶é›†ä¿¡æ¯">æ”¶é›†ä¿¡æ¯</h3>

<p>ä¸»è¦æœ‰ä¸¤ç§æ”¶é›†ä¿¡æ¯çš„æ–¹å¼ï¼š</p>
<ul>
  <li>Statistical samplingï¼šprobes the target program's call stack at regular intervals using operating system interrupts.</li>
  <li>Code instrumentationï¼šeither inject code into a binary file that captures timing information or by using callback hooks.</li>
</ul>

<p>åè€…æ¯”å‰è€…æ›´ç²¾ç¡®ï¼Œä½†æ˜¯ overhead ä¹Ÿæ›´å¤§ã€‚å‰é¢æåˆ°çš„ Mac ä¸Šçš„ XCode Instrumentsï¼Œæƒ³å¿…å°±æ˜¯ä»¥åé¢è¿™ç§æ–¹å¼æ¥æ”¶é›†ä¿¡æ¯çš„ã€‚</p>

<h4 id="instrumenation-è¿™ä¸ªè¯çš„å«ä¹‰">instrumenation è¿™ä¸ªè¯çš„å«ä¹‰</h4>

<blockquote>
  <p><strong>Instrumentation</strong>Â a collective term forÂ measuring instrumentsÂ that are used for indicating, measuring and recording physical quantities. The term has its origins in the art and science ofÂ scientific instrument-making.</p>
</blockquote>

<p>Scientific instruments å®é™…ä¸ŠæŒ‡ç§‘å­¦ä»ªå™¨ï¼Œthat are used for <strong>indicating, measuring and recording</strong> physical quantitiesã€‚Instrumentation å¯ä»¥æŒ‡<em>ä½¿ç”¨</em>ç§‘å­¦ä»ªå™¨ã€‚</p>

<p>é‚£ä¹ˆåœ¨è½¯ä»¶çš„è¯­å¢ƒä¸‹ï¼Œ instrumentation å°±æŒ‡å¾€ä»£ç ä¸­åŠ å…¥ä¸€äº›â€œä»ªå™¨â€ï¼Œä»è€Œå¯ä»¥<em>è§‚æµ‹</em>åˆ°è½¯ä»¶çš„è¡Œä¸ºã€‚å®ƒçš„ä¸­æ–‡å¥½åƒå«â€œæ’æ¡©â€ï¼Œä¹ŸæŒºå½¢è±¡ï¼Œå°±æ˜¯æ„Ÿè§‰ä¸å¤ªç¬¦åˆåŸæ„ã€‚</p>

<p>æ’å…¥è½¯ä»¶é‡Œçš„ä¸œè¥¿å¯èƒ½åŒ…æ‹¬ï¼š</p>
<ul>
  <li>Collect profiling statisticsï¼šprofiling å®é™…ä¸Šå°±æ˜¯ measuring dynamic program behaviorsï¼Œéå¸¸åƒåšç§‘å­¦å®éªŒ</li>
  <li>Run-time checkingï¼šåƒ AddressSanitizer è¿™ç§ä¹Ÿè¢«ç®—ä½œæ˜¯ instrumentationï¼Œæ„Ÿè§‰ç¨å¾®æœ‰ç‚¹è¯ä¹‰æ‰©å¤§çš„æ„Ÿè§‰</li>
</ul>

<p>ä¸è¿‡è¿™ä¹ˆè¯´æ¥ï¼Œæˆ‘æ„Ÿè§‰ sampling åœ¨æ›´å¹¿ä¹‰çš„è§’åº¦çœ‹ä¹Ÿå¯ä»¥ç®—æ˜¯ä¸€ç§â€œinstrumentationâ€â€¦â€¦</p>

<h3 id="åˆ†æå±•ç¤ºä¿¡æ¯">åˆ†æ/å±•ç¤ºä¿¡æ¯</h3>

<p>åˆ†æé™¤äº† flamegraphï¼Œå…¶ä»–è¿˜æœ‰åƒä¸‹é¢è¿™æ ·çš„ graphviz å›¾ç­‰ç­‰ã€‚</p>

<p><img src="https://go.dev/blog/pprof/havlak1a-75.png" alt="" /></p>

<p>ä¹Ÿå¯ä»¥ä¸å¯è§†åŒ–ï¼Œå°±çœ‹ä¸€çœ‹ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚ TopNã€‚</p>

<p>ä¸åŒçš„æ”¶é›†å·¥å…·æ¥å—ä¸åŒçš„ input æ ¼å¼ï¼Œç›¸åº”åœ°åšçš„äº‹æƒ…ä¹Ÿä¼šä¸ä¸€æ ·ï¼Œä¾‹å¦‚æœ‰çš„åˆ†æå·¥å…·å¯èƒ½è¿˜æœ‰æŠŠ debug symbol è½¬æˆ source code address è¿™ä¸€æ­¥ï¼Œè€Œåƒä¹‹å‰çš„ flamegraph å°±æ˜¯æ¥å—ç°æˆçš„å¤„ç†å¥½çš„ï¼ˆcollapsedï¼‰stacktraceã€‚pprof çš„è¾“å…¥æ ¼å¼æ˜¯ä¸€ä¸ª <a href="https://github.com/google/pprof/blob/main/proto/profile.proto">protobuffer å®šä¹‰</a>ã€‚</p>

<h2 id="cpu-profiling--memory-profiling">CPU profiling &amp; memory profiling</h2>

<blockquote>
  <p>CPU profiling å’Œ memory profiling æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆéƒ½æ˜¯ç«ç„°å›¾ï¼Ÿ</p>
</blockquote>

<p>ç°åœ¨çœ‹è¿™ä¸ªé—®é¢˜å°±å¾ˆç®€å•äº†ï¼Œå®ƒä»¬è¦åšçš„äº‹æƒ…éƒ½æ˜¯æ”¶é›†ä¿¡æ¯ã€åˆ†æä¿¡æ¯è¿™ä¸¤æ­¥ï¼Œåªæ˜¯å…·ä½“æ”¶é›†çš„æ–¹æ³•ä¸ä¸€æ ·è€Œå·²ã€‚ä¾‹å¦‚ jemalloc çš„ heap profile å°±æ˜¯æŠŠ memory dump ä¸€å¨ä¸‹æ¥ï¼Œç„¶åå¯ä»¥ç”¨å®ƒçš„ jeprof å·¥å…·æ¥åˆ†æï¼ŒåŒ…æ‹¬è½¬æˆç«ç„°å›¾çš„æ ¼å¼ã€‚</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>æˆ‘ç»ˆäºç†è§£äº†ä¸€åˆ‡ï¼Œæ‰€ä»¥é‚£ç„¶åè¯¥æ€ä¹ˆçœ‹æ‡‚ç«ç„°å›¾ï¼Œå®šä½è§£å†³æ€§èƒ½é—®é¢˜å‘¢ï¼ŸğŸ˜­</p>]]></content><author><name>xxchan</name></author><category term="CS" /><summary type="html"><![CDATA[A beginner's guide to profiling]]></summary></entry><entry><title type="html">é€’å½’æ”¹å†™æˆè¿­ä»£çš„é€šç”¨æ–¹æ³•</title><link href="https://xxchan.me/cs/2022/02/15/recursion-to-iteration.html" rel="alternate" type="text/html" title="é€’å½’æ”¹å†™æˆè¿­ä»£çš„é€šç”¨æ–¹æ³•" /><published>2022-02-15T00:00:00+00:00</published><updated>2022-02-15T00:00:00+00:00</updated><id>https://xxchan.me/cs/2022/02/15/recursion-to-iteration</id><content type="html" xml:base="https://xxchan.me/cs/2022/02/15/recursion-to-iteration.html"><![CDATA[<blockquote>
  <p>é€’å½’æ˜¯åƒå‘¼å¸ä¸€èˆ¬è‡ªç„¶çš„äº‹æƒ…ã€‚</p>

  <p>â€”â€”ç½—å®¸<a href="https://zhuanlan.zhihu.com/p/84452538">ã€Šè°ˆé€’å½’ï¼ˆä¸€ï¼‰ï¼šé€’å½’çš„äº”ç§å®šå¼ã€‹</a></p>
</blockquote>

<p>å–œæ¬¢åˆ· LeetCode æˆ–è€…åˆšå­¦æ•°æ®ç»“æ„çš„åŒå­¦ä¸€å®šå¾ˆç†Ÿæ‚‰äºŒå‰æ ‘çš„å„ç§éå†ï¼ŒåŒ…æ‹¬é€’å½’å’Œè¿­ä»£å†™æ³•ã€‚æ˜¾ç„¶é€’å½’å†™èµ·æ¥æ›´ç®€æ´è‡ªç„¶ï¼Œè¿­ä»£åˆ™éœ€è¦ä¸€äº› trickï¼Œå°¤å…¶æ˜¯ååºéå†ï¼Œå…¥æ ˆå‡ºæ ˆï¼Œè¿ç»­å¾€å·¦å¾€å³ä»€ä¹ˆçš„ï¼Œåˆšå­¦éš¾å…æœ‰ç‚¹æŒ å¤´ã€‚æ€»æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬è¢«è¿«è¦ç”¨éé€’å½’çš„æ–¹å¼å®ç°ï¼Œæ¯”å¦‚é¢è¯•å®˜å¼ºåŠ›è¦æ±‚ï¼Œæˆ–è€…è¦å®ç°è¿­ä»£å™¨ï¼ˆå¦‚ <a href="https://leetcode-cn.com/problems/binary-search-tree-iterator/">LeetCode 173. äºŒå‰æœç´¢æ ‘è¿­ä»£å™¨ï¼ˆä¸­åºéå†ï¼‰</a>ï¼‰ã€‚è¿™å¯å’‹åŠå‘¢ï¼Ÿ</p>

<p>æœ‰ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•ï¼Œå¯ä»¥éå¸¸å®¹æ˜“åœ°æŠŠä»»æ„çš„é€’å½’ä»£ç é‡å†™æˆè¿­ä»£çš„ä»£ç ï¼Œè¿™å°±å¥½æ¯”åœ¨å‘¼å¸å—é™çš„æƒ…å†µä¸‹ï¼Œè¿˜å¯ä»¥æˆ´ä¸Šæ°§æ°”é¢ç½©ã€‚è¿™ä¸ªæ–¹æ³•å°±æ˜¯ï¼šæ‰‹åŠ¨æ¨¡æ‹Ÿé€’å½’æ‰§è¡Œï¼Œæˆ–è€…è¯´æ‰‹åŠ¨æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æ ˆã€‚</p>

<h2 id="å‡½æ•°è°ƒç”¨æ ˆ">å‡½æ•°è°ƒç”¨æ ˆ</h2>

<p>ä¸ºäº†ç†è§£è¿™ä¸ªæ–¹æ³•ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä¸€ç‚¹è®¡ç®—æœºçš„è¿è¡ŒåŸç†ã€‚å…¶å®å¾ˆå¥½æ‡‚ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ã€‚ç”±äºæœ‰å„ç§æ§åˆ¶è¯­å¥ï¼Œè¿˜æœ‰å‡½æ•°è°ƒç”¨ï¼Œä»£ç çš„æ‰§è¡Œä¸æ˜¯é¡ºåºçš„ï¼Œé‚£ CPU æ€ä¹ˆçŸ¥é“ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯ä»€ä¹ˆï¼Ÿç­”æ¡ˆæ˜¯ç»´æŠ¤äº†ä¸€ä¸ªå¯„å­˜å™¨ PC (program counter)ï¼ŒæŒ‡å‘ä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚å¯¹äºæ§åˆ¶è¯­å¥ï¼Œæˆ‘è·³èµ°äº†å°±æ²¡äº‹äº†ä¸éœ€è¦å›æ¥äº†ï¼Œæ‰€ä»¥åªéœ€è¦ä¿®æ”¹ PCï¼Œä½†æ˜¯å‡½æ•°è°ƒç”¨å®Œäº†è¿˜éœ€è¦å›æ¥ï¼Œè¿™å¯æ€ä¹ˆåŠå‘¢ï¼Ÿç­”æ¡ˆæ˜¯æ¯å½“è¦è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶æˆ‘å°±ä¿å­˜ç°åœºï¼ŒæŠŠ PC å­˜èµ·æ¥å°±è¡Œäº†ã€‚è¿™å°±æ˜¯å‡½æ•°è°ƒç”¨æ ˆçš„ä½œç”¨ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å‡½æ•°è°ƒç”¨æ ˆï¼ˆè¿™ä¸ªå›¾æ˜¯çç”»çš„ï¼Œä»…ç¤ºæ„ï¼‰
-----------------------
(many frames ...)
-----------------------
(last frame, caller)
parameters
pc (æˆ‘æœ€åæ‰§è¡Œåˆ°å“ªå„¿äº†ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸‹ä¸€ä¸ªå‡½æ•°çš„è¿”å›åœ°å€)
-----------------------
(current frame, callee)
parameters
-----------------------
</code></pre></div></div>

<h2 id="æ‰‹åŠ¨æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æ ˆ">æ‰‹åŠ¨æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æ ˆ</h2>

<p>æ¥ä¸‹æ¥å°±è¿›å…¥æ­£é¢˜ã€‚ç›´æ¥ä¸Šä»£ç è¯´æ˜é—®é¢˜ã€‚</p>

<p>ä¸€ä¸ªä¸€èˆ¬çš„é€’å½’å‡½æ•°ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>   <span class="c1"># pc = 0
</span>    <span class="n">foo</span><span class="p">(</span><span class="n">param_1</span><span class="p">)</span>  <span class="c1"># pc = 1
</span>    <span class="n">foo</span><span class="p">(</span><span class="n">param_2</span><span class="p">)</span>  <span class="c1"># pc = 2
</span>    <span class="c1"># ...
</span>    <span class="n">foo</span><span class="p">(</span><span class="n">param_i</span><span class="p">)</span>  <span class="c1"># pc = i
</span>    <span class="n">do_some_thing</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="c1"># ...
</span>    <span class="n">foo</span><span class="p">(</span><span class="n">param_n</span><span class="p">)</span>
</code></pre></div></div>

<p>è½¬åŒ–æˆè¿­ä»£çš„ä»£ç ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StackFrame</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">pc</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span>

<span class="k">def</span> <span class="nf">foo_iter</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># æ¨¡æ‹Ÿ CPU æ‰§è¡Œ
</span>    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯
</span>            <span class="c1"># foo(param_1) # pc = 1
</span>            <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯
</span>            <span class="c1"># foo(param_2) # pc = 2
</span>            <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">param_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># ...
</span>        <span class="k">elif</span> <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
            <span class="c1"># ä¸‹ä¸¤æ¡æŒ‡ä»¤æ˜¯
</span>            <span class="c1"># do_some_thing(param)
</span>            <span class="c1"># foo(param_i+1)
</span>            <span class="n">do_some_thing</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">param_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># ...
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œäº†ï¼Œè¦è¿”å›äº†ï¼Œé”€æ¯å®ƒçš„æ ˆå¸§
</span>            <span class="c1"># ä¹Ÿå¯ä»¥åœ¨ä¸Šé¢çš„æœ€åä¸€ä¸ªåˆ†æ”¯ç›´æ¥å°± pop äº†
</span>            <span class="n">stack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="ä¾‹é¢˜äºŒå‰æœç´¢æ ‘è¿­ä»£å™¨ä¸­åºéå†">ä¾‹é¢˜ï¼šäºŒå‰æœç´¢æ ‘è¿­ä»£å™¨ï¼ˆä¸­åºéå†ï¼‰</h2>

<p>Okï¼Œé‚£æˆ‘ä»¬ä¸Šä¸€é“ä¾‹é¢˜ï¼Œ<a href="https://leetcode-cn.com/problems/binary-search-tree-iterator/">LeetCode 173. äºŒå‰æœç´¢æ ‘è¿­ä»£å™¨ï¼ˆä¸­åºéå†ï¼‰</a>ã€‚</p>

<p>é¦–å…ˆä¸­åºéå†çš„é€’å½’å†™æ³•</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">inorder_traversal</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">root</span><span class="p">.</span><span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">inorder_traversal</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">left</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">val</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">root</span><span class="p">.</span><span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">inorder_traversal</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
</code></pre></div></div>

<p>é‡å†™æˆè¿­ä»£</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">inorder_traversal</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">frame</span><span class="p">.</span><span class="n">param</span>

        <span class="k">if</span> <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">left</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">stack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">right</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div></div>

<p>å†é‡å†™æˆè¿­ä»£å™¨ï¼Œå…¶å®å°±æ˜¯æŠŠä¸Šé¢è¿­ä»£çš„è¿‡ç¨‹ä¸­çš„<strong>çŠ¶æ€</strong>ï¼ˆè¿™é‡Œå°±åªæœ‰ stackï¼‰æ”¾è¿› Iterator ç±»é‡Œé¢å°±è¡Œäº†ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BSTIterator</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">TreeNode</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">root</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">frame</span><span class="p">.</span><span class="n">param</span>

            <span class="k">if</span> <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">left</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">frame</span><span class="p">.</span><span class="n">pc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">right</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">StackFrame</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">frame</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">val</span>

    <span class="k">def</span> <span class="nf">hasNext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
</code></pre></div></div>

<p>å°±æ˜¯è¿™æ ·ï¼ˆåˆæ°´äº†ä¸€ç¯‡ï¼‰ï¼Œå¦‚æœæœ‰ä¸æ‡‚çš„åœ°æ–¹æ¬¢è¿è¯„è®ºæé—®ğŸ¥°</p>]]></content><author><name>xxchan</name></author><category term="CS" /><summary type="html"><![CDATA[é€’å½’æ˜¯åƒå‘¼å¸ä¸€èˆ¬è‡ªç„¶çš„äº‹æƒ…ã€‚ â€”â€”ç½—å®¸ã€Šè°ˆé€’å½’ï¼ˆä¸€ï¼‰ï¼šé€’å½’çš„äº”ç§å®šå¼ã€‹]]></summary></entry><entry><title type="html">ä¸ºå•¥ Paxos è¿™ä¹ˆéš¾ï¼Ÿ</title><link href="https://xxchan.me/cs/2022/02/09/paxos-hard-zh.html" rel="alternate" type="text/html" title="ä¸ºå•¥ Paxos è¿™ä¹ˆéš¾ï¼Ÿ" /><published>2022-02-09T00:00:00+00:00</published><updated>2022-02-09T00:00:00+00:00</updated><id>https://xxchan.me/cs/2022/02/09/paxos-hard-zh</id><content type="html" xml:base="https://xxchan.me/cs/2022/02/09/paxos-hard-zh.html"><![CDATA[<p><a href="https://xxchan.github.io/cs/2022/02/07/paxos-hard.html">English Version</a></p>

<p>æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†<strong>å¿½ç•¥æ€§èƒ½ç­‰å®é™…é—®é¢˜</strong>ï¼Œä¸»è¦èŠç‚¹ general çš„ä¸œè¥¿ï¼Œå¦‚åŸºæœ¬æ¦‚å¿µã€è¡¨è¾¾åŠ›ï¼Œæˆ–è€…è¯´â€œæ€ä¹ˆæŠŠå®ƒå˜ä¸ºå¯èƒ½â€ï¼Œè€Œä¸æ˜¯â€œæ€ä¹ˆæŠŠå®ƒæå¾—å¿«çš„é£èµ·â€ã€‚å¦å¤–ï¼Œæˆ‘ä¼šå°½é‡å†™çš„è®©ä¸äº†è§£åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–å…±è¯†çš„è¯»è€…ä¹Ÿèƒ½çœ‹æ‡‚ã€‚ä¸è¿‡ï¼Œå¦‚æœä½ å·²ç»å¯¹ Raft æˆ– Paxos ä¹‹ç±»çš„å…±è¯†ç®—æ³•æœ‰äº†æ¦‚å¿µï¼Œé‚£å½“ç„¶è¿˜æ˜¯æ›´å¥½ã€‚</p>

<h2 id="æˆ‘å­¦ä¹ å…±è¯†çš„ç»å†">æˆ‘å­¦ä¹ å…±è¯†çš„ç»å†</h2>

<p><a href="https://www.zhihu.com/question/65038346/answer/227674428">è¿™ä¸ªçŸ¥ä¹å›ç­”ï¼šæœ‰æ²¡æœ‰å“ªä¸€åˆ»è®©ä½ æ„Ÿå—åˆ°äº†æ–‡çŒ®ä½œè€…çš„æ¶æ„ï¼Ÿ</a>æ˜¯æˆ‘ç¬¬ä¸€æ¬¡å¬è¯´ Paxos å’Œå…±è¯†ã€‚å½“æ—¶çœ‹äº†æ„Ÿè§‰è´¼é€—ï¼ŒåŒæ—¶ä¹Ÿå°±åœ¨è„‘å­é‡Œç•™ä¸‹äº† â€œPaxos å¾ˆéš¾â€ çš„åˆå°è±¡ã€‚</p>

<p>æ­£å¥½ä¸€å¹´å‰ï¼Œæˆ‘åœ¨å†™ MIT 6.824 çš„ Raft labã€‚è¯» Raft çš„æ—¶å€™æˆ‘æ„Ÿè§‰å®ƒæŒºå¥½æ‡‚çš„ï¼ŒæŠŠä¸œè¥¿æ‹†æˆäº†æ¨¡å—ï¼ŒæŠŠæ¯ä¸ªæ¨¡å—è§£é‡Šå¾—éƒ½å¾ˆæ¸…æ¥šã€‚é‡Œé¢è¿˜æœ‰ä¸€ç«  "What's wrong with Paxos?" ï¼Œæˆ‘è¯»çš„æ—¶å€™åˆæƒ…ä¸è‡ªç¦åœ°ä¹äº†èµ·æ¥ã€‚æ€»ä¹‹ï¼Œè™½ç„¶æˆ‘åœ¨ debug çš„æ—¶å€™è¿˜æ˜¯æœ‰ç‚¹å°å›°éš¾çš„ï¼Œä½†å­¦ Raft çš„è®¤çŸ¥è¿‡ç¨‹ç®—æ˜¯å¾ˆå¹³æ»‘ã€‚</p>

<p>ä¸Šå­¦æœŸï¼Œæˆ‘æœ‰ä¸ªä½œä¸šè¦å®ç° Paxosã€‚æˆ‘ç¢°å·§æ”¶è—è¿‡<a href="https://blog.openacid.com/algo/paxos/">è¿™ä¸ªåšå®¢</a>ï¼Œå°±æ‹¿å‡ºæ¥çœ‹çœ‹ã€‚å®ƒç”¨å¾ˆç®€å•çš„æ–¹å¼è§£é‡Šäº† Paxosï¼Œæˆ‘ä¹Ÿå°±æŒ‰ç…§å®ƒè®²çš„å®ç°äº†ï¼ˆbasicï¼‰Paxosï¼Œæ²¡å†çœ‹è®ºæ–‡æˆ–è€…åˆ«çš„æ–‡ç« ã€‚ä½œä¸šè¿˜è¦æ±‚æˆ‘ä»¬ç”¨ä¸€ä¸ªç‰¹å®šçš„æ–¹æ¡ˆå®ç° multiple decisionsï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ²¡çœ‹ multi-Paxos ä¹‹ç±»çš„ä¸œè¥¿ã€‚</p>

<p>ä¸Šå­¦æœŸæˆ‘è¿˜ä¸Šäº† Concurrent Algorithms å’Œ Distributed Algorithms ä¸¤é—¨è¯¾ã€‚å®ƒä»¬éƒ½æ¯”è¾ƒç†è®ºï¼Œéƒ½è®²äº†å…±è¯†ï¼Œæˆ‘å­¦çš„æ—¶å€™æ„Ÿè§‰å…±è¯†è¿™ä¸œè¥¿æŒºç®€å•çš„ã€‚DA è¯¾ä¸Šçš„å…±è¯†ç®—æ³•å¾ˆåƒ Paxosï¼Œè€Œä¸”ç®€å•åˆ°ä¸€å¼  slide å°±å¤Ÿäº†ã€‚å¦å¤– CA è¯¾ä¸Šçš„ Universal Construction ä»¥åŠ DA è¯¾ä¸Šçš„ Total Order Broadcast ç®—æ³•ï¼Œè¿™ä¸¤ä¸ªä¸œè¥¿å¯ä»¥è¯´è¯æ˜äº†å…±è¯†åŸºæœ¬ä¸Šå¯ä»¥ç”¨æ¥åšä»»ä½•äº‹æƒ…ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªç®—æ³•ä¹Ÿä¸éš¾ç†è§£ã€‚ç„¶åæˆ‘å°±å¼€å§‹æƒ³ï¼Œä¸ºä»€ä¹ˆäººä»¬ä¼šè§‰å¾— Paxos éš¾ç†è§£ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æƒ³å†™è¿™ç¯‡åšå®¢çš„åŸå› ã€‚</p>

<p>æœ€åï¼Œæˆ‘è¯»äº† Paxos çš„ä¸¤ç¯‡è®ºæ–‡ï¼Œç¡®è®¤äº†å®ƒä»¬çœŸçš„éƒ½æŒºå¥½æ‡‚çš„ã€‚ä½† Lamport çš„è¯­è¨€å¤ªæœ‰æ„æ€äº†ã€‚<em>The Part-Time Parliament</em> è®²çš„ç‰¹åˆ«è¯¦ç»†åˆå¾ˆç›´ç™½ï¼Œå°±æ˜¯ä»¿ä½›æŠŠåè¯æœ¯è¯­åšäº†ä¸€ä¸‹ç®€å•çš„æ˜ å°„ã€‚<em>Paxos Made Simple</em> åˆ™æ˜¯ç”¨å¹³å®çš„è¯­è¨€è°ˆç›´è§‰ç†è§£ï¼Œå®ƒå€’æ˜¯æœ‰ç‚¹åƒä¸€ç¯‡åšå®¢ã€‚</p>

<p>è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¿›å…¥æ­£é¢˜å§ã€‚</p>

<h2 id="å„ç§æŠ½è±¡consensus-replicated-log-å’Œ-replicated-state-machine">å„ç§æŠ½è±¡ï¼šConsensus, Replicated Log å’Œ Replicated State Machine</h2>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å…ˆä¸ç®¡å…·ä½“çš„å…±è¯†ç®—æ³•ï¼Œå…ˆæ¥çœ‹çœ‹å®ƒçš„æŠ½è±¡ï¼ˆæˆ–æ¥å£ï¼‰æ˜¯æ€ä¹ˆå›äº‹ã€‚</p>

<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é€šå¸¸æƒ³è¦ <em>share</em> ä¸œè¥¿ã€‚é‚£ä¹ˆ shared objects æˆ–å« shared data structures å°±å¾ˆæœ‰ç”¨ã€‚å®ƒå°±åƒå•æœºæ•°æ®ç»“æ„ä¸€æ ·ï¼ˆåƒ queue, mapï¼‰ï¼Œä½†å¯ä»¥è¢«ä¸åŒçš„æœºå™¨ï¼ˆæˆ–çº¿ç¨‹ï¼‰è®¿é—®ã€‚ä¹Ÿå¯ä»¥è¯´æ˜¯å¤šå°æœºå™¨å…±åŒç»´æŠ¤ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œæ¯å°æœºå™¨å¤åˆ¶äº†å…¨å±€å¯¹è±¡çš„çŠ¶æ€ã€‚</p>

<p>Replicated state machine å¯ä»¥è¯´æ˜¯æœ€å¼ºçš„æŠ½è±¡äº†ï¼Œç®—æ˜¯æ‰€æœ‰ shared data structures çš„æ¨å¹¿ã€‚(æˆ–è€…ä¹Ÿå¯ä»¥è¯´ shared data structures éƒ½å¯ä»¥ç”¨ replicated state machine æ¥å®ç°ï¼‰ã€‚ä½ å¯èƒ½å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œç»´æŠ¤ä¸€ä¸ª replicated log å°±æ˜¯ä¸€ç§å®ç° replicated state machine çš„è‡ªç„¶çš„æ–¹æ³•ã€‚å®Œå…¨æ²¡é”™ã€‚</p>

<p>é¡ºä¾¿ä¸€æï¼Œreplicated log ä¹Ÿå¯ä»¥ç­‰ä»·æˆå¦ä¸€ä¸ªæŠ½è±¡ total order broadcastï¼šæ¯ä¸ªæœºå™¨å¹¿æ’­æ¶ˆæ¯ï¼Œä¿è¯æ‰€æœ‰äººä»¥ç›¸åŒçš„å…¨å±€é¡ºåºæ”¶åˆ°æ¶ˆæ¯ã€‚(å¾ˆåƒï¼Œä¸è¿‡æ— æ‰€è°“ï¼Œä¸æ˜¯å¾ˆé‡è¦ã€‚ï¼‰</p>

<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯å…±è¯†å‘¢ï¼Ÿæœ€åŸå§‹çš„ consensus çš„å®šä¹‰æ¥äº†ã€‚é¦–å…ˆï¼Œå®ƒä¹Ÿå°±æ˜¯ä¸€ä¸ª shared objectsã€‚å®ƒçš„ <em>sequential specification</em>ï¼ˆå¦‚æœå®ƒè¢«ä¸åŒçš„æœºå™¨æŒ‰é¡ºåºè®¿é—®ï¼ˆå¥½æ¯”åŠ äº†é”ï¼‰ï¼Œæ€ä¹ˆå·¥ä½œï¼‰æ˜¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ç»´æŠ¤ä¸€ä¸ªå˜é‡ï¼šprop
åˆå§‹å€¼: âŠ¥ (æœªåˆå§‹åŒ–)

propose(v):
    if prop == âŠ¥:
        prop = v
    return prop
</code></pre></div></div>

<p>æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿæœ‰å‡ ä¸ªæ³¨æ„ç‚¹ï¼š</p>
<ul>
  <li>å®ƒæ˜¯ä¸€æ¬¡æ€§çš„ï¼Œsingle decisionã€‚å®ƒå¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ª write-once variableã€‚</li>
  <li>è¿™é‡Œç”¨äº†åŒæ­¥é£æ ¼çš„æ¥å£ï¼Œç”¨åŸºäºäº‹ä»¶çš„å¼‚æ­¥æ¥å£ä¹Ÿè¡Œã€‚</li>
  <li>é€šå¸¸å‡è®¾æ¯ä¸ªæœºå™¨éƒ½æœ‰ä¸œè¥¿è¦ proposeï¼Œè€Œ propose æ˜¯è·å¾—æœ€ç»ˆçš„ decision å€¼çš„å”¯ä¸€é€”å¾„ã€‚æˆ‘è®¤ä¸ºè¿™ç§çº¦å®šä¿—æˆåªæ˜¯ä¸ºäº†ç®€å•èµ·è§ã€‚ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹æ¥å£ï¼Œæ”¹æˆä¸ç”¨ propose ä¹Ÿèƒ½çŸ¥é“å€¼ï¼Œå°±åƒ Paxos é‡Œåˆ†äº† proposer, acceptor å’Œ learnerï¼Œæœ¬è´¨ä¸Šå…¶å®ä¸€æ ·ï¼Œä¸å¤ªé‡è¦ã€‚</li>
</ul>

<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç­‰ä»·åœ°é€šè¿‡ç»™å‡ºå®ƒçš„æ€§è´¨æ¥æè¿° consensusï¼š</p>
<ul>
  <li>Validity: A decided value is proposed.</li>
  <li>Agreement: No processes decide differently.</li>
  <li>Termination: Every process eventually decides.</li>
</ul>

<h2 id="ç”¨-consensus-å®ç°-replicated-state-machine">ç”¨ Consensus å®ç° Replicated State Machine</h2>

<p>Consensus æ˜¯ä¸€ä¸ªå¦‚æ­¤ç®€å•çš„æŠ½è±¡ï¼Œä½†å®ƒè¶³å¤Ÿå¼ºå¤§ï¼Œå¯ä»¥å®ç° replicated state machineï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¯ä»¥ç”¨æ¥å®ç°ä»»ä½• shared objectã€‚è¿™ä¸ªç»“è®ºæœ‰ä¸€ä¸ªå“äº®çš„åå­—: <strong>Universality of Consensus</strong>ã€‚</p>

<p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸€ä¸ª naÃ¯ve çš„æ–¹æ¡ˆï¼šconsensus å·²ç»ç®—æ˜¯ä¸ªå•æ¡ replicated log entry äº†ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ä¸€ä¸ª consensus list ä½œä¸º replicate log å‘¢ï¼Ÿå½“ä¸€å°æœºå™¨è¦ append entry çš„æ—¶å€™ï¼Œå®ƒå°±ä¸€ç›´å‘å‰ proposeï¼Œç›´åˆ°å®ƒçš„ proposal åœ¨ä¸€ä¸ª consensus instance ä¸­è¢« decideã€‚</p>

<p>è¿™ä¸ªæƒ³æ³•åŸºæœ¬ä¸Šå·®ä¸å¤šå¯è¡Œäº†ï¼Œé™¤äº†ä¸€ä¸ªå…³é”®é—®é¢˜ï¼šå¯èƒ½ä¼šæœ‰äººä¸€ç›´ propose èµ¢ä¸äº†ï¼Œä¹Ÿå°±æ˜¯ä¼š starveã€‚è§£å†³æ–¹æ¡ˆä¹Ÿä¸æ˜¯å¾ˆå¤æ‚ï¼šç°åœ¨ï¼Œæ¯ä¸ªäººä¸ä»… propose è‡ªå·±çš„è¯·æ±‚ï¼Œè€Œä¸”è¿˜<strong>å¸®åŠ©</strong>åˆ«äººã€‚å…·ä½“æ¥è¯´ï¼Œå½“ä¸€ä¸ªæ–°çš„æƒ³è¦ append çš„ entry å‡ºç°æ—¶ï¼Œå…ˆæŠŠå®ƒå¹¿æ’­å‡ºå»ï¼ˆåŒæ—¶æ¯ä¸ªäººä¸€ç›´åœ¨æ”¶é›†åˆ«äººçš„è¯·æ±‚ï¼‰ã€‚ç„¶åï¼Œæ¯æ¬¡ propose <strong>æ‰€æœ‰æ”¶é›†åˆ°çš„ pending entries</strong>ï¼ˆè€Œä¸æ˜¯ä¸€æ¡ entryï¼‰ã€‚è¿™å°±æˆäº†!</p>

<p>å½“ç„¶ï¼Œè¿™ä¸æ˜¯å”¯ä¸€çš„æ–¹æ³•ï¼Œè€Œä¸”æ²¡å•¥ä¼˜åŒ–ï¼Œä¸è¿‡å®Œå…¨ workï¼</p>

<p>å…¶å®åœ¨çœ‹è¿™ä¸ªç®—æ³•ä¹‹å‰ä½ å¯èƒ½å°±è§‰å¾—è¿™ä¸ªäº‹å„¿è‚¯å®šæ˜¯èƒ½åšåˆ°çš„ã€‚æˆ‘å°±æ˜¯å±•ç¤ºäº†æœ‰ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼Œè®©æˆ‘ä»¬ç›¸ä¿¡ç¡®å®å¯ä»¥åšåˆ°ã€‚æˆ‘è§‰å¾—ä» consensus åˆ° replicated log å°±å¥½åƒä»æ‰‹åŠ¨æ¡£åˆ‡æ¢åˆ°è‡ªåŠ¨æ¡£ã€‚</p>

<h2 id="ä¸ºå•¥-paxos-è¿™ä¹ˆéš¾">ä¸ºå•¥ Paxos è¿™ä¹ˆéš¾ï¼Ÿ</h2>

<p>å¦‚æœä½ çŸ¥é“ Paxos çš„å·¥ä½œåŸç†ï¼Œä½ å¯èƒ½å·²ç»å‘ç°å®ƒçš„æ ¸å¿ƒç®—æ³•å°±æ˜¯å®ç°äº†å…±è¯†ã€‚è®¸å¤šå¤æ‚åº¦æ¥è‡ªäºæŠŠå®ƒå˜æˆ replicated logã€‚åœ¨è®ºæ–‡ä¸­ä¼¼ä¹æ²¡æœ‰æ˜ç¡®è¯´æ˜è¿™ä¸ªå…³ç³»ï¼ˆè™½ç„¶æˆ‘æ²¡ç»†è¯»è¿™éƒ¨åˆ†ï¼‰ã€‚ä½†æ˜¯ï¼Œè„‘å­é‡Œå¸¦ç€ä¸Šæ–‡çš„ç®—æ³•å’Œå…³äº consensus çš„çŸ¥è¯†ï¼Œå¹¶å¿½ç•¥å„ç§å®ç°ç»†èŠ‚ã€æ€§èƒ½é—®é¢˜ï¼ˆå°½ç®¡è¿™åœ¨å·¥ç¨‹å¸ˆçš„æ€ç»´ä¸­å¯èƒ½å¾ˆéš¾ï¼‰ï¼Œä½ å°±å¯ä»¥è¯´æœè‡ªå·±ï¼Œå®ƒç¡®å® workï¼Œè€Œä¸”å¾ˆç®€å•ã€‚All you need is (single-decision) consensus! æ¢å¥è¯è¯´ï¼Œå¦‚æœä½ å·²ç»çŸ¥é“äº† consensus è¿™ä¸ªæŠ½è±¡ï¼Œç„¶åæƒ³æ‰¾ä¸€ä¸ªå®ç°ï¼Œä½ ç«‹åˆ»å°±èƒ½ææ‡‚ Paxos åœ¨å¹²å˜›ã€‚æ‰€ä»¥ï¼Œå¤æ‚çš„ä¸æ˜¯ Paxos ç®—æ³•æœ¬èº«ï¼Œè€Œæ˜¯æœ‰å¾ˆå¤šæ¦‚å¿µæ··åœ¨ä¸€èµ·æ²¡ææ¸…æ¥šã€‚</p>

<p>è¿˜ä¸äº†è§£ Paxos çš„è¯»è€…ï¼Œå¯ä»¥å›å»è¯»ä¸€è¯»è¿™ç¯‡è®ºæ–‡ï¼Œç°åœ¨å¯ä»¥åªå…³æ³¨ single decision çš„éƒ¨åˆ†äº†ï¼Œä¸ç”¨å¤´ç–¼ multiple decisionï¼ä¸è¿‡æˆ‘è¿˜æ˜¯åœ¨è¿™é‡Œç®€å•åœ°è§£é‡Šä¸€ä¸‹ Paxosã€‚</p>

<p><a href="https://blog.openacid.com/algo/paxos/">ä¹‹å‰æåˆ°çš„ xp çš„åšå®¢</a>å¾ˆæ¸…æ™°æ˜“æ‡‚ï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯ä¸»è¦ä¸“æ³¨è®²äº†ç®€å•çš„ä¸œè¥¿ï¼Œæ²¡æœ‰è®²çš„å¤ªå¤šæŠŠè¯»è€…ææ™•ã€‚ä½†æˆ‘è®¤ä¸ºè¿™ç¯‡åšå®¢ä¸­çš„æƒ³æ³•å¯ä»¥å†è¿›ä¸€æ­¥æ¦‚æ‹¬ä¸€ä¸‹ã€‚</p>

<p>é¦–å…ˆï¼Œslide 1-5 ç›¸å½“äºæ˜¯å¼•å…¥æˆ‘ä»¬éœ€è¦ (single-decision) consensus è¿™ä¸ªæŠ½è±¡ã€‚ç„¶åè®¨è®ºäº†è®¸å¤šå¤±è´¥çš„å°è¯•ï¼ˆä½†éƒ½è¿˜æŒºé‡è¦çš„æŠ€æœ¯ï¼‰ã€‚</p>
<ul>
  <li>slide 6-9: Single writer <em>all-ack</em>. ä¸å…è®¸ä»»ä½• crashã€‚</li>
  <li>slide 10-12: Single writer majority-ackï¼ˆæˆ–è€…å« <em>majority-write</em>ï¼‰ã€‚ä¸ºäº†è®©è¿™ä¸ªæ–¹æ³• workï¼Œ<em>Timestamp</em> å’Œ <em>majority-read</em> ä¹ŸåŒæ—¶éœ€è¦ã€‚è¿™ä¸ªç®—æ³•ä¸å…è®¸ writer crashã€‚</li>
  <li>slide 14-17: Majority-write ä¹Ÿä¸èƒ½æ¨å¹¿åˆ° <strong>multiple writers</strong>.</li>
  <li>slide 18-19: (majority) Read before (majority) write.</li>
  <li>slide 20: Request (majority) promise before (majority) write.</li>
</ul>

<p>æ²¡é”™ï¼Œæˆ‘è®¤ä¸º Paxos çš„æ€æƒ³å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€å¥è¯ï¼š<strong>request promise before write</strong>ï¼å®ƒå°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œä¸åˆ° 200 è¡Œä»£ç å°±å¤Ÿå®ç°äº†ã€‚</p>

<p>xp ä»¥ä¸€ç§ç®€å•çš„æ–¹å¼å‘Šè¯‰ä½  Paxos æ˜¯<em>å¦‚ä½•</em>å·¥ä½œçš„ï¼Œä½†ä½ å¯èƒ½ä»ç„¶æƒ³çŸ¥é“<em>ä¸ºä»€ä¹ˆ</em>æˆ‘ä»¬è¦è¿™ä¹ˆå¹²ï¼Œä»¥åŠè¿™ä¹ˆå¹²æ˜¯ä¸æ˜¯çœŸçš„ç¨³äº†ã€‚ç°åœ¨æˆ‘åº”è¯¥è¯´ï¼Œåœ¨ Paxos è®ºæ–‡ä¸­ï¼ŒLamport æ˜¯ï¼ˆä»ä»–æƒ³ä¿è¯çš„æ€§è´¨ä¸­ï¼‰<strong>æ¨å¯¼</strong>å‡ºäº†è¿™ä¸ªæƒ³æ³•ã€‚å› æ­¤ï¼Œå¦‚æœä½ åœ¨å·²ç»äº†è§£äº† Paxos ä¹‹åå†é‡æ–°é˜…è¯»è¿™ç¯‡è®ºæ–‡ï¼Œä½ å¯èƒ½å°±ä¼šå‘ç°å®ƒç›¸å½“å®¹æ˜“ç†è§£ï¼Œè€Œä¸”æœ‰å¾ˆç²¾å½©çš„æ¨ç†å’Œç›´è§‰ã€‚ä½†ä¹Ÿè®¸ææ€•è¿™ä¹Ÿæ˜¯å¾ˆå¤šäººä¸€å¼€å§‹æ²¡èƒ½ç†è§£çš„åŸå› ï¼Œå› ä¸ºä»–ä»¬ä¸ä¹ æƒ¯è¿™ç§æ€ç»´æ–¹å¼ï¼Œåœ¨æ¨å¯¼ä¸ºä»€ä¹ˆ work ä¹‹å‰ï¼Œå°±æ˜¯æƒ³å…ˆçŸ¥é“å®ƒåˆ°åº•æ˜¯å…·ä½“æ€ä¹ˆ work çš„ã€‚</p>

<p>é¡ºä¾¿ä¸€æï¼Œxp çš„åç»­åšå®¢<a href="https://drmingdrmer.github.io/algo/2020/10/28/paxoskv.html">ç”¨200è¡Œä»£ç å®ç°åŸºäºpaxosçš„kvå­˜å‚¨</a>å®ç°äº†ï¼ˆsingle-decisionï¼‰Paxosï¼Œç„¶åæ‰‹åŠ¨ç®¡ç† consensus instanceã€‚ï¼ˆè¿˜æœ‰ä¸€ä¸ªæ›´å¤æ‚çš„åç»­åšå®¢åœ¨<a href="https://blog.openacid.com/algo/mmp3/">è¿™é‡Œ</a>ã€‚ï¼‰æ‰€ä»¥ä½ ä¹Ÿå¯ä»¥é€šè¿‡çœ‹è¿™ä¸ªå®ç°æ¥å­¦ä¹ ï¼ˆsingle-decisionï¼‰Paxosã€‚</p>

<h2 id="raft-æ›´ç®€å•å—">Raft æ›´ç®€å•å—ï¼Ÿ</h2>

<p>è®©æˆ‘ä»¬å›å¤´å†çœ‹ä¸€ä¸‹Raftã€‚é¦–å…ˆï¼Œ"What's wrong with Paxos?" éƒ¨åˆ†ã€‚</p>

<blockquote>
  <p>We hypothesize that Paxos' opaqueness derives from its choice of the single-decree subset as its foundation. Single-decree Paxos is dense and subtle: it is divided into two stages that do not have simple intuitive explanations and cannot be understood independently.</p>
</blockquote>

<p>æˆ‘ç°åœ¨è§‰å¾—è¿™ä¸ªè¯„ä»·æœ‰ç‚¹ <strong>unfair</strong>ã€‚Single-decision consensus æ˜¯åˆ†å¸ƒå¼è®¡ç®—ç†è®ºä¸­ä¸€ä¸ªæˆç†Ÿçš„æŠ½è±¡ã€‚Single-decree Paxos ä¹Ÿæœ‰å¾ˆå¥½çš„ç›´è§‰åœ¨é‡Œé¢ã€‚</p>

<hr />

<p>å¦ä¸€ä¸ªè¯„ä»·æ˜¯ï¼ŒPaxos æ²¡æœ‰ä¸ºåœ¨ <em>real-world</em> systems ä¸­å»ºç«‹ <em>practical</em> çš„å®ç°æä¾›è‰¯å¥½çš„åŸºç¡€ï¼Œè¿™å¯èƒ½ç¡®å®ã€‚ç„¶è€Œï¼Œæˆ‘è®¤ä¸ºè¿™å¯¹ Paxos æ¥è¯´æ ¹æœ¬å°±æ˜¯ä¸ª <strong>non-goal</strong>ã€‚å®ƒå°±æ˜¯åœ¨è®²è§£å†³ä¸€ä¸ªç†è®ºé—®é¢˜çš„ä¸€ç§ä¼˜é›…çš„ç®—æ³•ã€‚å®ƒå°±æ ¹æœ¬<strong>ä¸å¤ªå…³å¿ƒ</strong>ä½ åœ¨ç°å®ä¸–ç•Œä¸­å¦‚ä½•å®ç°å®ƒâ€¦â€¦æˆ‘è®¤ä¸º Lamport ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒåç†è®ºçš„ researcherã€‚(ä»–å»ºç«‹äº†åˆ†å¸ƒå¼è®¡ç®—ç†è®ºçš„åŸºç¡€ã€‚ï¼‰ç°å®ä¸–ç•Œçš„ä¸œä¸œå¯¹ theory researchers å¯èƒ½æ²¡æœ‰é‚£ä¹ˆå¤§çš„å¸å¼•åŠ›ï¼Œå¦‚æœé—®é¢˜åœ¨ç†è®ºä¸Šæ²¡å•¥æ„æ€çš„è¯â€¦â€¦</p>

<hr />

<p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ Raft æœ¬èº«ã€‚æˆ‘ä¹Ÿå°†å°è¯•ç”¨å‡ å¥è¯æ¥æè¿°å®ƒã€‚</p>

<p>é¦–å…ˆï¼Œå®ƒè°ˆäº† replicated state machineï¼Œå¹¶ä¸”<strong>æ˜ç¡®åœ°å‘Šè¯‰ä½ æˆ‘ä»¬æ­£åœ¨é€  replicated log</strong>ã€‚å·¥ç¨‹å¸ˆå¯èƒ½å¯¹ consensus ä¸ç†Ÿæ‚‰ï¼Œä½†å¯¹ log ä¸€å®šéå¸¸äº†è§£ã€‚</p>

<p>ç¬¬äºŒï¼ŒRaft é€‰æ‹©äº† <strong>leader-based</strong> æ–¹æ³•ï¼šåªæœ‰ leader å¯ä»¥ä¸å¤–ç•Œäº¤äº’ä»¥åŠ append entryã€‚Paxos åˆ™å®Œå…¨æ˜¯ <strong>peer-to-peer</strong>ã€‚æœ‰ä¸€ä¸ª leader é€šå¸¸ä¼šä½¿ä¸»è¦æµç¨‹æˆ– â€œhappy pathâ€ æ›´å®¹æ˜“ç†è§£ã€‚Raft è‡ªç„¶åœ°é€‰æ‹©äº† majority-writeã€‚é‚£ä¹ˆå”¯ä¸€çš„é—®é¢˜æ˜¯å¦‚ä½•å¤„ç† leader crashã€‚Raft çš„æ–¹æ³•æ˜¯ï¼šé™åˆ¶èŠ‚ç‚¹ä¸ç»™ outdated èŠ‚ç‚¹æŠ•ç¥¨ã€‚è¿™ä¸ªæŠ€æœ¯å¾ˆç®€å•ï¼Œä½†ä¹Ÿéœ€è¦èŠ±äº›åŠŸå¤«å»ç†è§£å®ƒä¸ºä»€ä¹ˆ workï¼Œå› ä¸ºå…¶å®é‡Œé¢æ¶µç›–äº†å¾ˆå¤š edge casesã€‚è¦ç»´æŠ¤çš„æ€§è´¨å…¶å®æ˜¯ï¼Œæ–°çš„ leader å¿…é¡»<em>è‡³å°‘</em>åŒ…å«æ‰€æœ‰ majority-written entriesï¼Œä½†æ˜¯å¦åŒ…å«æ›´å¤šçš„ pending entries åˆ™æ— æ‰€è°“ã€‚</p>

<p>æœ€åï¼Œreplicated log é‡Œä¼šå­˜åœ¨ä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œleader é€šè¿‡æŠŠå®ƒè¦†ç›–æ‰æ¥ä¿®å¤ã€‚</p>

<p>æ‰€ä»¥ Raft ç®€å•å—ï¼Ÿå®ƒçš„æ ¸å¿ƒæ€æƒ³ä¹Ÿä¸éš¾ã€‚å®ƒä¹Ÿå°±æ˜¯ single-leader majority-write â€¦â€¦ å†åŠ ä¸Šä¸€äº›é¢å¤–ä½†ä¹Ÿå¾ˆç®€å•çš„ trickï¼ˆä»¥ç¡®ä¿ majority-write èƒ½ workï¼‰ã€‚</p>

<p>ç®€è€Œè¨€ä¹‹ï¼ŒRaft</p>
<ul>
  <li>ç›´æ¥å®ç° replicated logã€‚</li>
  <li>è°ˆè®º<strong>å…·ä½“çš„æ¦‚å¿µ</strong>ï¼Œå¦‚ heartbeat, timeout, RPC and crash recoveryï¼Œè€Œä¸æ˜¯åƒ theory researcher ä¸€æ ·è°ˆè®ºæŠ½è±¡æ¦‚å¿µã€‚</li>
  <li>è°ˆè®ºæ‰€æœ‰è·¯å¾„ä¸­çš„<strong>æ‰€æœ‰ç»†èŠ‚</strong>ï¼ˆçŠ¶æ€è½¬æ¢ï¼‰ï¼Œå¹¶ä¸”ç®—æ˜¯ç”¨ä¸€ç§ manageable way <strong>æš´éœ²äº†å¤æ‚åº¦</strong>ã€‚(Paxos ä¸å…³å¿ƒè¿™äº› <strong>trivil</strong> çš„å®ç°å¤æ‚åº¦)ã€‚</li>
</ul>

<p>æ‰€ä»¥è¯»å®Œ Raft åï¼Œä½ åŸºæœ¬ä¸Šå¯ä»¥ç›´æ¥<strong>ç¿»è¯‘æˆä»£ç </strong>ã€‚ç›¸å¯¹çš„ï¼ŒPaxos åœ¨ç†è®ºä¸Šå¾ˆç®€å•ï¼Œè¯»å®Œåï¼Œä½ å¯èƒ½ä¼šæ€è€ƒä¸€é˜µå­ï¼Œç„¶åå¤§å«ä¸€å£°ï¼š<strong>å“¦ï¼Œå®ƒç¡®å® work! å¤ªç®€å•äº†ï¼</strong>ï¼ˆå°±åƒä¸€ä¸ªæ•°å­¦å®¶ä¸€æ ·ã€‚ï¼‰é‚£ä¹Ÿå°±éš¾æ€ªå¤§å¤šæ•°äººï¼Œå°¤å…¶æ˜¯å·¥ç¨‹å¸ˆï¼Œä¼šè§‰å¾— Raft è¯»èµ·æ¥æ›´èˆ’æœã€‚</p>

<h2 id="æ›´å¤šå…³äº-consensus-çš„è¯é¢˜">æ›´å¤šå…³äº Consensus çš„è¯é¢˜</h2>

<p>å…³äº consensusï¼Œè¿˜æœ‰æ›´å¤šæœ‰è¶£çš„ç†è®ºé—®é¢˜ã€‚é™¤äº† universality ä¹‹å¤–ï¼Œæœ€é‡è¦çš„é—®é¢˜å¯èƒ½æ˜¯å…±è¯†çš„ <strong>impossibility</strong>ï¼å…·ä½“æ¥è¯´ï¼ŒFLP impossibility è¯´ï¼šåœ¨ä¸€ä¸ªå¼‚æ­¥çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœå¯èƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹ crashï¼Œå…±è¯†æ˜¯ä¸å¯èƒ½å®ç°çš„ã€‚</p>

<p>å•Šï¼Ÿé‚£ Paxos å’Œ Raft åœ¨å¹²å˜›ï¼Ÿ</p>

<p><em>Don't panic.</em> è¿™é‡Œçš„<strong>å¼‚æ­¥</strong>ç³»ç»Ÿæ˜¯æŒ‡ï¼šæ¯ä¸ªè¿›ç¨‹å¯ä»¥è¢« delay <em>ä»»æ„é•¿</em>çš„æ—¶é—´ï¼Œè€Œæˆ‘ä»¬å¯¹åˆ«äººæ˜¯å¦æ´»ç€ä¸€æ— æ‰€çŸ¥ã€‚ä½†åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬å…¶å®æœ‰ä¸€äº›ï¼ˆå…³äº<strong>æ—¶é—´</strong>çš„ï¼‰å‡è®¾ã€‚ç°å®ä¸–ç•Œæ›´åƒæ˜¯ä¸€ä¸ª<strong>æœ€ç»ˆåŒæ­¥çš„</strong>ï¼ˆeventually synchronousï¼‰ç³»ç»Ÿï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æœ‰ä¸€ä¸ª eventually perfect failure detectorï¼šå®ƒå¯èƒ½ä¼šè¯¯è¯ŠæŠŠæ´»äººå½“æ­»äººï¼Œä½†æ˜¯å¦‚æœå†å¤šç­‰ç­‰ï¼Œå®ƒä¼šè‡ªå·±æ”¹æ­£é”™è¯¯çš„ç»“è®ºã€‚å…¶å® heartbeat å’Œ timeout æœºåˆ¶åŸºæœ¬ä¸Šå°±æ˜¯åœ¨å®ç°ä¸€ä¸ª eventually perfect failure detectorã€‚</p>

<p>å¦ä¸€ä¸ªé™„å¸¦è¯´æ˜æ˜¯ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢å‡è®¾äº†é€šè¿‡ message-passing è¿›è¡Œé€šä¿¡ã€‚å¦‚æœæˆ‘ä»¬åˆ‡æ¢åˆ° shared memoryï¼Œæˆ‘ä»¬ä»ç„¶ä¼šæœ‰ FLP impossibilityã€‚å‡†ç¡®åœ°è¯´ï¼Œåªä½¿ç”¨ <strong>shared registers</strong> æ˜¯ä¸å¯èƒ½å®ç°å…±è¯†çš„ã€‚</p>

<p>å…¶å® FLP impossibility çš„è¯æ˜ä¹Ÿéå¸¸ç²¾å½©ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šé¦–å…ˆï¼Œä»»ä½•å…±è¯†ç®—æ³•çš„æ‰§è¡Œéƒ½å¿…é¡»æœ‰ä¸€ä¸ª<strong>ä¸´ç•Œæ—¶é—´ç‚¹</strong>ï¼ˆcritical timingï¼‰ã€‚ä»ä¸Šå¸è§†è§’çœ‹ï¼Œæ•´ä¸ªç³»ç»Ÿå½“å‰å¹¶æ²¡æœ‰è¾¾æˆ decisionï¼Œä½†ç«‹åˆ»å³å°†ï¼ˆåœ¨ä»»ä½•äººæ‰§è¡Œä¸€å°æ­¥ä»¥åï¼‰è¾¾æˆ decisionã€‚æ‰€æœ‰åæ¥çš„æ­¥éª¤éƒ½åªæ˜¯åœ¨èµ°æµç¨‹å‘ŠçŸ¥æ‰€æœ‰äººç»“æœç½¢äº†ã€‚(å¦‚æœä½ æ‡‚å‘½è¿çŸ³ä¹‹é—¨çš„è¯ï¼Œè¿™æ„æ€å°±æ˜¯ä¸–ç•Œçº¿é©¬ä¸Šè¦æ”¶æŸäº†ï¼‰ã€‚ç„¶åæˆ‘ä»¬æ–­è¨€ï¼Œæ‰€æœ‰äººçš„ä¸‹ä¸€æ­¥éƒ½æƒ³è®¿é—®åŒä¸€ä¸ª shared registerï¼</p>

<p>ä¸ºäº†æ–¹ä¾¿ç»§ç»­è®¨è®ºï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªè¿›ç¨‹ <code class="language-plaintext highlighter-rouge">p1</code> å’Œ <code class="language-plaintext highlighter-rouge">p2</code>ã€‚å¦‚æœä»–ä»¬ä¸è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ï¼Œä»¥ä¸‹ä¸¤ç§ possible histories æ˜¯ç­‰ä»·çš„ã€‚</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">p1</code> èµ°ä¸€æ­¥ï¼Œç„¶å <code class="language-plaintext highlighter-rouge">p2</code> èµ°ä¸€æ­¥ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">p2</code> èµ°ä¸€æ­¥ï¼Œç„¶å <code class="language-plaintext highlighter-rouge">p1</code> èµ°ä¸€æ­¥ã€‚</li>
</ol>

<p>è¿™è¯´æ˜è¿™ä¸ª timing ä¸ critical å•Šï¼ŒçŸ›ç›¾ï¼</p>

<p>ç°åœ¨å‡è®¾ä»–ä»¬éƒ½è¦è®¿é—® shared register <code class="language-plaintext highlighter-rouge">x</code>ã€‚</p>
<ul>
  <li>Case 1ï¼šå¦‚æœç¬¬ä¸€æ­¥æ˜¯è¦è¯» <code class="language-plaintext highlighter-rouge">x</code>ï¼Œæˆ‘ä»¬åœ¨å®ƒè¯»å®Œä»¥åé©¬ä¸ŠæŠŠå®ƒå¹²æ‰ã€‚é‚£ä¹ˆå¦ä¸€ä¸ªè¿›ç¨‹ä¼šè®¤ä¸ºä¸€åˆ‡éƒ½å’ŒåŸæ¥ä¸€æ ·å•Šï¼Œæ‰€ä»¥å®ƒåšä¸å‡º decisionï¼è¿™æ„å‘³ç€åœ¨ critical timing å¿…é¡»å¯¹æ•´ä¸ªç³»ç»Ÿåšå‡ºä¸€äº› <strong>observable change</strong> æ‰è¡Œã€‚æ‰€ä»¥</li>
  <li>
    <p>Case 2ï¼šä¸¤ä¸ªè¿›ç¨‹çš„ç¬¬ä¸€æ­¥éƒ½æ˜¯å†™ <code class="language-plaintext highlighter-rouge">x</code>ã€‚é‚£ä¹ˆä»¥ä¸‹ä¸¤ç§ possible histories æ˜¯ç­‰ä»·çš„ï¼š</p>

    <ol>
      <li><code class="language-plaintext highlighter-rouge">p1</code> å†™ <code class="language-plaintext highlighter-rouge">v1</code> è¿› <code class="language-plaintext highlighter-rouge">x</code>ï¼Œç„¶åç«‹åˆ»è¢«å¹²æ‰ã€‚<code class="language-plaintext highlighter-rouge">p2</code> å°† <code class="language-plaintext highlighter-rouge">v2</code> å†™å…¥ <code class="language-plaintext highlighter-rouge">x</code>ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">p1</code> ç«‹åˆ»è¢«å¹²æ‰ã€‚<code class="language-plaintext highlighter-rouge">p2</code> å°† <code class="language-plaintext highlighter-rouge">v2</code> å†™å…¥ <code class="language-plaintext highlighter-rouge">x</code>ã€‚</li>
    </ol>

    <p>åŒæ ·ï¼Œè¿™ä¸ critical timing ç›¸çŸ›ç›¾ï¼ï¼ˆè°å…ˆèµ°ä¸é‡è¦å•Šï¼‰</p>
  </li>
</ul>

<p>è¿™å°±è¯å®Œäº†ï¼(æˆ‘è¯äº†ä¸–ç•Œçº¿æ”¶æ•›ä¸äº†ã€‚)æ˜¯ä¸æ˜¯ä¹Ÿå¾ˆç®€å•ï¼Ÿç°åœ¨ä½ å¯èƒ½ä¹Ÿå¯¹ä¸ºä»€ä¹ˆ impossiblity èƒ½æˆç«‹ä¹Ÿæœ‰äº†ç‚¹æ„Ÿè§‰ã€‚å› ä¸ºå¼‚æ­¥æ˜¯ä¸€ä¸ªå¤ªå¼±çš„å‡è®¾ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒç»™äº† <em>scheduler</em>ï¼ˆæˆ–è€…æˆ‘ä»¬è¿™äº›è¯å®šç†çš„åäººï¼‰å¤ªå¤§çš„æƒåŠ›ã€‚</p>

<p>æ›´ exciting çš„æ˜¯ï¼Œä¸Šè¿°è¯æ˜æ¡†æ¶é€‚ç”¨äºæ›´å¤šæƒ…å†µã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢è¯æ˜äº†<em>2ä¸ªè¿›ç¨‹</em>ä¹‹é—´çš„å…±è¯†åªä½¿ç”¨ register æ˜¯ä¸å¯èƒ½çš„ã€‚æˆ‘ä»¬åŒæ ·å¯ä»¥è¯æ˜<em>3ä¸ªè¿›ç¨‹</em>ä¹‹é—´çš„å…±è¯†åªç”¨ register å’Œ queue æˆ– fetch-and-add æ˜¯ä¸å¯èƒ½çš„ï¼ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨ compare-and-swap åœ¨ä»»ä½•æ•°é‡çš„è¿›ç¨‹ä¹‹é—´å®ç°å…±è¯†ï¼</p>

<p>è¿™äº›ç»“è®ºç»™äº†æˆ‘ä»¬ä¸€ç§<strong>æ¯”è¾ƒ shared objects çš„è¡¨è¾¾åŠ›çš„æ–¹æ³•</strong>ï¼šconsensus numberã€‚Register çš„ consensus number ä¸º 1ï¼Œqueue å’Œ FAA çš„ä¸º 2ï¼ŒCAS çš„ä¸º âˆã€‚å…³äº consensus number è¿˜æœ‰ä¸€äº›æœªè§£å†³çš„ç ”ç©¶é—®é¢˜ï¼Œä½†æˆ‘æƒ³æˆ‘ä»¬ç°åœ¨è¿˜æ˜¯é€‚å¯è€Œæ­¢å§ï¼</p>

<p>æœ€åæ€»ç»“ä¸€å¥ï¼Œåˆ†å¸ƒå¼è®¡ç®—ç†è®ºè¿˜æ˜¯æŒºæœ‰è¶£çš„ï¼Œå€¼å¾—å­¦ä¹ ä¸€ç‚¹ã€‚ğŸ˜„</p>]]></content><author><name>xxchan</name></author><category term="CS" /><category term="consensus" /><category term="system" /><summary type="html"><![CDATA[å› ä¸ºå®ƒéœ€è¦ä¸€ç§ä¸åŒçš„æ€ç»´æ–¹å¼]]></summary></entry><entry><title type="html">Why is Paxos So Hard to Understand?</title><link href="https://xxchan.me/cs/2022/02/07/paxos-hard.html" rel="alternate" type="text/html" title="Why is Paxos So Hard to Understand?" /><published>2022-02-07T00:00:00+00:00</published><updated>2022-02-07T00:00:00+00:00</updated><id>https://xxchan.me/cs/2022/02/07/paxos-hard</id><content type="html" xml:base="https://xxchan.me/cs/2022/02/07/paxos-hard.html"><![CDATA[<p><a href="https://xxchan.github.io/cs/2022/02/09/paxos-hard-zh.html">Chinese Version</a></p>

<p>In this blog, I will <strong>omit practical aspects like performance issues</strong>. I will focus on general ideas like basic notions, expressiveness, or "<strong>how to make it possible</strong>" instead of "how to make it super-fast". Also, I will try to convey my ideas to readers without any knowledge of distributed systems or consensus. Still, it may be better if you already know one or more consensus algorithms, like Raft or Paxos.</p>

<h2 id="my-way-of-learning-consensus">My Way of Learning Consensus</h2>

<p><a href="https://www.zhihu.com/question/65038346/answer/227674428">This zhihu answer: Is there a moment when you feel the malice of the author of a paper?</a> (Chinese) was the first time I knew Paxos and consensus. I thought it was really fun.</p>

<p>Exactly one year ago, I was learning MIT 6.824 and implementing Raft. I thought it organizes things into modules and explains each module clearly. I also giggled when reading the "What's wrong with Paxos?" part. Although I experienced some difficulty debugging Raft, the cognitive process was smooth.</p>

<p>Last semester, I needed to implement Paxos in one of my homework. I happened to have bookmarked <a href="https://blog.openacid.com/algo/paxos/">this blog</a> earlier. I found it explains Paxos in a simple way and I implemented (basic) Paxos correspondingly, without reading papers or other explanation articles. The homework also required us to implement multiple decisions using a given technique, so I didn't read things like multi-Paxos.</p>

<p>I also had Concurrent Algorithms and Distributed Algorithms courses. They are theoretical, and both talked about consensus, and I thought it was not very hard to understand. The consensus algorithm given in the DA course is very like Paxos, and it's simple enough to fit in one slide. Besides, the Universal Construction in the CA course and the Total Order Broadcast algorithm in the DA course, which prove you can use consensus to do almost anything, are also not hard to understand. And then, I began to wonder why people think Paxos is hard to understand, and that's why I wanted to write this blog.</p>

<p>Finally, I read the two Paxos papers and confirmed that they are both understandable. But Lamport's language is so interesting. <em>The Part-Time Parliament</em> is very detailed and straightforward. It kind of looks like it uses a mapping to transform the terms. <em>Paxos Made Simple</em> instead talks about intuitions in plain words. It is kind of like a blog.</p>

<p>Anyway, let's go to the main topic.</p>

<h2 id="abstractions-consensus-replicated-log-and-replicated-state-machine">Abstractions: Consensus, Replicated Log, and Replicated State Machine</h2>

<p>First, let's put aside the consensus algorithms but focus on the abstraction (or the interface).</p>

<p>In distributed systems, we generally want to <em>share</em> something. Then shared objects or shared data structures are super helpful. It is like a usual data structure (e.g., queue, map) in a single machine but can be accessed by different computers (or threads). In other words, the computers work together to maintain a global object and have its state replicated on every machine.</p>

<p>Then replicated state machine is the ultimate abstraction, a generalization of all shared data structures. (Or we can say all shared data structures can be implemented using replicated state machine). You may quickly come up with that maintaining a replicated log is a natural implementation of the replicated state machine. And that's true.</p>

<p>By the way, the replicated log can also be viewed as another abstraction, Total-Order Broadcast: Every process broadcasts messages, but they deliver messages in the same global order. (Very similar, not very important.)</p>

<p>Then what's consensus? Here it is, the most original consensus interface. First, it's just one shared object. Its <em>sequential specification</em> (How it works if it is accessed by different processes <em>sequentially</em>) is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maintaining a variable: prop
initial value: âŠ¥ (uninitialized)

propose(v):
    if prop == âŠ¥:
        prop = v
    return prop
</code></pre></div></div>

<p>Fairly simple, right? Some notes here:</p>
<ul>
  <li>It is one-shot. A single decision. It can be viewed as a write-once variable.</li>
  <li>Here synchronous style interface is shown. Using asynchronous event-based interfaces is also totally fine.</li>
  <li>It is usually assumed that every process has something to propose, and proposing is the only way to get the decided value. I think this convention is just for simplicity. You can easily modify the interface to get notified about the decision without proposing.</li>
</ul>

<p>Equivalently, we can also describe consensus by giving its properties:</p>
<ul>
  <li>Validity: A decided value is proposed.</li>
  <li>Agreement: No processes decide differently.</li>
  <li>Termination: Every process eventually decides.</li>
</ul>

<h2 id="implement-replicated-state-machine-using-consensus">Implement Replicated State Machine Using Consensus</h2>

<p>Consensus is such a simple abstraction, but it is powerful enough to build replicated state machine, i.e., it can be used to implement any shared object. There's a loud name for this conclusion: <strong>Universality of Consensus</strong>.</p>

<p>Before we go further, we can think about a naÃ¯ve solution: Consensus is already a single replicated log entry, so why not use a list of consensus as the whole replicated log? When a process have a new entry to append to the log, it just keeps moving forward and proposing the entry in the consensus list until its proposal is decided in one consensus instance.</p>

<p>This idea almost works, except for one critical problem: a process may never get its proposal decided. It can starve. The solution is also not very complicated. Now processes not only propose their own value but also <strong>help</strong> others. Specifically, when a new entry comes, the process will first broadcast it, and it keeps collecting others' entries. Then each of its proposals will be <strong>the set of all pending entries</strong> (instead of one entry). That's it!</p>

<p>Of course, this is not the only way and is a rather unoptimized way, but it works perfectly.</p>

<p>Without a concrete algorithm in mind, you may already have thought that it was feasible to go from the consensus to the replicated log. I just showed that there's a simple way to do so to make us confident in the possibility. Going from the consensus to the replicated log is like shifting from manual gear to automatic gear.</p>

<h2 id="why-is-paxos-hard">Why is Paxos hard?</h2>

<p>If you know how Paxos work, you may already find out that its core indeed implements consensus. Many complexities come from turning it into the replicated log. It seems that this relationship is not clearly stated in the paper (although I didn't read this part carefully). But having the replicated log algorithm and other meta-knowledge about consensus above in mind and omitting implementation details and performance issues (although this might be hard in an engineer's mindset), you can convince yourself it works, in a simple way. All you need is (single-decision) consensus! In other words, if you already know the consensus abstraction and are looking for an implementation, you will quickly get what Paxos is doing. So it's not the algorithm itself that is complex, but there are many concepts mixed together.</p>

<p>For those who don't know Paxos yet, you can go back to read the paper and focus on the single decision part first without being bothered by multiple decisions now! But I will still give some simple explanations here.</p>

<p><a href="https://blog.openacid.com/algo/paxos/">The previously mentioned blog by xp</a> (Chinese) is clear and understandable because it also focuses on simple things without going too far to confuse the reader. But I think the ideas in this blog can be further summarized:</p>

<p>First, Single decision consensus interface is introduced (slide 1-5). And then many failed attempts (but still important techniques) are discussed:</p>
<ul>
  <li>slide 6-9: Single writer <em>all-ack</em>. It doesn't tolerate any crashes.</li>
  <li>slide 10-12: Single writer majority-ack (or <em>majority-write</em>). <em>Timestamp</em> + <em>majority-read</em> are also needed for it to work. This algorithm doesn't tolerate the writer's crash.</li>
  <li>slide 14-17: Majority-write can neither be generalized to <strong>multiple writers</strong>.</li>
  <li>slide 18-19: (majority) Read before (majority) write.</li>
  <li>slide 20: Request (majority) promise before (majority) write.</li>
</ul>

<p>Yes, I think Paxos's idea can be summarized into one sentence: <strong>request promise before write</strong>! It is indeed so simple and can be implemented with fewer than 200 LoC.</p>

<p>xp tells you <em>how</em> Paxos works in a simple way, but you may still wonder <em>why</em> we go this way and whether this really works. Now I should say in his paper, Lamport <strong>derives</strong> this idea (from <em>properties</em> he wants to achieve). So if you re-read the paper after you already know Paxos, you may find it rather understandable and has brilliant reasoning and intuitions. But I'm afraid that maybe this is also why many people failed to understand it at the beginning, because they are not accustomed to this way of thinking and want to know how exactly it works before knowing where the idea can be derived.</p>

<p>Btw, xp's follow-up blog: <a href="https://drmingdrmer.github.io/algo/2020/10/28/paxoskv.html">Implement paxos-based kv storage with 200 line of code</a> implements (single-decision) Paxos, and manages consensus instances by hand. (There's a more complicated follow-up blog <a href="https://blog.openacid.com/algo/mmp3/">here</a>) So you can also learn (single-decision) Paxos by reading the implementation.</p>

<h2 id="is-raft-easier">Is Raft Easier?</h2>

<p>Let's go back and look at Raft again. First, the "What's wrong with Paxos?" part.</p>

<blockquote>
  <p>We hypothesize that Paxos' opaqueness derives from its choice of the single-decree subset as its foundation. Single-decree Paxos is dense and subtle: it is divided into two stages that do not have simple intuitive explanations and cannot be understood independently.</p>
</blockquote>

<p>I should now say this evaluation is a little bit <strong>unfair</strong>. Single-decision consensus is a well-established abstraction in distributed computing theory. Single-decree Paxos also has good intuitions.</p>

<hr />

<p>Another evaluation that Paxos does not provide a good foundation for building <em>practical</em> implementations in <em>real-world</em> systems may be true. However, I think this is just a <strong>non-goal</strong> for Paxos. It talks about an elegant way to solve a theoretical problem. It just <strong>doesn't care</strong> much about how you implement it in the real-worldâ€¦ I think Lamport is also a more theoretical researcher. (He established the foundation of the distributed computing theory.) Real-world stuff may not be that attractive to theory researchers, if the problem is not theoretically interesting.</p>

<hr />

<p>Now let's look at Raft itself. I will also try to describe it in a few words.</p>

<p>First, it talks about the replicated state machine and <strong>tells you explicitly we are building the replicated log</strong>. Engineers may be unfamiliar with consensus, but must know logs very well.</p>

<p>Second, Raft chooses the <strong>leader-based</strong> approach: only the leader can interact with the outside world and append entries to the log. Paxos is instead completely <strong>peer-to-peer</strong>. Having a leader will usually make the main process or the "happy path" easier to understand. Raft chooses majority-write naturally. Then the only problem is how to handle the leader's crash, and Raft's approach is to restrict nodes from voting for <em>outdated</em> nodes. The trick is simple, but it also takes some effort to understand why it works because many edge cases are covered. The property to maintain is that the new leader must <em>at least</em> contain all majority-written entries, but whether it contains more pending entries is insignificant.</p>

<p>Finally, inconsistent states exist in the replicate log, and the leader will fix it by overwriting.</p>

<p>So is Raft easy? Its core idea is also not hard. It's just single-leader majority-write, â€¦ with some additional but simple tricks (to ensure majority-write work).</p>

<p>To summarize, Raft</p>
<ul>
  <li>Implements replicated log directly.</li>
  <li>Talks <strong>concrete notions</strong> like heartbeat, timeout, RPC and crash recovery, instead of talking about abstractions like a theory researcher.</li>
  <li>Talks <strong>all details in all paths</strong> (state transformations), and <strong>exposes complexities</strong> in a manageable way. (Paxos doesn't care these <em>trivial</em> implementation complexities.)</li>
</ul>

<p>So after reading Raft, you can almost directly <strong>translate it into code</strong>. Instead, Paxos is theoretically simple. After reading it, you may think for a while and then exclaim: <strong>Oh, it works! It's so simple!</strong> (Just like a Mathematician.) Then no wonder most people, especially engineers, will feel more comfortable when reading Raft.</p>

<h2 id="more-about-consensus">More about Consensus</h2>

<p>There are more interesting theoretical problems about consensus. Besides universality, the most important one may be the <strong>impossibility</strong> of consensus! To be specific, here's the FLP impossibility: Consensus is impossible in an asynchronous distributed system if one process can crash.</p>

<p>Hey, then what are Paxos and Raft doing???</p>

<p><em>Don't panic.</em> Here <strong>asynchronous</strong> system means: each process can be delayed for <em>arbitrarily long</em>, and we <em>know nothing</em> about whether they are alive. But in practice, we do have some assumptions (about <strong>time</strong>). Real-world is more like an <strong>eventually synchronous</strong> system, which means we can have an <em>eventually perfect failure detector</em>: It can wrongly suspect a slow process as dead, but it will make corrections if time lasts long enough. Basically, the heartbeat and timeout mechanism implements an eventually perfect failure detector.</p>

<p>Another side note is that actually, we assume communication by message-passing above. If we switch to shared memory, we will still have FLP impossibility. To be precise, it is impossible to implement consensus using only <strong>shared registers</strong>.</p>

<p>I should mention that the proof of FLP impossibility is also very brilliant! The core idea is: any consensus algorithm's execution must have a <strong>critical timing</strong>. From God's perspective, currently, the system doesn't reach a decision but will immediately (after a single step of any process) reach a decision. All later steps are just going through a process to get everybody notified. (If you know <em>Steins;Gate</em>, it means the world line will convergent into an attractor field.) Then we argue that all the processes' next steps are accessing the same register at the critical timing!</p>

<p>To continue the discussion, let's assume we have two processes <code class="language-plaintext highlighter-rouge">p1</code> and <code class="language-plaintext highlighter-rouge">p2</code> . If they are not accessing the same object, the following two possible histories are equivalent:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">p1</code> goes one step and then <code class="language-plaintext highlighter-rouge">p2</code> goes one step.</li>
  <li><code class="language-plaintext highlighter-rouge">p2</code> goes one step and then <code class="language-plaintext highlighter-rouge">p1</code> goes one step.</li>
</ol>

<p>This contradicts the critical timing assumption!</p>

<p>Now assume they are both about to access register <code class="language-plaintext highlighter-rouge">x</code> .</p>
<ul>
  <li>Case 1: If the first step is reading <code class="language-plaintext highlighter-rouge">x</code> , we stop the process forever after this step. Then the other process will think everything is the same as before, so it cannot decide! This means the critical step must <strong>make some observable change</strong> to the whole system. So</li>
  <li>
    <p>Case 2: Both processes' first step is writing <code class="language-plaintext highlighter-rouge">x</code> . Then the following two possible histories are equivalent:</p>

    <ol>
      <li><code class="language-plaintext highlighter-rouge">p1</code> writes <code class="language-plaintext highlighter-rouge">v1</code> to <code class="language-plaintext highlighter-rouge">x</code>, and stops forever. Then <code class="language-plaintext highlighter-rouge">p2</code> writes <code class="language-plaintext highlighter-rouge">v2</code> to <code class="language-plaintext highlighter-rouge">x</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">p1</code> stops forever immediately. <code class="language-plaintext highlighter-rouge">p2</code> writes <code class="language-plaintext highlighter-rouge">v2</code> to <code class="language-plaintext highlighter-rouge">x</code>.</li>
    </ol>

    <p>Again, this contradicts the critical timing assumption!</p>
  </li>
</ul>

<p>The proof is now finished. (I just showed the world line can never convergent.) Not complicated, right? And now you may also have some idea why the impossibility holds. Asynchrony is a too weak assumption. In other words, it gives too strong power to the <em>scheduler</em> (or us the prover).</p>

<p>More excitingly, the above proof framework applies to more situations. Actually, we proved above consensus <em>among 2 processes</em> is impossible using only registers. We can similarly prove consensus <em>among 3 processes</em> is impossible using only registers and queue/fetch-and-add! But we can implement consensus among any number of processes using compare-and-swap!</p>

<p>These results proposed a way to <strong>compare the expressiveness of shared objects</strong>: consensus number. Register has consensus number 1, queue and FAA have 2, and CAS has âˆ. There are still unresolved research problems about consensus numbers, but I think we'd better stop here now.</p>

<p>As a concluding note, I think distributed computing theory is interesting and worth learning a bit. ğŸ˜„</p>]]></content><author><name>xxchan</name></author><category term="CS" /><category term="consensus" /><category term="system" /><summary type="html"><![CDATA[Because it requires a different mindset]]></summary></entry><entry><title type="html">ä»æ¥å£è§†è§’çœ‹å¯†ç å­¦åŸè¯­</title><link href="https://xxchan.me/cs/2021/11/13/crypto-interfaces.html" rel="alternate" type="text/html" title="ä»æ¥å£è§†è§’çœ‹å¯†ç å­¦åŸè¯­" /><published>2021-11-13T00:00:00+00:00</published><updated>2021-11-13T00:00:00+00:00</updated><id>https://xxchan.me/cs/2021/11/13/crypto-interfaces</id><content type="html" xml:base="https://xxchan.me/cs/2021/11/13/crypto-interfaces.html"><![CDATA[<p>ç°ä»£å¯†ç å­¦ä¸»è¦æ˜¯å»ºç«‹åœ¨é—®é¢˜çš„å›°éš¾æ€§ä¸Šçš„ï¼šè§£å¯†ç›¸å½“äºæ±‚è§£ä¸€ä¸ªå›°éš¾çš„æ•°å­¦é—®é¢˜ã€‚è¿™äº›ç²¾å¦™çš„æ„é€ æ˜¯äººç±»æ™ºæ…§çš„ç²¾åï¼Œè¦æƒ³å®Œå…¨ç†è§£ä»–ä»¬ï¼Œéœ€è¦ä¸å°‘çš„æ•°å­¦åŸºç¡€ã€‚ä½†å…¶å®å¯†ç å­¦ä¹Ÿæ˜¯æ¨¡å—åŒ–çš„ï¼Œå®ƒæä¾›äº†å„ç§åŸºç¡€çš„åŸè¯­ï¼Œä½œä¸ºå¯¹å¯†ç å­¦æ²¡é‚£ä¹ˆæ„Ÿå…´è¶£çš„æ™®é€šäººï¼Œå°¤å…¶æ˜¯å¼€å‘è€…ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä¸ç”¨å®Œå…¨ææ‡‚é‡Œé¢çš„æ•°å­¦é—®é¢˜ï¼Œè€Œæ˜¯çœ‹å®ƒæä¾›äº†ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œä¿è¯äº†ä»€ä¹ˆæ€§è´¨ï¼Œè¿™ç§å¸¸è¯†æ€§çš„ç†è§£å…¶å®æ›´å®ç”¨ä¹Ÿæ›´é‡è¦ã€‚</p>

<p><em>Disclaimer: å› æ­¤æœ¬æ–‡åœ¨å…·ä½“æ•°å­¦æ„é€ ä¸Šä¼šæ¯”è¾ƒç®€åŒ–å’Œä¸ä¸¥è°¨ï¼Œè¯·å‹¿å½“çœŸã€‚å¦‚æœ‰æ¦‚å¿µç†è§£æ€§é”™è¯¯ï¼Œè¯·å¤šæŒ‡æ­£ï¼</em></p>

<h2 id="å¯¹ç§°åŠ å¯†">å¯¹ç§°åŠ å¯†</h2>
<p><strong>å‡è®¾</strong>ï¼šåŒæ–¹æå‰é€šè¿‡å¯é æ–¹å¼å…±äº«äº†ä¸€ä¸ª secret keyã€‚</p>

<p>Secret key åŒæ—¶ç”¨æ¥åŠ å¯†å’Œè§£å¯†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â”Œâ”€â”€â”€â”€â”€â” ciphertext=encrypt(secret_key,message)â”Œâ”€â”€â”€â”€â”€â”
â”‚Aliceâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt;â”‚ Bob â”‚
â””â”€â”€â”€â”€â”€â”˜                                       â””â”€â”€â”€â”€â”€â”˜
                                message=decrypt(secret_key,message)
</code></pre></div></div>

<p>è¿™ä¸ªç›¸ä¿¡å¤§å®¶éƒ½æ¯”è¾ƒç†Ÿäº†ï¼Œå®ƒæœ€ç®€å•ï¼Œæ€§èƒ½ä¹Ÿå¥½ã€‚ä½†æ˜¯é—®é¢˜åœ¨äºå¦‚ä½•ï¼ˆåœ¨ä¸¤ä¸ªäººä¹‹é—´ï¼‰å®‰å…¨åœ°å…±äº« secret keyï¼Œä¸èƒ½æ³„éœ²ã€‚</p>

<h2 id="éå¯¹ç§°åŠ å¯†å…¬é’¥åŠ å¯†">éå¯¹ç§°åŠ å¯†/å…¬é’¥åŠ å¯†</h2>
<p>å‡è®¾ï¼šå‘é€æ–¹æå‰é€šè¿‡å¯é æ–¹å¼è·å¾—æ¥æ”¶æ–¹çš„ public keyã€‚</p>

<p>ç”¨ public key åŠ å¯†ï¼Œç”¨ private key è§£å¯†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â”Œâ”€â”€â”€â”€â”€â” ciphertext=encrypt(public_key,message)â”Œâ”€â”€â”€â”€â”€â”
â”‚Aliceâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt;â”‚ Bob â”‚
â””â”€â”€â”€â”€â”€â”˜                                       â””â”€â”€â”€â”€â”€â”˜
                                message=decrypt(private_key,message)
</code></pre></div></div>

<p>è¿™ä¸ªå¤§å®¶åº”è¯¥ä¹Ÿæ¯”è¾ƒç†Ÿäº†ï¼Œå®ƒçš„æ€§èƒ½æ¯”å¯¹ç§°åŠ å¯†å·®å¾ˆå¤šã€‚å®ƒçš„é—®é¢˜åŒæ ·æ˜¯å¦‚ä½•å®‰å…¨å…±äº«å¯†é’¥ï¼šå¦‚ä½•çŸ¥é“ public key çœŸçš„å±äºæ¥æ”¶æ–¹ï¼Ÿæ”»å‡»è€…å¯ä»¥æ‹¿è‡ªå·±çš„ public key ç»™ Aliceï¼Œè°ç§°è‡ªå·±æ˜¯ Bobï¼ŒåŒæ—¶å‘ Bob å‘é€ä¼ªé€ çš„ä¿¡æ¯ï¼Œè¿™å°±æ˜¯ä¸­é—´äººæ”»å‡»ï¼ˆman-in-the-middle attackï¼‰ã€‚</p>

<p>ä½†ç°åœ¨æˆ‘ä»¬å¹¶ä¸æ˜¯è¦ä¿å¯†ï¼Œæˆ‘ä»¬å°±æ˜¯è¦åœ¨æ•´ä¸ªç½‘ä¸Šåˆ†å‘è‡ªå·±çš„ public keyï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯è®¤è¯ï¼ˆauthenticationï¼‰ï¼Œå› æ­¤éœ€è¦å¯ä¿¡çš„ç¬¬ä¸‰æ–¹æ¥èƒŒä¹¦ï¼Œéœ€è¦å»ºç«‹èµ·ä¸€ä¸ª Public Key Infrastructureï¼ˆPKIï¼‰ã€‚æ•°å­—è¯ä¹¦å¹²çš„å°±æ˜¯è¿™ä¸ªã€‚</p>

<p>å¦‚æœæˆ‘ä»¬å•çº¯ä¾èµ–å…¬é’¥åŠ å¯†æ¥é€šä¿¡ï¼Œé£é™©æ˜¯ä¸€æ—¦æ³„éœ² private keyï¼Œè¿‡å»çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å¯ä»¥è¢«è§£å¯†ï¼Œç§°ä¸ºç¼ºä¹å‰å‘å®‰å…¨ï¼ˆforward securityï¼‰ã€‚</p>

<h2 id="dh-key-exchange">DH Key Exchange</h2>

<p>å‡è®¾ï¼šæ— ï¼</p>

<p>é€šä¿¡åŒæ–¹å„è‡ªç”Ÿæˆè‡ªå·±çš„ç§˜å¯† a å’Œ bã€‚å„è‡ªç”¨å…¬å¼€å‚æ•° g å’Œç§˜å¯†è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å…¬å¼€å‚æ•° A å’Œ B å‘é€ç»™å¯¹æ–¹ï¼Œç„¶ååŒæ–¹éƒ½èƒ½ç®—å‡ºåŒä¸€ä¸ªå…±äº«çš„ç§˜å¯†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â”Œâ”€â”€â”€â”€â”€â”               A=g^a, g                â”Œâ”€â”€â”€â”€â”€â”
â”‚Aliceâ”‚&lt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt;â”‚ Bob â”‚
â””â”€â”€â”€â”€â”€â”˜               B=g^b                   â””â”€â”€â”€â”€â”€â”˜
shared_secret=B^a                        shared_secret=A^b
             =g^(a+b)                                 =g^(a+b)
</code></pre></div></div>
<p>ï¼ˆè¿™é‡Œçš„è¿ç®—å®é™…ä¸Šå…¨éƒ¨åœ¨ mod p ä¸‹è¿›è¡Œï¼‰</p>

<p>å®ƒçš„å¦™å¤„æ˜¯æ— éœ€å¯ä¿¡ç¬¬ä¸‰æ–¹ï¼Œå°±èƒ½å…±åŒ<strong>å•†è®¨</strong>å‡º shared secretï¼Œç”¨æ¥è¿›è¡Œå¯¹ç§°åŠ å¯†ã€‚å•†è®¨çš„è¿‡ç¨‹æ˜¯æ˜æ–‡åœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼Œä½†æ˜¯çªƒå¬è€…æ— æ³•ä»ä¸­ç®—å‡º shared secretã€‚æˆ‘ä»¬å¯ä»¥æ¯æ¬¡ä¼šè¯ä¸´æ—¶åå•†ä¸€ä¸ª keyï¼Œä»è€Œè·å¾—å‰å‘å®‰å…¨ã€‚</p>

<p>å…·ä½“æ€ä¹ˆç”¨ shared secret åŠ å¯†å°±æ˜¯å¦å¤–çš„è¯é¢˜ï¼Œæœ€ç®€å•çš„æ˜¯ ElGamalï¼Œç›´æ¥æŠŠ message å’Œ secret ä¹˜èµ·æ¥ã€‚å¦å¤– Bob åœ¨å‘é€ B çš„æ—¶å€™å¯ä»¥é¡ºä¾¿åŒæ—¶å‘é€ä½¿ç”¨ shared secret åŠ å¯†åçš„æ¶ˆæ¯ã€‚</p>

<p>TLS ä¹Ÿæœ‰è¿™ä¸ªå¯†é’¥äº¤æ¢çš„ç¯èŠ‚ï¼Œä½†å®ƒå…¶å®å¹¶ä¸ç›´æ¥ç”¨åå•†çš„ shared secret åŠ å¯†ï¼Œè€Œæ˜¯æŠŠå®ƒå½“ä½œä¸€ä¸ª pre-master keyï¼Œç”¨æ¥å†ç”Ÿæˆä¸€ä¸ª master keyã€‚ç†ç”±æ˜¯æ ¹æ®ä¸åŒçš„ç®—æ³•å’Œå‚æ•°äº¤æ¢å¾—åˆ°çš„ shared secret çš„é•¿åº¦æ˜¯å˜åŒ–çš„ï¼Œå®ƒå¸Œæœ›æœ‰ä¸€ä¸ªå›ºå®šé•¿çš„å¯†é’¥ç”¨æ¥åŠ å¯†åç»­çš„é€šä¿¡æ¶ˆæ¯ï¼Œå®ƒèƒ½æ”¯æŒä¸åŒçš„åŠ å¯†ç®—æ³•ã€‚</p>

<p>å¦å¤–ä¹Ÿå¯ä»¥ç†è§£æˆ a, A åˆ†åˆ«æ˜¯ Alice çš„ private key å’Œ public keyï¼Œä»»ä½•äººæ‹¿åˆ°è¿™ä¸ª public key å°±å¯ä»¥å’Œ Alice å»ºç«‹åŠ å¯†é€šä¿¡ï¼ŒAlice æ”¶åˆ°çš„æ¶ˆæ¯å´åˆå¿…é¡»è¦æ‹¥æœ‰å®ƒçš„ private key æ‰èƒ½è§£å¯†ã€‚è™½ç„¶å®ƒå¹¶ä¸åŒäºå…¬é’¥åŠ å¯†çš„æ–¹æ¡ˆï¼ŒåŠ å¯†é€šä¿¡å¹¶éç›´æ¥ç”¨ public key è¿›è¡Œï¼Œè€Œæ˜¯å¦ç®—å‡ºäº†ä¸€ä¸ª shared key è¿›è¡Œå¯¹ç§°åŠ å¯†ã€‚</p>

<h2 id="threshold-secret-sharing">(Threshold) Secret Sharing</h2>

<p>è¿™é‡Œçš„åœºæ™¯æ˜¯æˆ‘æƒ³è¦æŠŠä¸€ä¸ªæ¶ˆæ¯å‘ç»™ä¸€ç¾¤äººï¼Œè¦æ±‚ä»–ä»¬èšåœ¨ä¸€èµ·æ‰èƒ½çŸ¥é“è¿™ä¸ªæ¶ˆæ¯æ˜¯ä»€ä¹ˆã€‚æœ€ç®€å•çš„æ–¹æ³•å½“ç„¶æ˜¯ç›´æ¥æ‹†åˆ†æ¶ˆæ¯ã€‚ä½†æ˜¯æˆ‘ä»¬æƒ³è¦å®‰å…¨åœ° shareï¼Œè¦æœ‰è¿™æ ·çš„<strong>æ€§è´¨</strong>ï¼šéƒ¨åˆ†æ¶ˆæ¯çš„<strong>ä¿¡æ¯é‡</strong>å’Œæ²¡æœ‰æ¶ˆæ¯ä¸€æ ·ã€‚ä¹Ÿå°±æ˜¯æ— æ³•çª¥ä¸€æ–‘è€ŒçŸ¥å…¨è±¹ã€‚</p>

<p>è¦æ±‚æ‰€æœ‰äººåœ¨åœºè¿‡äºä¸¥æ ¼ï¼Œä¸€èˆ¬ä¸»è¦è€ƒè™‘æœ‰<strong>è¶³å¤Ÿå¤š</strong>çš„äººåœ¨åœºçš„æƒ…å½¢ã€‚å…¶ä¸­ä¸€ç§ç‰¹æ®Šæƒ…å†µå°±æ˜¯å‡è®¾ä¸€å…± n ä¸ªäººï¼Œ<strong>ä»»æ„</strong> t ä¸ªäººåœ¨åœºå°±èƒ½è§£å¯†ï¼Œè¿™ä¸ª t å¯è¢«ç§°ä¸º thresholdï¼Œè¿™ç§æƒ…å†µå«åš (t,n)-threshold secret sharingã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                  â”Œâ”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€&gt;â”‚share1â”œâ”€â”€â”
              â”‚   â””â”€â”€â”€â”€â”€â”€â”˜  â”‚reconstructâ”Œâ”€â”€â”€â”€â”€â”€â”
              â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt;â”‚secretâ”‚
â”Œâ”€â”€â”€â”€â”€â”€â”split â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚           â””â”€â”€â”€â”€â”€â”€â”˜
â”‚secretâ”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€&gt;â”‚share2â”œâ”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”˜      â”‚   â””â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”
              â””â”€â”€&gt;â”‚share3â”‚
                  â””â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<p>æœ€ç»å…¸çš„æ–¹æ¡ˆå°±æ˜¯ Shamir's secret sharingï¼šä»ä¸€ä¸ª t-1 æ¬¡å¤šé¡¹å¼ä¸Šå– n ä¸ªç‚¹ï¼åé¢çš„äº‹æƒ…å¤§å®¶å¯ä»¥è‡ªè¡Œè„‘è¡¥ï¼ˆ</p>

<h3 id="homomorphic-secret-sharing">Homomorphic Secret Sharing</h3>

<p>åŒæ€ï¼ˆHomomorphismï¼‰æ˜¯ä» A ç©ºé—´åˆ° B ç©ºé—´çš„æ˜ å°„ fï¼Œä½¿å¾—åœ¨ A ç©ºé—´çš„æ“ä½œ \(*_A\) å¯ä»¥å¯¹åº”åˆ° B ç©ºé—´çš„æ“ä½œ \(*_B\)ï¼Œå³ \(f(x *_A y) = f(x)*_B f(y)\)ã€‚åŠ å¯†å¯ä»¥çœ‹ä½œæ˜æ–‡å’Œå¯†æ–‡ä¹‹é—´çš„æ˜ å°„ï¼ŒåŒæ€åŠ å¯†å°±æ˜¯æŒ‡åœ¨å¯†æ–‡ä¸Šæ“ä½œä½¿å¾—åœ¨åŸæ–‡ä¸Šç”Ÿæ•ˆã€‚</p>

<p>Shamir's secret sharing å°±æœ‰ homomorphic çš„æ€§è´¨ï¼šå¯¹ share åšåŠ æ³•ç›¸å½“äºå¯¹åŸæ–‡åšåŠ æ³•ã€‚æ ¹æ®å¤šé¡¹å¼çš„æ€§è´¨ä¸éš¾æƒ³è±¡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â”€â”¤share1-1â”‚ + â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€&gt;â”‚sum-share1â”‚
              â”‚ â”Œâ”€&gt;â”‚share2-1â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”splitâ”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚reconstructâ”‚secret1â”‚
â”‚secret1â”œâ”€â”€â”€â”€â”€â”¤ â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt;â”‚   +   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚           â”‚secret2â”‚
              â”œâ”€â”¼â”€&gt;â”‚share1-2â”‚ + â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”     â””â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€&gt;â”‚sum-share2â”‚
              â”‚ â”œâ”€&gt;â”‚share2-2â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”splitâ”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚secret2â”œâ”€â”€â”€â”€â”€â”¼â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
              â””â”€â”¼â”€&gt;â”‚share1-3â”‚ + â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€&gt;â”‚sum-share3â”‚
                â””â”€&gt;â”‚share2-3â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<p>åŒæ€åŠ å¯†å¯ä»¥ç”¨æ¥åš Secure multi-party computationï¼šå¤šæ–¹è”åˆè®¡ç®—å‡ºä¸€ä¸ªç»“æœï¼Œä½†æ˜¯æ¯ä¸ªäººå¯¹è¾“å…¥æ•°æ®ä»ç„¶ä¸€æ— æ‰€çŸ¥ã€‚</p>

<p>ä¾‹å¦‚ä¸Šé¢è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥åšåŒ¿åæŠ•ç¥¨ï¼Œsecret æ˜¯æ¯ä¸ªäººçš„æŠ•ç¥¨ï¼ˆ1æˆ–0è¡¨ç¤ºåŒæ„æˆ–å¦ï¼‰ï¼Œæœ€ç»ˆåªèƒ½æ¢å¤å‡ºæ€»çš„ç¥¨æ•°ï¼Œä¸èƒ½æ¢å¤æ¯ä¸ªäººæŠ•çš„ç¥¨ã€‚å½“ç„¶è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç²—ç³™ï¼Œå› ä¸ºæ ¹æœ¬æ²¡æœ‰æ ¡éªŒè¾“å…¥çš„åˆæ³•æ€§ã€‚å¯ä»¥æŠ• 10 ç¥¨æˆ–è€… -10 ç¥¨å½±å“ç»“æœã€‚</p>

<h2 id="distributed-key-generation--threshold-encryption">Distributed Key Generation &amp; Threshold Encryption</h2>

<p>å¦‚æœæˆ‘ä»¬æœ‰ä¸€å¯¹å…¬ç§é’¥ï¼Œç„¶åé€šè¿‡ secret sharing æ¥åˆ†å‘ private keyï¼ˆåŒæ—¶é”€æ¯æ‰å®Œæ•´çš„ private keyï¼‰ï¼Œé‚£ä¹ˆå²‚ä¸æ˜¯å°±å¯ä»¥è¾¾æˆè¿™æ ·çš„æ•ˆæœï¼šç”¨è¿™ä¸ªå…¬é’¥åŠ å¯†çš„æ¶ˆæ¯å¿…é¡»è¦é›†ä½“ä¸­çš„äººåˆåŠ›æ‰èƒ½è§£å¯†ã€‚</p>

<p>è¿™ä¸ªæ–¹æ¡ˆè¦æ±‚æœ‰ä¸€ä¸ªå¯ä¿¡çš„åˆ†å‘è€…ã€‚æ›´å¥½çš„åšæ³•å½“ç„¶æ˜¯æ¯ä¸ªäººè‡ªé€‰ private keyï¼Œç„¶åé€šè¿‡ä¸€ä¸ªåå•†çš„è¿‡ç¨‹ç¡®å®šä¸‹æ¥ï¼ˆç¡®å®šå‡ºäº† public keyï¼Œä½†æ˜¯ private key ä»ç„¶æ˜¯ç§˜å¯†ï¼‰ã€‚</p>

<p>è¯´åˆ°ç”¨æ¯ä¸ªäººè‡ªå®šçš„ç§˜å¯†ç”Ÿæˆä¸€ä¸ªå…¬å…±ç§˜å¯†ï¼Œä¸ç¦æƒ³åˆ°ä¸Šé¢çš„ DH key exchangeã€‚å‡è®¾æ¯ä¸ªäººæœ‰è‡ªå·±çš„ $a_i$ï¼Œæ¯ä¸ªäººå¯ç®—å‡º $A_i=g^{a_i}$ è¿›è¡Œå…±äº«ï¼Œå¾—å‡ºé›†ä½“çš„ public key å°±æ˜¯ $A=\prod_{i=1}^nA_i$ï¼Œé›†ä½“çš„ private key æ˜¯ $a=\sum_{i=1}^na_i$ ä»ç„¶æœªçŸ¥ï¼Œéœ€è¦é›†ä½“åˆä½œæ‰èƒ½è·å¾—ã€‚</p>

<p>å½“æŸäººéœ€è¦å‘é€æ¶ˆæ¯ç»™é›†ä½“æ—¶ï¼Œéšæœºç”Ÿæˆä¸€ä¸ª private key bï¼Œç”¨ $A^b$ å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ï¼ŒåŒæ—¶å‘é€å¯†æ–‡å’Œ $A^b$ å³å¯ã€‚</p>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å†ç»“åˆä¸€ä¸‹ threshold secret sharing äº†ï¼Œæ¯ä¸ªäººæŠŠ $a_i$ å†è¿›è¡Œ (t,n)-secret sharingï¼Œè¿™æ ·ä»»æ„ t ä¸ªäººåˆåŠ›å°±å¯ä»¥æ¢å¤å‡º group çš„ private keyã€‚è¿™å°±å« threshold encryptionã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     x
    xx
   xxx
  xx xxxxxxxxxxxxxxxxxxxx
 xx                     x
xx   To Be Continued... x
 xx                     x
  xx xxxxxxxxxxxxxxxxxxxx
   xxx
    xx
     x
</code></pre></div></div>]]></content><author><name>xxchan</name></author><category term="CS" /><category term="crypto" /><summary type="html"><![CDATA[ç°ä»£å¯†ç å­¦ä¸»è¦æ˜¯å»ºç«‹åœ¨é—®é¢˜çš„å›°éš¾æ€§ä¸Šçš„ï¼šè§£å¯†ç›¸å½“äºæ±‚è§£ä¸€ä¸ªå›°éš¾çš„æ•°å­¦é—®é¢˜ã€‚è¿™äº›ç²¾å¦™çš„æ„é€ æ˜¯äººç±»æ™ºæ…§çš„ç²¾åï¼Œè¦æƒ³å®Œå…¨ç†è§£ä»–ä»¬ï¼Œéœ€è¦ä¸å°‘çš„æ•°å­¦åŸºç¡€ã€‚ä½†å…¶å®å¯†ç å­¦ä¹Ÿæ˜¯æ¨¡å—åŒ–çš„ï¼Œå®ƒæä¾›äº†å„ç§åŸºç¡€çš„åŸè¯­ï¼Œä½œä¸ºå¯¹å¯†ç å­¦æ²¡é‚£ä¹ˆæ„Ÿå…´è¶£çš„æ™®é€šäººï¼Œå°¤å…¶æ˜¯å¼€å‘è€…ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä¸ç”¨å®Œå…¨ææ‡‚é‡Œé¢çš„æ•°å­¦é—®é¢˜ï¼Œè€Œæ˜¯çœ‹å®ƒæä¾›äº†ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œä¿è¯äº†ä»€ä¹ˆæ€§è´¨ï¼Œè¿™ç§å¸¸è¯†æ€§çš„ç†è§£å…¶å®æ›´å®ç”¨ä¹Ÿæ›´é‡è¦ã€‚]]></summary></entry><entry><title type="html">MIT 6.824 Lab3 KVRaft ç¬”è®°</title><link href="https://xxchan.me/cs/2021/02/28/6.824-kvraft.html" rel="alternate" type="text/html" title="MIT 6.824 Lab3 KVRaft ç¬”è®°" /><published>2021-02-28T00:00:00+00:00</published><updated>2021-02-28T00:00:00+00:00</updated><id>https://xxchan.me/cs/2021/02/28/6.824-kvraft</id><content type="html" xml:base="https://xxchan.me/cs/2021/02/28/6.824-kvraft.html"><![CDATA[<p>æœ¬ä»¥ä¸º<a href="https://xxchan.github.io/cs/2021/02/24/6.824-raft.html">å†™å®Œ Raft</a> ä»¥åï¼Œåœ¨ Raft ä¸Šæ­ä¸€ä¸ª app æƒ³å¿…æ˜¯è¡Œäº‘æµæ°´ã€‚äº‹å®è¯æ˜æˆ‘é”™äº†ï¼Œåˆæ˜¯è¸©äº†è®¸å¤šå‘ã€‚ T_T</p>

<h2 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h2>

<h3 id="how-clients-find-the-cluster-leader">How clients find the cluster leader?</h3>

<p>æˆ‘ä»è¿™å¼€å§‹çš„ç¬¬ä¸€æ­¥å°±é™·å…¥äº†çº ç»“ã€‚Client è‡ªå·±è¦å­˜ leader æ˜¯è‚¯å®šçš„ï¼Œä½†æˆ‘åœ¨è€ƒè™‘å½“ leader æŒ‚æ‰ä»¥åï¼Œæ€ä¹ˆå¿«é€Ÿå‘ç°æ–°çš„ leaderï¼Œæƒ³è®© server ç›´æ¥ç»™ client è¿”å›ä¸€ä¸ª leader ä¿¡æ¯ï¼Œè¿™æ ·å°±èƒ½è®© client æ›´å¿«åœ°æ‰¾åˆ° leaderï¼Œè€Œä¸éœ€è¦éå†ä¸€éæ‰€æœ‰ serverã€‚ä½†æˆ‘çš„ Raft å®ç°é‡Œå¹¶æ²¡æœ‰å­˜ç°ä»» leaderã€‚</p>

<p>å…¶å®è¿™ä¸ªé—®é¢˜ç¡®å®æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä¸è¿‡æˆ‘ä¸è¯¥ä¸€ä¸Šæ¥å°±æƒ³è¿™ä¸ªä¼˜åŒ–ï¼Œè¿™æ˜æ˜¾ä¸ä¼šæ˜¯ä¸€å¼€å§‹çš„ç“¶é¢ˆã€‚ä¸€å¼€å§‹å…³æ³¨å¤§å±€ï¼Œæ­èµ·éª¨æ¶ï¼Œèƒ½è·‘èµ·æ¥æ‰æ˜¯æœ€é‡è¦çš„ã€‚è¿˜æ˜¯é‚£å¥è€è¯ï¼Œ<strong>premature optimization is the root of all evil</strong>ã€‚</p>

<h3 id="how-do-you-know-when-a-client-operation-has-completed">How do you know when a client operation has completed?</h3>

<p>è¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°å¯ä»¥è¯´æ˜¯è¿™ä¸ª lab é‡Œæœ€é‡è¦çš„é—®é¢˜ä¹‹ä¸€ï¼šæ€ä¹ˆå¤„ç†ã€Œé‡å¤ã€è¯·æ±‚ï¼Œæˆ–è€…è¯´æ€ä¹ˆå®ç°å¹‚ç­‰æ€§ã€‚</p>

<p>åŸºæœ¬çš„æ€è·¯ï¼Œæ²¡æœ‰ failure çš„æ—¶å€™æ˜¯å®¹æ˜“çš„ï¼šè¯·æ±‚å¼€å§‹æ—¶ï¼Œå‘ Raft å‘é€ä¸€ä¸ª entryï¼Œç„¶åç­‰å¾…è‡³ Raft apply è¿™æ¡ entry å°±å®Œæˆäº†ã€‚é‚£æ€ä¹ˆã€Œç­‰å¾…ã€å‘¢ï¼Ÿkvserver çš„ä»£ç ç»“æ„åº”è¯¥ä¹Ÿæ˜¯æœ‰ä¸€ä¸ª background worker è´Ÿè´£ä¸æ–­æ¥æ”¶ Raft apply çš„ commandï¼Œç„¶åæ›´æ–°çŠ¶æ€æœºï¼Œè€Œåˆ›é€ è¿™æ¡ command çš„ RPC handler éœ€è¦è¢«å®ƒé€šçŸ¥ apply å®Œæˆã€‚</p>

<p>ç®€å•ç”¨ä¸€ä¸ª channel è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºé¡ºåºä¼šå‡ºé—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦å¯¹ä¸€ä¸ªç‰¹å®š index è¿›è¡Œç­‰å¾…/é€šçŸ¥ã€‚è‡ªç„¶çš„æƒ³æ³•æ˜¯é‚£å°±ç”¨ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">map[int]chan</code> å§ã€‚æˆ‘çš„ç›´è§‰åˆè§‰å¾—ï¼Œåˆ›å»ºè¿™ä¹ˆå¤šå°å¯¹è±¡ä¸å¤ªä¼˜é›…ï¼Œä¼šä¸ä¼šå¼€é”€å¾ˆå¤§ï¼Ÿå—¯â€¦â€¦â€¦â€¦æ€»ä¹‹æˆ‘åˆæ˜¯ç»è¿‡ä¸€é€šå°è¯•ä»¥åï¼Œæœ€åè¿˜æ˜¯å›åˆ°äº†è¿™ä¸ªç®€å•æ–¹æ¡ˆã€‚ï¼ˆæˆ‘å»å·çœ‹äº†ä¸€çœ¼ etcdï¼Œå‘ç°å¥½åƒå°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰</p>

<p>è¿™ä¸ªåªæ˜¯ç»†èŠ‚å°é—®é¢˜ï¼Œå…³é”®çš„å¤§é—®é¢˜è¿˜æ˜¯å¦‚ä½•å¤„ç†é‡å¤è¯·æ±‚ï¼šä¸èƒ½é‡å¤ APPENDï¼Œä»¥åŠ PUT æ—§å€¼ä¸èƒ½è¦†ç›–æ–°å€¼ã€‚</p>

<p>æˆ‘ä¸€å¼€å§‹åœ¨æƒ³ï¼šGET æ˜¯ä¸æ˜¯ä¹Ÿæœ‰æ—¶æœºé—®é¢˜ï¼Ÿé‡å¤çš„ GET å¯ä»¥ç›´æ¥è¿”å›å½“å‰çš„å€¼å—ï¼Œè¿˜æ˜¯éœ€è¦ç¼“å­˜ç¬¬ä¸€æ¬¡æˆåŠŸæ—¶å€™çš„å€¼ï¼Ÿï¼ˆç”šè‡³æƒ³åšä¸€ä¸ª TCP çš„æ»‘åŠ¨çª—å£é‚£æ ·çš„æœºåˆ¶ï¼‰åæ¥æ²¡åšç»“æœç¼“å­˜ï¼Œå‘ç°æ ¹æœ¬æ²¡é—®é¢˜ã€‚ç°åœ¨æƒ³æ¥ï¼Œå…¶å®æ˜¯æ¯ä¸ª client è‡ªå·±æ˜¯ä¸€æ¬¡å‘é€ä¸€ä¸ªè¯·æ±‚çš„ï¼Œè€Œåˆ«çš„ client çš„è¯·æ±‚å’Œå®ƒæ˜¯å¹¶å‘çš„ï¼Œå°±æ˜¯æ²¡æœ‰å›ºå®šçš„é¡ºåºã€‚è™½ç„¶ä¸¤æ¬¡ GET åœ¨ server ç«¯çœ‹æ¥è¯»åˆ°äº†ä¸åŒçš„å€¼ï¼Œä½†å…¶å® client åªæ”¶åˆ°äº†ä¸€ä¸ªå€¼ï¼Œæ²¡æœ‰é—®é¢˜ã€‚</p>

<p>å®ç°ä¸Šé¦–å…ˆå®¹æ˜“æƒ³åˆ° client è¦è‡ªå¸¦ä¸€ä¸ª id å’Œåºåˆ—å· seqï¼Œç„¶å server å¯ä»¥è®°å½•æ¯ä¸ª client çš„æœ€å¤§ seqï¼Œè¦æ˜¯é‡åˆ°è¿‡å°±æ˜¯é‡å¤è¯·æ±‚äº†ã€‚ä¸€å¼€å§‹å¯èƒ½ä¼šè§‰å¾—è¿™ä¸ªæ£€æµ‹æ”¾åœ¨ RPC handler é‡Œå°±è¡Œäº†ï¼Œé‡åˆ°ä¸€ä¸ªè¯·æ±‚å°±æ›´æ–°ä¸€ä¸‹ã€‚ä½†è¿™é—®é¢˜é‡é‡ï¼šé¦–å…ˆæ”¶åˆ°è¿‡è¯·æ±‚ä¸ä»£è¡¨è¯·æ±‚æˆåŠŸï¼›æ›´å…³é”®çš„é—®é¢˜æ˜¯è¿™æ · server ä¹‹é—´æ²¡æ³•å…±äº« seq è®°å½•ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå¤±è´¥ã€‚</p>

<p>å…¶å® Raft ä¼šé‡å¤ apply æ˜¯å¿…ç„¶çš„ï¼šå‡è®¾ç¬¬ä¸€æ¬¡è¯·æ±‚è¶…æ—¶ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚åˆæ¥äº†ï¼Œæ­¤æ—¶å¹¶ä¸èƒ½ç¡®å®šç¬¬ä¸€æ¬¡è¯·æ±‚çš„çŠ¶æ€ã€‚å¦‚æœç›´æ¥æ”¾å¼ƒäº†æœ‰ç‚¹ä¸å¤ªå¥½ï¼Œå¦‚æœæäº¤è¿™ä¸ª command é‚£å°±ä¼šé‡å¤ apply äº†ã€‚åŠ ä¸Šä¸Šé¢è¯´çš„è¦åœ¨ server é—´å…±äº«çŠ¶æ€ï¼Œå¯ä»¥æƒ³åˆ°ã€Œå»é‡ã€è¿™ä¸ªåŠŸèƒ½åº”è¯¥æ”¾åˆ°ã€ŒçŠ¶æ€æœºã€é‡Œï¼ˆè€Œä¸æ˜¯å•ä¸ª server çš„å±€éƒ¨çŠ¶æ€ï¼‰ã€‚çŠ¶æ€æœºä¸­è®°å½•æ¯ä¸ª client applyã€ŒæˆåŠŸã€çš„æœ€å¤§åºåˆ—å·ï¼Œè€Œä¸æ˜¯ serverã€Œæ”¶åˆ°ã€çš„æœ€å¤§åºåˆ—å·ï¼Œå°±å¯ä»¥å®Œç¾è§£å†³äº†ã€‚</p>

<hr />

<p>æ•…äº‹æœ¬æ¥åˆ°è¿™é‡Œå°±è¯¥ç»“æŸäº†ï¼Œä½†æ˜¯æˆ‘åœ¨è¿™é‡Œåˆè‡ªä½œå¤šæƒ…ï¼Œå›°åœ¨äº†ä¸€ä¸ªè‡ªå·±ç»™è‡ªå·±æ‰¾çš„é—®é¢˜ä¸Šï¼Œè¿™å¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ª lab èŠ±äº†æˆ‘æœ€ä¹…æ—¶é—´çš„é—®é¢˜ã€‚ä¸Šé¢è¯´äº†åˆ¤æ–­è¯·æ±‚æˆåŠŸéœ€è¦ RPC handler ç­‰å¾…å¯¹åº” index çš„ command è¢« applyï¼Œè¿™é‡Œ apply æ˜¯æœ‰å¯èƒ½ä¼šå¤±è´¥çš„ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„ index ä¸Šå¹¶ä¸æ˜¯è¿™ä¸ª RPC æäº¤çš„ commandï¼Œæ‰€ä»¥ RPC å°±ç»™ client è¿”å›äº†ä¸€ä¸ªã€Œå¤±è´¥ã€çš„ç»“æœï¼Œè¿™æ²¡æœ‰é—®é¢˜ã€‚</p>

<p>ä½†æ˜¯ client ç«¯è¦æ€ä¹ˆå¤„ç†è¿™æ¬¡å¤±è´¥å‘¢ï¼Ÿå¯ä»¥ç›´æ¥å‘èµ·ç›¸åŒçš„è¯·æ±‚é‡è¯•ã€‚ä½†æˆ‘ä¸æ»¡è¶³äºæ­¤ï¼Œæˆ‘è§‰å¾—ï¼Œåœ¨ä¸€èˆ¬çš„æƒ…å†µä¸‹ï¼Œclient çŸ¥é“è¯·æ±‚å¤±è´¥äº†ï¼Œå¯ä»¥é€‰æ‹©æ”¾å¼ƒè¿™ä¸€è¯·æ±‚ï¼Œåšåˆ«çš„äº‹ã€‚å…³é”®æ˜¯ client æ˜ç¡®çŸ¥é“äº†ã€Œå¤±è´¥ã€ï¼Œè¿™æ˜¯ä¸€ä¸ªç¡®å®šçš„ç»“æœï¼Œè·å¾—äº†æ›´å¤šçš„ä¿¡æ¯ï¼Œè¿™åœ¨è¯­ä¹‰ä¸Šå’Œä¸ç¡®å®šå‘ç”Ÿäº†ä»€ä¹ˆçš„ã€Œè¶…æ—¶ã€æ˜¯ä¸ä¸€æ ·çš„ã€‚å› æ­¤ï¼Œè™½ç„¶è¿™ä¸ª lab è¦æ±‚ client å¤±è´¥é‡è¯•ï¼Œæˆ‘åšäº†ä¸€ä¸ªå° trickï¼šã€Œå¤±è´¥ã€åé‡è¯•æ—¶ seq+1ã€‚</p>

<p>è¿™ä¸€å¤„ç†ç»™æˆ‘å¸¦æ¥äº†ç›¸å½“å¤§çš„éº»çƒ¦ï¼Œä½†æ˜¯ä¹Ÿè®©æˆ‘çš„å®ç°ä¸å¾—ä¸æ›´ä¸¥è°¨äº†ï¼Œæœ¬æ¥æœ‰ä¸€äº›ç»†èŠ‚å…¶å®ç›´æ¥é‡è¯•çš„è¯æ˜¯æ— æ‰€è°“çš„ã€‚</p>

<p>æœ€ç®€å•çš„æƒ…æ™¯ï¼š</p>
<ol>
  <li>APPEND seq1 æˆåŠŸï¼Œä½†æ˜¯ reply ä¸¢åŒ…äº†ã€‚</li>
  <li>Client é‡è¯• APPEND seq1 å¤±è´¥ï¼Œclient æ”¶åˆ°å¤±è´¥å›å¤ï¼Œå¢åŠ  seq å˜ä¸º2ã€‚</li>
  <li>APPEND seq2 æˆåŠŸã€‚å‡ºç°äº†<strong>é‡å¤ APPEND</strong>ã€‚</li>
</ol>

<p>è¿™é‡Œçš„é—®é¢˜åœ¨äºï¼ŒRPC handler é‡Œå¹¶ä¸åšå»é‡æ£€æµ‹ï¼Œåªæœ‰ apply çš„æ—¶å€™ä¼šå»é‡ã€‚è¿™ä¸ªé—®é¢˜å¦‚æœ client ä¸æ”¹ seq æ— è„‘é‡è¯•çš„è¯æ˜¯ä¸å­˜åœ¨çš„ï¼Œç›¸å½“äºä¸ç®¡ä¹‹å‰çš„è¯·æ±‚æ˜¯å¦æˆåŠŸ RPC handler éƒ½é€‰æ‹©å†æäº¤ä¸€æ¬¡ commandï¼Œåæ­£çŠ¶æ€æœºä¼šåšå»é‡ã€‚</p>

<p>è¿™ä¸ªé—®é¢˜ä¿®å¤æ¯”è¾ƒå®¹æ˜“ï¼Œåœ¨ RPC handler çš„ä¸€å¼€å§‹åŠ ä¸€ä¸ªå»é‡æ£€æµ‹å°±å¯ä»¥äº†ï¼Œè¿™å¯èƒ½ä¼šç¨å¾®å‡å°‘ä¸€äº›é‡å¤æäº¤ï¼Œä½†æ˜¯å¹¶ä¸èƒ½å®Œå…¨é¿å…é‡å¤æäº¤ã€‚äºæ˜¯é—®é¢˜å°±åˆæ¥äº†ï¼š</p>

<ol>
  <li>APPEND seq1ï¼Œè¶…æ—¶ã€‚</li>
  <li>Client é‡è¯• APPEND seq1ï¼ŒRPC handler é‡Œæäº¤å®Œ command åç¬¬ä¸€æ¬¡æäº¤ apply æˆåŠŸã€‚</li>
  <li>ç¬¬äºŒæ¬¡æäº¤ apply å¤±è´¥ï¼Œè¿”å›å¤±è´¥ã€‚è¿™é‡Œè¿”å›äº†é”™è¯¯çš„ç»“æœï¼Œå¯æƒ³è€ŒçŸ¥ client ä¹‹åä¼šé‡æ–°æäº¤ seq2ï¼Œç„¶åå‡ºç°é‡å¤ APPENDã€‚</li>
</ol>

<p>è¿™ä¸ªé—®é¢˜å’Œ lab2 é‡Œæè¿‡çš„ä¸€ä¸ªé—®é¢˜å¾ˆåƒï¼šå‘é€ RPC è¯·æ±‚å‰åçŠ¶æ€å¯èƒ½å·²ç»å‘ç”Ÿäº†å˜åŒ–ã€‚è¿™é‡Œæ˜¯ç­‰å¾… command è¢« applyï¼Œé“ç†æ˜¯ä¸€æ ·çš„ã€‚æœ‰ã€Œç­‰å¾…ã€å°±éœ€è¦è€ƒè™‘ç­‰å¾…å‰åçš„çŠ¶æ€ã€‚è¿™ä¸ªé—®é¢˜çš„è§£å†³ä¹Ÿå¾ˆç®€å•ï¼Œç­‰å¾…å”¤é†’æ—¶å†æ£€æµ‹ä¸€æ¬¡å»é‡å°±å¯ä»¥äº†ã€‚</p>

<p>åˆ°è¿™é‡Œï¼Œå¯èƒ½ä¼šæ„Ÿè§‰å·®ä¸å¤šå¤Ÿæ„æ€äº†ï¼Œç„¶åå™©æ¢¦å°±æ¥äº†ï¼šè·‘å‡ ç™¾æ¬¡æµ‹è¯•ï¼Œåˆä¼šå‡ºç° missing/duplicate APPENDã€‚æ…¢æ…¢åœ°åˆ†æ logï¼Œå‘ç°æƒ…æ™¯æ˜¯è¿™æ ·çš„ï¼š</p>

<ol>
  <li>[server A] index 574 seq60 è¶…æ—¶ï¼ˆçœŸå®ç»“æœï¼šæˆåŠŸï¼‰ã€‚</li>
  <li>[server B] index 569 seq60 è¶…æ—¶ã€‚</li>
  <li>[server B] index 570 seq60 å¤±è´¥ -&gt; seq61ã€‚</li>
  <li>[server A] index 575 seq61 æˆåŠŸã€‚é‡å¤ APPENDã€‚</li>
</ol>

<p>å¯ä»¥å‘ç°ï¼Œå‡ºç°é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼šä¸­é€”æ›´æ¢ leaderã€‚å¯¹ leader A çš„ç»“æœä»ç„¶ä¸ç¡®å®šï¼ˆæœ€ç»ˆæˆåŠŸäº†ï¼‰çš„æƒ…å†µä¸‹ï¼Œæ¢äº†ä¸ªå‡ leader Bï¼Œç„¶åè¢«å®ƒçš„ç»“æœè¯¯å¯¼äº†ã€‚æ¢ leader çš„è¡Œä¸ºæ˜¯å¿…é¡»å­˜åœ¨çš„ï¼Œå¦åˆ™ç”±äºå‡ leader æ— æ³• commitï¼Œå¯¹å®ƒè¯·æ±‚ä¼šæ°¸è¿œè¶…æ—¶ã€‚</p>

<p>äº‹æƒ…å‘å±•åˆ°è¿™é‡Œï¼Œæˆ‘å°±ä¸æƒ³å†ç»§ç»­ä¿®é—®é¢˜äº†ï¼Œå†³å®šå›å½’æ·³æœ´ï¼Œä¸è¦è®© client å¢åŠ  seqï¼Œæ”¾å¼ƒå¯¹ã€Œå¤±è´¥ã€è¯­ä¹‰çš„æ‰§ç€ã€‚æˆ‘è§‰å¾—æœ‰ä¸€ä¸ªæ ¹æœ¬çš„é—®é¢˜ï¼Œå°±æ˜¯çŠ¶æ€æœºé‡Œåªè®°å½•äº†ã€Œapply æˆåŠŸçš„æœ€å¤§åºåˆ—å·ã€ï¼ŒçŠ¶æ€æœºå¹¶ä¸çŸ¥é“ã€Œå¤±è´¥ã€ï¼Œä¹Ÿä¸å­˜åœ¨è¯·æ±‚å’Œå›å¤çš„æ¦‚å¿µã€‚å¤„ç† RPC è¯·æ±‚å’Œå›å¤å®Œå…¨æ˜¯å•ä¸ª server çš„å±€éƒ¨é€»è¾‘ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œè¦è®©è¯·æ±‚æœ‰å¤æ‚çš„è¯­ä¹‰ï¼ˆå¦‚æœæ˜¯å¯ä»¥åšåˆ°çš„ï¼‰éœ€è¦éå¸¸å°å¿ƒï¼Œå¤„ç†å„ç§è¾¹ç•Œæƒ…å†µã€‚å› æ­¤ï¼Œæˆ‘è§‰å¾—è¿™ç§è®¾è®¡å¯èƒ½æœ¬èº«å°±æ˜¯ä¸å¤ªåˆé€‚çš„ï¼Œå¦‚æœæœ‰å¤æ‚è¯·æ±‚å¤„ç†çš„éœ€æ±‚ï¼Œé‚£å¯èƒ½éœ€è¦è€ƒè™‘å†å¢åŠ ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„çŠ¶æ€æœºäº†ã€‚</p>

<p>ï¼ˆP.S. ä¸Šé¢è¿™ä¸ªæ¢ leader çš„å°é—®é¢˜åº”è¯¥è¿˜æ˜¯å®¹æ˜“è§£å†³çš„ï¼Œå› ä¸ºå‡ leader ä¸èƒ½ commitï¼Œä¹‹æ‰€ä»¥ä¼šå¤±è´¥è‚¯å®šæ˜¯å·²ç»æ”¶åˆ°çœŸ leader commit çš„æ¶ˆæ¯ï¼Œå˜å›äº† followerï¼Œæ‰€ä»¥åœ¨ RPC è¿”å›çš„æ—¶å€™å†æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æ˜¯ leader åº”è¯¥å°±å¯ä»¥äº†ï¼‰</p>

<h3 id="keyvalue-index">Key/Value index</h3>

<p>å…¶å®è¿™æœ¬åº”è¯¥æ˜¯çŠ¶æ€æœºçš„å¤§å¤´ã€‚ä½†æ˜¯è¿™ä¸ª lab å¥½åƒå¹¶ä¸å¤ªå…³å¿ƒå­˜å‚¨å¼•æ“ï¼Œåšä¸€ä¸ªçº¯å†…å­˜çš„ hash index å°±å¤Ÿäº†ã€‚å­˜å‚¨å¼•æ“è¿™ä¸ªè¯é¢˜è¿˜æ˜¯ç­‰ä»¥åçœ‹å®é™…ç³»ç»Ÿå†æ…¢æ…¢ç ”ç©¶å§ã€‚</p>

<h3 id="snapshot">Snapshot</h3>

<p>Raft paper é‡Œæåˆ°äº†å®ƒä»¬ä½¿ç”¨äº†åŸºäº <code class="language-plaintext highlighter-rouge">fork()</code> çš„ copy-on-write æ¥å®ç°é«˜æ•ˆçš„ snapshotï¼Œä¸è¿‡ lab é‡Œæ²¡æè¿™å›äº‹å„¿ï¼Œæš´åŠ›é”ä½ copy å°±è¡Œäº†ã€‚æˆ‘ä¹Ÿæ²¡æ·±ç©¶ä¸‹å»ã€‚</p>

<p>è™½ç„¶æ€»ä½“æ¥è¯´å®ç° snapshot è¿˜æ˜¯ä¸å¤ªå›°éš¾çš„ï¼Œä½†æ˜¯è¦è€ƒè™‘çš„ç»†èŠ‚ä¾ç„¶ä¸å°‘ã€‚è¯¸å¦‚æ›´æ–° commitIndexï¼Œæ˜¯å¦è¦åˆ é™¤å¤šä½™ log ç­‰ç­‰æƒ…å†µï¼Œä¸€ä¸å°å¿ƒå°±å†™é”™äº†ã€‚è¿™ç§ä¸œè¥¿å¯èƒ½è¿˜æ˜¯æœ€å¥½è¦å…ˆæƒ³æ¸…æ¥šå„ç§æƒ…å†µç„¶åå†å®ç°ï¼Œå¯ä»¥åœ¨çº¸ä¸Šå…ˆç”»ç”»ã€‚</p>

<h2 id="è¸©å‘è®°å½•--å¿ƒå¾—ä½“ä¼š">è¸©å‘è®°å½• &amp; å¿ƒå¾—ä½“ä¼š</h2>

<h3 id="raft-æ²¡æµ‹å‡ºæ¥çš„é—®é¢˜">Raft æ²¡æµ‹å‡ºæ¥çš„é—®é¢˜</h3>

<h4 id="testsnapshotsize3b-éå¸¸æ…¢">TestSnapshotSize3B éå¸¸æ…¢</h4>

<p>è¿™ä¸ªé—®é¢˜åœ¨ lab 2 çš„ç¬”è®°é‡Œå·²ç»è¯´è¿‡äº†ï¼ŒåŸå› åœ¨äºè¿™ä¸ªæµ‹è¯•çš„ pattern æ˜¯æ¯æ¬¡å…ˆè¯·æ±‚æŒ‡ä»¤ï¼Œç­‰å®Œæˆäº†å†å‘ä¸‹ä¸€æ¡ï¼Œæ‰€ä»¥å¯¹ latency æœ‰è¦æ±‚ï¼Œè¦åœ¨è¯·æ±‚æ¥æ—¶ä¸»åŠ¨é¢å¤–å¤šå‘ä¸€æ¬¡å¿ƒè·³å°±å¯ä»¥äº†ã€‚</p>

<p>è¿™ä¸ªé—®é¢˜æ‹–åˆ°è¿™ä¹ˆåé¢æ‰å‡ºç°ï¼Œå…¶å®è¿˜æ˜¯æœ‰ç‚¹éš¾æ’æŸ¥çš„ï¼Œç¨å¾®æœ‰ç‚¹ä¸åˆç†ã€‚</p>

<h4 id="testcount2b-only-2-decided-for-index-6-wanted-3">TestCount2B: only 2 decided for index 6; wanted 3</h4>

<p>lab 3 å†™ç€å†™ç€ä¹Ÿé‡è·‘äº†ä¸€ä¸‹ lab 2 çš„æµ‹è¯•ï¼Œç»“æœå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ç‚¹å“äººã€‚çœ‹æ—¥å¿—å‘ç°æ˜æ˜è¾¾æˆäº†ä¸€è‡´ï¼Œå´æ²¡æœ‰ apply æ˜¯æ€ä¹ˆå›äº‹ã€‚ä»”ç»†çœ‹æ˜¯æœ‰ä¸€ä¸ª server æ›´æ–° commitIndex ä¹‹åæ²¡æœ‰ applyï¼Œæ˜¯ applier é‡Œçš„ Cond æ²¡æœ‰è¢«å”¤é†’ã€‚åŸå› æ˜¯æˆ‘å†™å‡ºäº†è¿™æ ·çš„ä»£ç ï¼š</p>

<pre><code class="language-Go">for {
  mu.Lock()
  cond.Wait()
  toApply = copy(...)
  mu.Unlock()

  for _, cmd := toApply {
    applyCh &lt;- cmd
  }
}
</code></pre>

<p>åˆæ˜¯ä¸€ä¸ªæœ‰ç‚¹å°èªæ˜çš„ä¼˜åŒ–ï¼šè§‰å¾— apply å¼€é”€æ¯”è¾ƒå¤§ï¼Œç”šè‡³å¯èƒ½ blockï¼Œæ‰€ä»¥å…ˆå¤åˆ¶å† applyï¼Œapply çš„æ—¶å€™ä¸éœ€è¦é”ã€‚å…¶å®è¿˜æ˜¯æœ‰ç‚¹é“ç†çš„ï¼Œä½†æ˜¯è¿™å°±å¸¦æ¥äº† Cond ä¸¢å¤±å”¤é†’çš„é—®é¢˜ã€‚è§£å†³çš„è¯è¦ä¹ˆå°±è€è€å®å®å¸¦é” applyï¼Œè¦ä¹ˆéœ€è¦å†åŠ ä¸€ä¸ªå®šæ—¶å”¤é†’ Cond çš„ workerã€‚å…¶å®æˆ‘åœ¨åš kvserver çš„æ—¶å€™ä¹Ÿæœ‰æ‹…å¿ƒè¿‡ç±»ä¼¼çš„é—®é¢˜ï¼Œæ²¡æƒ³åˆ°åœ¨è¿™é‡Œé‡åˆ°äº†ã€‚æ€»ä¹‹ä¸¢å¤±å”¤é†’æ˜¯ä¸€ä¸ªä½¿ç”¨ Cond éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚é€šå¸¸çš„æé†’æ˜¯ï¼šä¸æŒæœ‰é”çš„æ—¶å€™å”¤é†’å¯èƒ½ä¼šä¸¢å¤±ã€‚ä½†æˆ‘è¿™é‡Œä¸»åŠ¨é‡Šæ”¾äº† Cond é†’æ¥åå¸¦çš„é”ï¼Œæ‰€ä»¥å°±ç®—æŒæœ‰é”å”¤é†’ï¼Œè¿™å„¿ä¹Ÿå¯èƒ½ä¸¢ã€‚</p>

<p>ä¹‹æ‰€ä»¥è¿™ä¸ªæµ‹è¯•ä¼šå‡ºç°é—®é¢˜ï¼Œæ˜¯å› ä¸ºè¿™é‡Œ <code class="language-plaintext highlighter-rouge">cfg.one()</code> è¦æ±‚ã€ŒæˆåŠŸã€ï¼Œè€Œä¸”å‚æ•° <code class="language-plaintext highlighter-rouge">retry</code> æ˜¯ falseã€‚çœ‹æ³¨é‡Šå°±çŸ¥é“äº†ï¼š</p>
<blockquote>
  <p>if retry==true, may submit the command multiple times, in case a leader fails just after Start(). if retry==false, calls Start() only once, in order to simplify the early Lab 2B tests.</p>
</blockquote>

<p>å…¶ä»–æµ‹è¯•è¦ä¹ˆä¸è¦æ±‚ã€ŒæˆåŠŸã€ï¼Œåªéœ€è¦è¾¾æˆã€Œä¸€è‡´ã€ï¼Œè¦ä¹ˆæ˜¯ä¼šé‡è¯•çš„ã€‚</p>

<h4 id="appendentries">AppendEntries</h4>

<p>ä¸€ä¸ª 3A æ—©æœŸå¡äº†å¾ˆä¹…çš„å¤§é—®é¢˜ã€‚ç°è±¡æ˜¯å‡ºç° missing appendã€‚çœ‹ log è¿½è¸ªåˆ°å¦‚ä¸‹æƒ…å†µï¼š</p>

<ol>
  <li>Followerï¼ˆ4ï¼Œ4ï¼Œ4ï¼Œ4ï¼Œ4ï¼‰ï¼Œæ‹¬å·å†…ä¸º entry çš„ termã€‚</li>
  <li>Leader ï¼ˆ4ï¼Œ4ï¼Œ7ï¼Œ7ï¼‰</li>
  <li>Follower æ”¶åˆ° AppendEntriesï¼Œå˜ä¸ºï¼ˆ4ï¼Œ4ï¼Œ7ï¼Œ7ï¼Œ4ï¼‰</li>
  <li>ä¸‹æ¬¡é€‰ä¸¾ï¼Œfollower æŠ•ç¥¨ç»™äº† outdate candidateï¼ˆterm &lt; 7ï¼‰ã€‚</li>
</ol>

<p>é—®é¢˜å¾ˆæ˜æ˜¾äº†ã€‚åŸå› æ˜¯æˆ‘ä¸€å¼€å§‹çš„ AppendEntries å°† PrevLogIndex ä¹‹åçš„åŸæœ‰ entries ä¸€æ¦‚åˆ é™¤ï¼Œåæ¥ï¼ˆä¸Šæ¬¡è¯´äº†è¸©å‘ä¹‹åï¼‰æ”¹æˆäº†ä»…å½“ PrevLogIndex æœ‰å†²çªçš„æ—¶å€™æ‰åˆ é™¤ã€‚ä½†è¿™è¿˜ä¸å¤Ÿï¼Œæ²¡æœ‰å†²çªä¹Ÿä¸èƒ½ç®€å•è¦†ç›–ï¼Œè¿˜éœ€è¦é€é¡¹æ£€æŸ¥ã€‚çœ‹ paper ä¸­å…¶å®è¯´çš„å¾ˆæ¸…æ¥šï¼šif an existing entry conflictsï¼Œå¹¶ä¸ä»…ä»…æ˜¯ prev entry conflictsã€‚</p>

<p>åˆæ˜¯ä¸€ä¸ªåœ¨ Raft çš„æµ‹è¯•é‡Œæ²¡æµ‹å‡ºæ¥çš„é—®é¢˜ï¼Œåˆ†å¸ƒå¼ç³»ç»ŸçœŸçš„å¤„å¤„æ˜¯å‘ï¼ŒçœŸéœ€è¦å’¬æ–‡åš¼å­—å•Šã€‚</p>

<h3 id="æ—¥å¿—çš„é‡è¦æ€§">æ—¥å¿—çš„é‡è¦æ€§</h3>

<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œä¸èƒ½å•æ­¥æ‰§è¡Œï¼Œä¸èƒ½ä¾èµ– debugger äº†ï¼ˆè™½ç„¶æˆ‘ä¹Ÿä¸ä¼šç”¨ï¼‰ï¼Œlog å¯¹æ’æŸ¥é—®é¢˜éå¸¸é‡è¦ã€‚ä»¥å‰ï¼Œæˆ‘å·²ç»æ„Ÿå—åˆ° log ç›¸æ¯”æ— è„‘ print çš„ä¼˜è¶Šæ€§äº†ï¼Œåœ¨ lab 2 ä¸­æˆ‘ä¹Ÿä¼šå°½é‡å¤šæ‰“å°ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚ä½†æ˜¯åœ¨ lab 3ï¼Œæˆ‘å‘ç°åšçš„è¿˜æ˜¯å¹¶ä¸å¤Ÿã€‚</p>

<p>æˆ‘ä¸€åº¦è§‰å¾—å‡ºäº†é—®é¢˜ï¼Œçœ‹é—®é¢˜å‘¨å›´å‡ åä¸Šç™¾è¡Œ log å°±å·®ä¸å¤šå¤Ÿæ„æ€äº†ã€‚ä½†å¹¶å‘é‡å¤§çš„æ—¶å€™ï¼Œæœ‰æµ·é‡çš„æ— å…³ä¿¡æ¯ã€‚å› æ­¤ï¼Œéœ€è¦æ—¥å¿—<strong>å¯æœç´¢</strong>ã€<strong>å¯è¿½è¸ª</strong>ã€‚æˆ‘ä¸€å¼€å§‹åœ¨ lab 2 é‡Œçš„æ—¥å¿—å¾ˆéšæ„ï¼Œä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">DPrintf("%v: var1: %v, var2:%v, do something", rf.me, v1, v2)</code>ï¼Œè¿™é¦–å…ˆæœ‰ä¸ªå¤§é—®é¢˜å°±æ˜¯æˆ‘æ²¡æ³•è¿½è¸ªä¸€ä¸ªå›ºå®š server çš„æ—¥å¿—äº†ï¼Œå› ä¸ºåªæ‰“å°äº†ä¸€ä¸ªæ•°å­—ï¼Œæ²¡åŠæ³•æœç´¢ã€‚å…¶æ¬¡ï¼Œå› ä¸ºæ²¡æœ‰å›ºå®šæ ¼å¼ï¼Œåœ¨æœç´¢ä¸€äº›ä¸œè¥¿çš„æ—¶å€™å¯èƒ½è¦å†™å¾ˆå¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼ï¼ˆå‡­æˆ‘è¹©è„šçš„æ­£åˆ™è¡¨è¾¾å¼æ°´å¹³å‹‰å¼ºæ‹¼å‡ºæ¥ï¼‰ã€‚åœ¨ lab 3 ä¸­ï¼Œæˆ‘å°±æ›´æ³¨æ„äº†ä¸€ç‚¹ï¼Œä¾‹å¦‚ä¼šæ‰“æˆ <code class="language-plaintext highlighter-rouge">DPrintf("[kvserver][me: %v] balabala ...", kv.me, ...)</code>ã€‚ç”±äºæˆ‘åˆ°æŒºåé¢æ‰è¢«éš¾çœ‹çš„æ—¥å¿—æ¶å¿ƒåˆ°ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰å…¨é¢æ”¹é€ ï¼ˆè¿˜æ˜¯ä¸å¾—ä¸æ”¹äº†ä¸€äº›ï¼‰ã€‚æ›´è¿›ä¸€æ­¥ï¼Œå…¶å®è¿˜å¯ä»¥ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ï¼Œæ›´åŠ è§„èŒƒè¦æ±‚ï¼›ä¹Ÿå¯ä»¥å¯¹å¯¹è±¡å®ç°è‡ªå·±çš„ log æ–¹æ³•ï¼Œå›ºå®šæ‰“å°ä¸€äº›å¸¸ç”¨çš„å˜é‡ã€‚æ€»ä¹‹ï¼Œä¸ç®¡å…·ä½“å®è·µå¦‚ä½•ï¼Œæ—¥å¿—åº”è¯¥æ˜¯ä¸ªä»ä¸€å¼€å§‹å°±è¦è€ƒè™‘ï¼Œä¸èƒ½è‰ç‡å¯¹å¾…çš„ä¸œè¥¿ã€‚</p>

<p>å¦å¤–ï¼Œåœ¨æ’æŸ¥é—®é¢˜çš„æ—¶å€™ï¼Œå°¤å…¶æ˜¯æ€§èƒ½é—®é¢˜ï¼Œæˆ‘æœ‰æ—¶å€™è¿˜æƒ³ç»Ÿè®¡ä¸€ä¸‹ RPC è°ƒç”¨çš„æ¬¡æ•°ã€‚æˆ‘é€šè¿‡æ‰“æ—¥å¿—çš„æ–¹å¼å®ç°äº†ä¸€ä¸‹ï¼Œä½†è¿™ä¼šè®©æ—¥å¿—è†¨èƒ€å¾—å¾ˆå‰å®³ã€‚è¿™ä¸ªé—®é¢˜è®©æˆ‘æ„Ÿå—åˆ°äº†å¯¹ç›‘æ§ç³»ç»Ÿçš„éœ€æ±‚ï¼ˆPrometheus &amp; Grafanaï¼Ÿï¼‰ã€‚</p>

<h3 id="last-æ˜¯ä¸Šä¸€ä¸ªè¿˜æ˜¯æœ€åä¸€ä¸ª">last æ˜¯ä¸Šä¸€ä¸ªè¿˜æ˜¯æœ€åä¸€ä¸ªï¼Ÿ</h3>

<p>å…¶å® Raft é‡Œå¥½åƒæ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œä¸Šä¸€ä¸ªå°±æ˜ç¡®æ˜¯ prevï¼Œlast åªè¡¨ç¤ºæœ€åï¼Œè€Œä¸”æˆ‘è‡ªå·±ä¹Ÿæ²¡å†™é”™é‡åˆ°é—®é¢˜è¢«å‘åˆ°ã€‚åªæ˜¯æˆ‘è‡ªå·±çœ‹ä»£ç è¿˜æ˜¯ä¼šäº§ç”Ÿè¿·æƒ‘ï¼Œæƒ³åˆ°è¿™ä¸ªé—®é¢˜ã€‚æ€»ä¹‹ï¼Œå°½é‡è¦åŒºåˆ†ï¼Œç”šè‡³é¿å…ä½¿ç”¨å®¹æ˜“å‡ºç°æ­§ä¹‰çš„å‘½åï¼Œè™½ç„¶å‡­è¯­å¢ƒå¯èƒ½å¾ˆå®¹æ˜“åŒºåˆ†æ¸…æ¥šï¼Œä½†æ˜¯ä¸è¦ç»™è‡ªå·±å¸¦æ¥å¤„ç†é¢å¤–ä¿¡æ¯çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</p>

<h3 id="goroutine-leak">goroutine leak</h3>

<p>æˆ‘åœ¨æµ‹è¯•ä¸­é‡åˆ°äº†è¿™æ ·çš„æƒ…å†µï¼šæµ‹è¯•è¶…è¿‡ 10 åˆ†é’Ÿï¼Œå¼ºåˆ¶ç»“æŸï¼Œæ˜¾ç¤ºæœ‰ä¸¤ç™¾å¤šä¸ª goroutineï¼Œå¾ˆå¤šç­‰å¾…äº†è¶…è¿‡ 8 åˆ†é’Ÿã€‚</p>

<p>æœ‰ä¸€ä¸ªå¡ä½çš„ä½ç½®æ˜¯åœ¨ Raft çš„ applier é‡Œ <code class="language-plaintext highlighter-rouge">applyCh&lt;-</code>ã€‚è¿™ä¸ªä¼šå¡ä½åº”è¯¥æ˜¯å› ä¸º kvserver è¢« <code class="language-plaintext highlighter-rouge">Kill()</code> äº†ï¼Œä¸å†æ¶ˆè´¹æ¶ˆæ¯äº†ã€‚æˆ‘ä¸€å¼€å§‹ <code class="language-plaintext highlighter-rouge">Kill</code> é‡Œæ²¡æœ‰å¤„ç†é€»è¾‘ï¼Œä½†æ˜¯æ‰€æœ‰ background worker çš„å¾ªç¯éƒ½åŠ äº† <code class="language-plaintext highlighter-rouge">!rf.killed()</code> çš„æ¡ä»¶ï¼Œæœ¬ä»¥ä¸ºè¿™å·²ç»è¶³å¤Ÿäº†ã€‚ä½†è™½ç„¶å¾ªç¯æ¬¡æ•°ä¸ä¼šæ— é™äº†ï¼Œå¾ªç¯å†…éƒ¨è¿˜æœ‰æ— é™ç­‰å¾…çš„æ“ä½œï¼Œå¯èƒ½ä¼šå¡ä½ã€‚å› æ­¤ <code class="language-plaintext highlighter-rouge">Kill()</code> å†…éœ€è¦åšä¸€äº›å›æ”¶æ“ä½œã€‚é™¤äº† applierï¼Œè¿˜æœ‰å‡ ä¸ªåœ°æ–¹ç±»ä¼¼ã€‚</p>

<p>å½“ç„¶ï¼Œæµ‹è¯•å¡ä½å¹¶ä¸æ˜¯å› ä¸ºè¿™ä¸ªï¼Œè€Œæ˜¯å…¶ä»–åœ°æ–¹çš„é€»è¾‘é”™è¯¯ï¼Œè¿™é‡Œæ˜¯é¡ºæ‰‹è§£å†³ä¸€ä¸‹é—®é¢˜ã€‚</p>

<p>çœŸå®çš„ä¸€ä¸ªå¯¼è‡´å¡æ­»çš„é€»è¾‘é”™è¯¯ï¼škvserver é‡Œï¼Œæˆ‘ä¼ æ¶ˆæ¯çš„æ–¹å¼æ˜¯æ¯ä¸ª index å¯¹åº”çš„ channel å¤§å°ä¸º 1ï¼Œå› ä¸ºä¸ä¼šé‡å¤ apply ç›¸åŒçš„ indexã€‚ä½†æ˜¯åœ¨ InstallSnapshot ä¹‹åï¼Œæœ‰å¯èƒ½ lastApplied ä¼šå˜å°ï¼Œäºæ˜¯å°±é‡å¤ apply äº†ç›¸åŒçš„ indexï¼Œå°±æœ‰å¯èƒ½åœ¨ç›¸åº”çš„ channel ä¸Šå¡ä½äº†ã€‚</p>

<p>è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¦ä¹ˆå¯ä»¥æ‹’ç» install å¤ªè€çš„ snapshotï¼Œè¦ä¹ˆå¯ä»¥åœ¨ install ä¹‹åé‡å»ºä¸€ä¸ªæ–°çš„ <code class="language-plaintext highlighter-rouge">map[int]chan</code>ã€‚</p>

<h2 id="å°ç»“">å°ç»“</h2>

<p>çœ‹äº†ä¸€ä¸‹å†™å®Œ 6.824 çš„ Lab 1-3 åšäº†ä¸€ä¸ªæœˆï¼Œä¸€å…±èŠ±äº† 95 ä¸ªå°æ—¶ï¼ˆWakaTime æ•°æ®ï¼‰ï¼Œä¸€å¼€å§‹å®ç°å…¶å®ä¹Ÿè¿˜å¥½ï¼Œåˆ°æœ€å debug çœŸçš„æ˜¯èŠ±äº†å‡ åå°æ—¶ï¼Œæœ‰ç‚¹ä½“åŠ›æ´»çš„æ„Ÿè§‰ã€‚å°¤å…¶æ˜¯è·‘å‡ ç™¾æ¬¡æµ‹è¯•å¯èƒ½æ‰å‡ºç°ä¸€æ¬¡çš„ bugï¼Œçœ‹äº†åŠå¤©æ—¥å¿—ï¼Œä¿®å¥½äº†ï¼Œç»“æœè¿‡äº†å‡ ä¸ªå°æ—¶è·‘äº†å‡ ç™¾æ¬¡åˆå‡ºäº†æ–°çš„ bugï¼ŒçœŸå«äººæœ‰ç‚¹ç»æœ›ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿ debug ç¡®å®ä¸å®¹æ˜“ï¼Œå‡ºç°é—®é¢˜éš¾ä»¥å¤ç°ï¼Œæ‰€ä»¥éœ€è¦å„ç§æ‰‹æ®µçš„å¸®åŠ©ï¼Œæ¯”å¦‚è‰¯å¥½çš„æ—¥å¿—ï¼Œæµ‹è¯•æ¡†æ¶æ”¯æŒï¼ˆå¦‚æœåœ¨ç½‘ç»œæ­£å¸¸çš„æƒ…å†µä¸‹æµ‹è¯•ï¼Œé‚£å¾—å¤šä¹…æ‰èƒ½å‘ç°é—®é¢˜ï¼Ÿæ··æ²Œå·¥ç¨‹çœŸæ˜¯æ„ä¹‰é‡å¤§ï¼‰ã€‚</p>

<h3 id="æ”¶è·">æ”¶è·</h3>

<ul>
  <li>
    <p>é¢†åŸŸçŸ¥è¯†ï¼šRaftã€single-leader replication</p>
  </li>
  <li>ç¼–ç¨‹å®è·µç»ƒä¹ ï¼š
    <ul>
      <li>å¤šçº¿ç¨‹ï¼ˆåç¨‹/ä»»åŠ¡ï¼‰ç¼–ç¨‹ï¼š
        <ul>
          <li>ç­‰å¾…ä¸é€šçŸ¥</li>
          <li><code class="language-plaintext highlighter-rouge">chan</code> å’Œ <code class="language-plaintext highlighter-rouge">select</code></li>
          <li><code class="language-plaintext highlighter-rouge">Mutex</code> å’Œ <code class="language-plaintext highlighter-rouge">Cond</code></li>
        </ul>
      </li>
      <li>Background worker</li>
      <li>Bash script</li>
      <li>è®¡æ—¶å™¨</li>
    </ul>
  </li>
  <li>ç»å†äº†ä¸€äº›å¸¸è§çš„é—®é¢˜ï¼š
    <ul>
      <li>é˜»å¡æ“ä½œï¼ˆRPC è°ƒç”¨ã€channelï¼‰å‰åçŠ¶æ€å¯èƒ½ä¸ä¸€è‡´</li>
      <li>æ”¹ä»£ç è¦ find all usage æ£€æŸ¥å¤šå¤„ä¸€è‡´</li>
    </ul>
  </li>
  <li>å¦‚æœæŠ½æ‰ä¸€åˆ‡æŠ€æœ¯ç»†èŠ‚ï¼Œå‰©ä¸‹çš„ takeaway æˆ‘æƒ³å¯èƒ½æ˜¯ï¼š
    <ul>
      <li>è®¾è®¡å¥½äº†å†å¼€å§‹å®ç°ï¼Œè¦æƒ³æ¸…æ¥šä¸åŒæƒ…å†µä¸‹çš„è¡Œä¸ºè§„åˆ™ã€‚è®©ä»£ç å¿ å®åœ°éµå®ˆè§„åˆ™ï¼Œå¹¶é€šè¿‡ä¸€äº›æ‰‹æ®µæ¥æ£€éªŒå’Œä¿è¯ã€‚</li>
      <li>åœ¨å®ç°çš„ä¸€å¼€å§‹å°±è¦è€ƒè™‘å¦‚ä½•ä¸ºæ’æŸ¥é—®é¢˜è®¾ç½®è¾…åŠ©æ‰‹æ®µï¼ˆè¿™é‡Œæ˜¯ logï¼‰ï¼Œä¸è¦è½»æ•Œï¼Œä¸è¦è¿‡äºè‡ªä¿¡ã€‚</li>
      <li>Debug è¦æœ‰è€å¿ƒï¼Œä¹Ÿè¦åŠ¨è„‘å­ï¼Œå¯¹é—®é¢˜æ•æ„Ÿã€‚</li>
    </ul>
  </li>
</ul>]]></content><author><name>xxchan</name></author><category term="CS" /><category term="system" /><summary type="html"><![CDATA[æœ¬ä»¥ä¸ºå†™å®Œ Raft ä»¥åï¼Œåœ¨ Raft ä¸Šæ­ä¸€ä¸ª app æƒ³å¿…æ˜¯è¡Œäº‘æµæ°´ã€‚äº‹å®è¯æ˜æˆ‘é”™äº†ï¼Œåˆæ˜¯è¸©äº†è®¸å¤šå‘ã€‚ T_T]]></summary></entry></feed>