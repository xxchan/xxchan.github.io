<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>æˆ‘å¦‚ä½•åŠ¨åŠ¨å°æ‰‹å°±è®© CI æ—¶é—´å‡å°‘äº† 10 åˆ†é’Ÿ - XX&#39;s Blog</title>
<meta name="description" content="Stupidly effective ways to optimize Rust compile time">


  <meta name="author" content="xxchan">
  
  <meta property="article:author" content="xxchan">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="XX's Blog">
<meta property="og:title" content="æˆ‘å¦‚ä½•åŠ¨åŠ¨å°æ‰‹å°±è®© CI æ—¶é—´å‡å°‘äº† 10 åˆ†é’Ÿ">
<meta property="og:url" content="https://xxchan.me/cs/2023/02/11/optimize-rust-comptime.html">


  <meta property="og:description" content="Stupidly effective ways to optimize Rust compile time">







  <meta property="article:published_time" content="2023-02-11T00:00:00+00:00">






<link rel="canonical" href="https://xxchan.me/cs/2023/02/11/optimize-rust-comptime.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://xxchan.me/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="XX's Blog Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC">

<!-- end custom head snippets -->
  </head>

  <body class="layout--post">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          XX's Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/">Archive</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://xxchan.me/">
        <img src="https://avatars.githubusercontent.com/u/37948597?v=4" alt="xxchan" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://xxchan.me/" itemprop="url">xxchan</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Build something fun and useful</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="https://twitter.com/yayale_umi" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/xxchan" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/xxchan" itemprop="sameAs" rel="nofollow noopener noreferrer me">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="æˆ‘å¦‚ä½•åŠ¨åŠ¨å°æ‰‹å°±è®© CI æ—¶é—´å‡å°‘äº† 10 åˆ†é’Ÿ">
    <meta itemprop="description" content="Stupidly effective ways to optimize Rust compile time">
    <meta itemprop="datePublished" content="2023-02-11T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://xxchan.me/cs/2023/02/11/optimize-rust-comptime.html" class="u-url" itemprop="url">æˆ‘å¦‚ä½•åŠ¨åŠ¨å°æ‰‹å°±è®© CI æ—¶é—´å‡å°‘äº† 10 åˆ†é’Ÿ
</a>
          </h1>
          

    <p><em id="page-subtitle" class="page__subtitle p-name" itemprop="headline">
    Stupidly effective ways to optimize Rust compile time
    </em></p>



        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> ç›®å½•</h4></header>
              <ul class="toc__menu"><li><a href="#å¯ä¾›å‚è€ƒçš„æ•°æ®å›¾è¡¨">å¯ä¾›å‚è€ƒçš„æ•°æ®ã€å›¾è¡¨</a><ul><li><a href="#ci-waterfall--dag-graph">CI waterfall &amp; dag graph</a></li><li><a href="#cargo-build---timings">cargo build --timings</a></li></ul></li><li><a href="#step-1-compilation-cache">Step 1: Compilation cache</a></li><li><a href="#step-2-remove-unused-dependencies">Step 2: Remove unused dependencies</a></li><li><a href="#step-3-disable-incremental-compilation">Step 3: Disable incremental compilation</a></li><li><a href="#step-4-single-binary-integration-test">Step 4: Single binary integration test</a></li><li><a href="#å…¶ä»–ä¸€äº›å…ˆå‰å°±å­˜åœ¨çš„ä¼˜åŒ–">å…¶ä»–ä¸€äº›å…ˆå‰å°±å­˜åœ¨çš„ä¼˜åŒ–</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li></ul>

            </nav>
          </aside>
        
        <p><a href="/cs/2023/02/17/optimize-rust-comptime-en.html">English version of this post</a></p>

<p>è™½ç„¶ç»å¸¸æœ‰é€¸é—»æŠ±æ€¨ Rust ç¼–è¯‘é€Ÿåº¦è‡­åæ˜­è‘—åœ°æ…¢ï¼Œä½†æˆ‘ä»¬çš„é¡¹ç›® <a href="https://github.com/risingwavelabs/risingwave">RisingWave</a> åœ¨ç»è¿‡å‰äººæ¯”å¦‚ï¼ˆ<a href="https://github.com/skyzh">skyzh</a>ï¼Œ<a href="https://github.com/bugenzhao">BugenZhao</a>ï¼‰çš„ä¸€äº›åŠªåŠ›åï¼Œç¼–è¯‘é€Ÿåº¦å¹¶ä¸ç®—æ…¢ï¼Œç‰¹åˆ«æ˜¯æˆ‘è‡ªä»ç”¨ä¸Š M1 çš„ Macbook Pro åï¼Œç¼–è¯‘é€Ÿåº¦æ ¹æœ¬ä¸æ˜¯é—®é¢˜ï¼Œå…¨é‡ debug ç¼–è¯‘ä¹Ÿå°±ä¸¤ä¸‰åˆ†é’Ÿã€‚</p>

<p>ç„¶è€Œéšç€æ—¶é—´æ¨ç§»ï¼ŒCI é‡ŒåŠ äº†è¶Šæ¥è¶Šå¤šçš„ä¸œè¥¿ï¼Œè¶Šæ¥è¶Šè‡ƒè‚¿äº†ã€‚ç°åœ¨ main workflow éœ€è¦å¤§æ¦‚ 40minï¼ŒPR workflow éœ€è¦å¤§æ¦‚ 25min30sã€‚è™½ç„¶å¹¶ä¸ç®—ç‰¹åˆ«æ…¢ï¼Œä½†æ˜¯å¯ä»¥ä½“æ„Ÿåˆ°æ¯”ä»¥å‰å˜æ…¢äº†ä¸å°‘ã€‚</p>

<p>äºæ˜¯æˆ‘å‰ä¸¤å¤©å¿ƒè¡€æ¥æ½®ï¼Œå†³å®šèŠ±ç‚¹æ—¶é—´ç ”ç©¶ä¸€ä¸‹èƒ½ä¸èƒ½å†ä¼˜åŒ–ä¸€ç‚¹ç¼–è¯‘é€Ÿåº¦ã€‚</p>

<p>ä»¤æˆ‘éå¸¸éœ‡æƒŠçš„æ˜¯ï¼Œæ²¡æƒ³åˆ°å­˜åœ¨ç€ä¸€äº›éå¸¸ç®€å•çš„æ–¹æ³•ï¼ŒåŠ¨åŠ¨å°æ‰‹å°±äº§ç”Ÿäº†æƒŠäººçš„æˆæ•ˆã€‚æ„Ÿè§‰å®Œå…¨å¯ä»¥ç”¨ low-hanging fruitsã€silver bullet ç”šè‡³æ˜¯ free lunch æ¥å½¢å®¹ğŸ¤¯ã€‚</p>

<hr />

<p>P.S. å¾ˆæ¨è <a href="https://github.com/matklad">matklad</a>ï¼ˆIntelliJ Rust å’Œ rust-analyzer çš„åŸä½œè€…ï¼‰çš„ blogï¼š</p>
<ul>
  <li><a href="https://matklad.github.io/2021/09/04/fast-rust-builds.html">Fast Rust Builds</a></li>
  <li><a href="https://matklad.github.io/2021/02/27/delete-cargo-integration-tests.html">Delete Cargo Integration Tests</a></li>
</ul>

<p>æˆ‘ç”¨åˆ°çš„å¤§éƒ¨åˆ†æ–¹æ³•è¿™é‡Œé¢éƒ½æœ‰è®²åˆ°ï¼Œè€Œä¸”ä»–è®²çš„æ¸…æ™°æ˜äº†ã€‚å¦‚æœæ²¡æœ‰å¦å¤–è¯´æ˜ï¼Œé‚£ä¹ˆæ–‡ä¸­çš„ quote éƒ½æ¥è‡ªè¿™é‡Œã€‚</p>

<p>æœ¬æ–‡ç®—æ˜¯æˆ‘çš„å®è·µè®°å½•ï¼Œæˆ–è€…å¤§æ¦‚å¯ä»¥ä¹Ÿå½“æˆä¸€ä¸ª tl; dr ç‰ˆã€‚æ¯ä¸€ä¸ªä¼˜åŒ–ç‚¹éƒ½å¸¦ä¸Šäº†ç›¸åº”çš„ PRï¼Œå¯ä»¥ç»“åˆ <a href="https://github.com/risingwavelabs/risingwave/commits/main?after=d8198fa138003e1f1431053f4f5f09e4a5fa8fd8+69&amp;branch=main&amp;qualified_name=refs%2Fheads%2Fmain">commit history</a> ç‚¹å¼€æ¯ä¸ªä¼˜åŒ–ç‚¹å‰åçš„é¡µé¢å¯¹æ¯”æ•ˆæœã€‚</p>

<hr />

<p>P.P.S. ä¼˜åŒ–å®Œçš„ç»“æœï¼šmain æœ€å¿« 27minï¼ŒPR æœ€å¿« 16minï¼Œå¤§å¤šåœ¨ 17-19min å·¦å³ã€‚</p>

<h2 id="å¯ä¾›å‚è€ƒçš„æ•°æ®å›¾è¡¨">å¯ä¾›å‚è€ƒçš„æ•°æ®ã€å›¾è¡¨</h2>

<blockquote>
  <p>Build times are a fairly easy optimization problem: itâ€™s trivial to get direct feedback (just time the build), there are a bunch of tools for profiling, and you donâ€™t even need to come up with a representative benchmark.</p>
</blockquote>

<p>å‰ä¸¤å¤©åœ¨ç ”ç©¶ <a href="/cs/2023/02/08/profiling-101.html">profiling</a>ï¼Œé‚£ç°åœ¨æåˆ°è¦ä¼˜åŒ–ï¼Œå½“ç„¶åº”è¯¥çœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ•°æ®ã€å›¾è¡¨çœ‹çœ‹ï¼Œæ‰¾åˆ°ç“¶é¢ˆåœ¨å“ªé‡Œå†æ¥ä¼˜åŒ–ã€‚</p>

<h3 id="ci-waterfall--dag-graph">CI waterfall &amp; dag graph</h3>

<p>æˆ‘ä»¬çš„ CI ç”¨çš„æ˜¯ Buildkiteï¼Œæ­£å¸¸ç‚¹å¼€ä¸€ä¸ªé¡µé¢ï¼ˆä¾‹å¦‚ <a href="https://buildkite.com/risingwavelabs/pull-request/builds/17099">Build #17099</a>ï¼‰é•¿è¿™æ ·ï¼š</p>

<p><img src="/assets/img/comptime/buildkite-1.png" alt="buildkite-1.png" /></p>

<p>Buildkite æœ‰ä¸¤ä¸ªéå¸¸å¥½ç”¨çš„éšè—é¡µé¢ï¼Œåˆ†åˆ«æ˜¯åœ¨ <code class="language-plaintext highlighter-rouge">/waterfall</code> å’Œ <code class="language-plaintext highlighter-rouge">/dag</code> é‡Œï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>

<p><img src="/assets/img/comptime/buildkite-waterfall.png" alt="buildkite-waterfall.png" /></p>

<p><img src="/assets/img/comptime/buildkite-dag.png" alt="buildkite-dag.png" /></p>

<p>ä»å›¾ä¸Šæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹å‡ºï¼Œæœ€å¤§çš„ç“¶é¢ˆæ˜¯ simulation build -&gt; recovery test</p>

<h3 id="cargo-build---timings"><code class="language-plaintext highlighter-rouge">cargo build --timings</code></h3>

<p>Cargo è‡ªå¸¦ profiling ç¼–è¯‘æ—¶é—´çš„æ”¯æŒï¼ˆè²Œä¼¼æ˜¯å»å¹´ stablize çš„ï¼‰ï¼Œé€šè¿‡ <a href="https://doc.rust-lang.org/cargo/reference/timings.html">cargo build â€“timings</a> å¯ç”¨ï¼Œå®ƒé•¿è¿™æ ·ï¼š</p>

<p><img src="/assets/img/comptime/timings.png" alt="timings.png" /></p>

<p>å¯ä»¥å‘ç° <code class="language-plaintext highlighter-rouge">zstd-sys</code> ï¼Œ <code class="language-plaintext highlighter-rouge">protobuf-src</code> ç­‰å‡ ä¸ªä¾èµ–çš„ç¼–è¯‘æ—¶é—´éå¸¸é•¿ï¼Œåº”è¯¥æƒ³åŠæ³•çœ‹çœ‹èƒ½ä¸èƒ½ä¼˜åŒ–æ‰ã€‚</p>

<h2 id="step-1-compilation-cache">Step 1: Compilation cache</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7799">ci: try sccache #7799</a></p>

<blockquote>
  <p>If you think about it, itâ€™s pretty obvious how a good caching strategy for CI should work.</p>

  <p>Unfortunately, almost nobody does this.</p>
</blockquote>

<p><a href="https://xuanwo.io/reports/2023-04/">2023-04: ä¸ºä»€ä¹ˆä½ è¯¥è¯•è¯• Sccacheï¼Ÿ</a> åœ¨ xuanwo çš„å¤§åŠ›é¼“å¹ä¸‹ï¼Œæˆ‘éå¸¸å¿ƒåŠ¨ï¼Œä¹Ÿæƒ³å°è¯•ä¸€ä¸‹ sccacheã€‚è¿™ä¹Ÿç®—æ˜¯æˆ‘è¿™æ¬¡æä¼˜åŒ–çš„ä¸€å¤§ triggerã€‚</p>

<p>ä¸ç”¨å¤šè¯´ï¼Œéå¸¸ç®€å•å¥½ç”¨ã€‚åªéœ€åŠ ä¸¤ä¸ªç¯å¢ƒå˜é‡å°±ä¸€é”®å¯åŠ¨äº†ï¼š</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> RUSTC_WRAPPER=sccache</span>
<span class="k">ENV</span><span class="s"> SCCACHE_BUCKET=ci-sccache-bucket</span>
</code></pre></div></div>

<p>ï¼ˆåœ¨è¿™èƒŒåå…¶å®éœ€è¦ç ”ç©¶ä¸€ä¸‹ Buildkite å’Œ AWS çš„é…ç½®â€”â€”å®é™…ä¸Šä¹Ÿéå¸¸å‚»ç“œã€‚Buildkite å¯ä»¥é€šè¿‡ IAM Role æ¥è·å¾—æƒé™ï¼ŒåŠ ä¸€ä¸ª S3 bucket çš„ policy å°± work äº†ï¼Œå®Œå…¨ä¸ç”¨é…ç½® secret key ä¹‹ç±»çš„ä¸œè¥¿ã€‚æˆ‘ä¹‹å‰è¿˜åœ¨æ€è€ƒèƒ½ä¸èƒ½åœ¨ CI é‡ŒæŠŠ key echo å‡ºæ¥ï¼Œçœ‹æ¥æ˜¯å®Œå…¨ä¸ç”¨æ‹…å¿ƒè¿™ç§äº‹ğŸ˜„ï¼‰</p>

<p>æ•ˆæœç«‹ç«¿è§å½±ï¼Œsimulation build å‡å°‘äº† 2.5minï¼Œéç“¶é¢ˆçš„ debug build å‡å°‘äº† 4minã€‚è™½ç„¶å¹¶æ²¡æœ‰è´¨å˜ï¼Œä½†æ˜¯å…è´¹çš„é‡å˜ä½•ä¹è€Œä¸ä¸ºå‘¢ï¼Ÿ</p>

<h2 id="step-2-remove-unused-dependencies">Step 2: Remove unused dependencies</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7816">build: remove unused deps #7816</a></p>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">Cargo.toml</code> ä¸­å£°æ˜çš„ä¾èµ–ä¸ç®¡å®é™…ä¸Šæœ‰æ²¡æœ‰ç”¨åˆ°ï¼Œéƒ½ä¼šè¢«ç¼–è¯‘ã€‚æ›´ç”šå®ƒå¯èƒ½ä¼šå¼•å…¥ä¸å¿…è¦çš„ syncronization pointï¼Œå½±å“ç¼–è¯‘çš„å¹¶è¡Œåº¦ã€‚</p>

<p>æœ‰ä¸ªè€å·¥å…· <a href="https://github.com/est31/cargo-udeps">cargo-udeps</a> å°±æ˜¯å¹²è¿™ä¸ªçš„ï¼Œä½†æ˜¯é¦–å…ˆå®ƒå¹¶ä¸æ”¯æŒè‡ªåŠ¨ä¿®å¤ï¼Œè€Œä¸”å®ƒå¾ˆæ…¢ã€‚å¦å¤–å°è±¡ä¸­æœ‰ä¸€ä¸ªæ¯›ç—…æ˜¯å®ƒä¸èƒ½å’Œ <code class="language-plaintext highlighter-rouge">workspace-hack</code> ä¸€èµ·ç”¨ã€‚è¿™å¯¼è‡´ RisingWave ä¸­é•¿æœŸæ²¡æœ‰æ¸…ç†è¿‡ unused dependenciesã€‚å…¸å‹çš„ç ´çª—æ•ˆåº”ğŸ¥²ï¼</p>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">cargo-udeps</code> é‡Œå…³äºè‡ªåŠ¨ fix çš„ issue ä¸‹é¢çœ‹åˆ°æœ‰äººæäº† <a href="https://github.com/bnjbvr/cargo-machete"> <code class="language-plaintext highlighter-rouge">cargo-machete</code> </a>ï¼ˆè¿™ä¸ªåå­—æ˜¯å¤§ç åˆ€çš„æ„æ€ğŸ¤£ï¼‰ï¼Œè§‰å¾—æ˜¯éª¡å­æ˜¯é©¬æ‹‰å‡ºæ¥é›é›ï¼Œå‘ç°å®ƒè·‘çš„é£å¿«ï¼Œä¹Ÿæ²¡æœ‰å‡ ä¸ª false postiveã€‚è™½ç„¶æœ‰å‡ ä¸ªå°é—®é¢˜ï¼ˆå‚è€ƒä¸Šé¢ PR çš„ commit historyï¼‰ï¼Œä½†æ˜¯éƒ½èƒ½å®¹æ˜“åœ°ä¿®æ‰ã€‚</p>

<p>å¤§ç åˆ€çš„ä½œè€…æœ‰ä¸€ç¯‡ <a href="https://blog.benj.me/2022/04/27/cargo-machete/">blog</a> ä»‹ç»äº† unused dependencies çš„å±å®³ä»¥åŠ <code class="language-plaintext highlighter-rouge">cargo-machete</code> çš„è§£æ³•ã€‚å…·ä½“è¯´æ¥ï¼Œ<code class="language-plaintext highlighter-rouge">cargo-udeps</code> æ˜¯ç”¨ <code class="language-plaintext highlighter-rouge">cargo check</code> å…ˆç¼–è¯‘äº†ä¸€éå†åˆ†æçš„ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">cargo-machete</code> æ˜¯ç®€å•ç²—æš´çš„ <code class="language-plaintext highlighter-rouge">ripgrep</code>ã€‚</p>

<p>è¿™ä¸ª PR ä¸€ä¸‹å­åˆ æ‰äº†å¤§å‡ åä¸ª udepsï¼Œä¹Ÿæ˜¯è®©æˆ‘å¤§åƒä¸€æƒŠğŸ¤¯ã€‚å¯æƒœçš„æ˜¯ï¼ŒCI çš„æ—¶é—´å¹¶æ²¡æœ‰è¿›ä¸€æ­¥ç¼©çŸ­ï¼Œæ„Ÿè§‰è¿™ä¾§é¢è¯´æ˜äº† cache æ•ˆæœå¾ˆå¥½â€¦â€¦æˆ‘æœ¬åœ°ç²—ç•¥åœ°æµ‹äº†ä¸€ä¸‹ï¼Œå¤§æ¦‚å¿«äº†åå‡ äºŒåç§’ã€‚èšŠå­è…¿ä¹Ÿæ˜¯è‚‰å˜›ï¼Œanyway it's free!</p>

<hr />

<p>P.S. å…¶å® <code class="language-plaintext highlighter-rouge">cargo-udeps</code> é…ä¸€ä¸‹ä¹Ÿæ˜¯èƒ½å’Œ <code class="language-plaintext highlighter-rouge">workspace-hack</code> ç”¨çš„ï¼š<a href="https://github.com/risingwavelabs/risingwave/pull/7836">feat(risedev): add <code class="language-plaintext highlighter-rouge">check-udeps</code> #7836</a></p>

<h2 id="step-3-disable-incremental-compilation">Step 3: Disable incremental compilation</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7838">build: disable incremental build in CI #7838</a></p>

<p>å¹²å®Œä¸Šé¢ä¸¤ä¸ªå°å·¥ä½œä¹‹åæœ¬æ¥å·²ç»æƒ³æ”¶å·¥äº†ï¼Œä½†æœ‰ç‚¹å¿ƒç—’ç—’ï¼Œè§‰å¾— simulation build è¿˜æ˜¯æœ‰ç‚¹æ…¢ã€‚äºæ˜¯æˆ‘å†³å®š profiling ä¸€ä¸‹çœ‹çœ‹ã€‚ç„¶åå°±çœ‹åˆ°äº†ä¸€å¼€å§‹è´´çš„ <code class="language-plaintext highlighter-rouge">--timings</code> çš„å›¾ä¸­çš„å‡ ä¸ªåºç„¶å¤§ç‰©ï¼Œæˆ‘è§‰å¾—è¿™å¾ˆä¸ make senseã€‚</p>

<p>æˆ‘æœäº†æœ sccache non-cacheable çš„åŸå› ï¼Œå‘ç° incremental compilation æ˜¯ä¸ªå¾ˆå¤§çš„ caveatï¼Œç«‹é©¬å°è¯•äº†ä¸€ä¸‹ï¼Œç„¶åæˆ‘å†æ¬¡éœ‡æƒŠäº†ï¼Œæ•ˆæœ <em>stupidly</em> å¥½ï¼š</p>

<p><img src="/assets/img/comptime/timings-2.png" alt="timings-2" /></p>

<p>è¿™è®© simulation build çš„æ—¶é—´ç¬é—´ä¸‹é™äº† 4 åˆ†é’Ÿâ€¦â€¦</p>

<p>å®é™…ä¸Šæˆ‘ä»¬çš„ debug build æ˜¯å¾ˆæ—©ä¹‹å‰å°±å…³æ‰äº† incremental compilationï¼š</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[profile.ci-dev]</span>
<span class="py">incremental</span> <span class="p">=</span> <span class="kc">false</span>
</code></pre></div></div>

<p>ä½†æ˜¯åæ¥åŠ ä¸Šæ–°çš„ build profile çš„æ—¶å€™æ²¡æœ‰è€ƒè™‘åˆ°è¿™ä¸ªé—®é¢˜ã€‚ä»”ç»†æƒ³ä¸€æƒ³ï¼Œincremental compilation è™½å¥½ï¼Œä½†å®ƒåœ¨ CI é‡Œä¸å¤ª make sense å•Šï¼</p>

<blockquote>
  <p>CI builds often are closer to from-scratch builds, as changes are typically much bigger than from a local edit-compile cycle. For from-scratch builds, incremental adds an extra dependency-tracking overhead. It also significantly increases the amount of IO and the size of <code class="language-plaintext highlighter-rouge">./target</code>, which make caching less effective.</p>
</blockquote>

<p>äºæ˜¯æˆ‘å¹²è„†åœ¨ CI é‡ŒåŠ äº†ä¸ªå…¨å±€çš„ env var æ¥æŠŠå®ƒå…³æ‰ï¼Œä¸€åŠ³æ°¸é€¸ã€‚</p>

<h2 id="step-4-single-binary-integration-test">Step 4: Single binary integration test</h2>

<p><a href="https://github.com/risingwavelabs/risingwave/pull/7842">build: single-binary integration test #7842</a></p>

<p>åˆæ˜¯ä¸€ä¸ª <em>stupidly effective</em> çš„ä¼˜åŒ–ã€‚tl;dr:</p>

<p>Donâ€™t do this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tests/
  foo.rs
  bar.rs
</code></pre></div></div>

<p>Do this instead:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tests/
  integration/
    main.rs
    foo.rs
    bar.rs
</code></pre></div></div>

<p>å› ä¸º <code class="language-plaintext highlighter-rouge">tests/</code> ä¸‹é¢çš„æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šç¼–è¯‘æˆä¸€ä¸ªå•ç‹¬çš„ binaryï¼ˆæ„å‘³ç€ä¼šæ¯ä¸ªéƒ½ link ä¸€ä¸‹ä¾èµ–ï¼‰ã€‚é™¤äº†ç¼–è¯‘æ…¢ï¼Œè¿™ç”šè‡³è¿˜å¯èƒ½å¯¼è‡´æµ‹è¯•è·‘çš„æ…¢ï¼ˆ<code class="language-plaintext highlighter-rouge">cargo test</code> çš„ç¼ºé™·ï¼‰ã€‚</p>

<p>è¿™ä¸ªä¼˜åŒ–æ²¡æœ‰å‡å°‘æˆ‘ä»¬çš„æµ‹è¯•æ—¶é—´ï¼ˆå¯èƒ½æ˜¯å› ä¸º <code class="language-plaintext highlighter-rouge">cargo nextest</code> çš„ä¼˜è¶Šæ€§ï¼‰ï¼Œä½†å®ƒä¸€ä¸‹å­åˆå‡å°‘äº†å¿« 2 åˆ†é’Ÿçš„ç¼–è¯‘æ—¶é—´â€¦â€¦å¦å¤–è¯´æ¥æœ‰ç‚¹å¯ç¬‘çš„æ˜¯ï¼Œå®ƒè¿˜å‡å°‘äº† 2 åˆ†é’Ÿçš„ artifacts ä¸Šä¼ ä¸‹è½½ã€å‹ç¼©è§£å‹çš„æ—¶é—´â€¦â€¦ï¼ˆè™½ç„¶åè€…åœ¨ç“¶é¢ˆä¸Šå¹¶æ²¡æœ‰å½±å“ï¼‰</p>

<h2 id="å…¶ä»–ä¸€äº›å…ˆå‰å°±å­˜åœ¨çš„ä¼˜åŒ–">å…¶ä»–ä¸€äº›å…ˆå‰å°±å­˜åœ¨çš„ä¼˜åŒ–</h2>

<p>ä»¥ä¸Šå°±æ˜¯æˆ‘è¿™æ¬¡ä¼˜åŒ–çš„ä¸»è¦è¿‡ç¨‹äº†ï¼Œè¿™ä¸‹ç»ˆäºå¯ä»¥å¿ƒæ»¡æ„è¶³åœ°æ”¶å·¥äº†ã€‚æœ€åæƒ³å†æ€»ç»“ä¸€äº›å‰äººçš„åŠªåŠ›ï¼Œä»¥ä¾›å‚è€ƒã€‚</p>

<ul>
  <li>ä½¿ç”¨ <a href="https://github.com/nextest-rs/nextest"><code class="language-plaintext highlighter-rouge">cargo nextest</code></a> æ›¿ä»£ <code class="language-plaintext highlighter-rouge">cargo test</code>ã€‚</li>
  <li>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">workspace-hack</code> æŠ€æœ¯ï¼šè§ <a href="https://docs.rs/cargo-hakari/latest/cargo_hakari/about/index.html"><code class="language-plaintext highlighter-rouge">cargo hakari</code></a>ã€‚</li>
  <li>ç»™ cargo registry åŠ  cacheï¼Œæˆ–è€…ä½¿ç”¨åˆšåˆš stablize çš„ sparse indexï¼Œå¯å‚è€ƒ <a href="https://github.com/dcjanus">DCjanus</a> çš„è¿™ç¯‡ <a href="https://blog.dcjanus.com/posts/cargo-registry-index-in-http/">blog</a>ã€‚</li>
  <li>æŠŠå·¨å¤§çš„ crate æ‹†åˆ†æˆå¤šä¸ªå° createã€‚</li>
  <li>link time çš„ä¼˜åŒ–ï¼šlink å¾ˆèŠ±æ—¶é—´ï¼Œè€Œä¸”æ˜¯å•çº¿ç¨‹çš„ï¼Œå¾ˆå¯èƒ½æˆä¸ºç“¶é¢ˆ
    <ul>
      <li>ä½¿ç”¨æ›´å¿«çš„ linkerï¼š<code class="language-plaintext highlighter-rouge">mold</code> for Linux, <code class="language-plaintext highlighter-rouge">zld</code> for macOS. <code class="language-plaintext highlighter-rouge">lld</code> is the most mature option for production use.</li>
      <li>åœ¨ debug build ä¸Šå…³æ‰ Link Time Optimization (LTO)ã€‚</li>
    </ul>
  </li>
  <li>Trade-off between compile time and performanceï¼šCI çš„æ€»æ—¶é—´æ˜¯ç¼–è¯‘+æµ‹è¯•ï¼Œé‚£ä¹ˆç¼–è¯‘ä¼˜åŒ–ï¼ˆåŒ…æ‹¬ä¸Šé¢çš„ LTOï¼‰å¼€ä¸å¼€ï¼Œå¼€å¤šå°‘å®é™…ä¸Šå°±æ˜¯åœ¨å‰åè€…ä¹‹é—´ trade-offï¼Œå¯ä»¥è°ƒæ•´æµ‹è¯•æ¥è¾¾åˆ°ä¸€ä¸ªæ•´ä½“æœ€ä¼˜çš„é€‰æ‹©ã€‚ä¾‹å¦‚ bugen gg åœ¨æˆ‘ä»¬çš„ build profile ä¸Šçš„éªšæ“ä½œï¼š</li>
</ul>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># The profile used for CI in pull requests.</span>
<span class="c"># External dependencies are built with optimization enabled, while crates in this workspace are built</span>
<span class="c"># with `dev` profile and full debug info. This is a trade-off between build time and e2e test time.</span>
<span class="nn">[profile.ci-dev]</span>
<span class="py">inherits</span> <span class="p">=</span> <span class="s">"dev"</span>
<span class="py">incremental</span> <span class="p">=</span> <span class="kc">false</span>
<span class="nn">[profile.ci-dev.package."*"]</span> <span class="c"># external dependencies</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">1</span>
<span class="nn">[profile.ci-dev.package."tokio"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nn">[profile.ci-dev.package."async_stack_trace"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nn">[profile.ci-dev.package."indextree"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nn">[profile.ci-dev.package."task_stats_alloc"]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">3</span>

<span class="c"># The profile used for deterministic simulation tests in CI.</span>
<span class="c"># The simulator can only run single-threaded, so optimization is required to make the running time</span>
<span class="c"># reasonable. The optimization level is customized to speed up the build.</span>
<span class="nn">[profile.ci-sim]</span>
<span class="py">inherits</span> <span class="p">=</span> <span class="s">"dev"</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="mi">2</span>
<span class="py">incremental</span> <span class="p">=</span> <span class="kc">false</span>
</code></pre></div></div>

<p>é™¤æ­¤ä»¥å¤–çš„æ›´å¤šä¼˜åŒ–ä¹Ÿæœ‰å¾ˆå¤šäººéƒ½æ€»ç»“è¿‡ï¼Œæˆ‘å°±ä¸å¤šè¯´ï¼ˆä¸æ‡‚ï¼‰äº†ï¼Œä¾‹å¦‚è¿™ç¯‡ blogï¼š<a href="https://endler.dev/2020/rust-compile-times/">Tips for Faster Rust Compile Times</a></p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>CIã€å¼€å‘è€…ä½“éªŒè¿™ç§ä¸œè¥¿å¾ˆå®¹æ˜“å°±ä¼šåœ¨æ— äººç…§æ–™çš„æƒ…å†µä¸‹å˜å¾—æ‚è‰ä¸›ç”Ÿï¼Œä½†å¦‚æœå®šæœŸæ‰“ç†ä¸€ä¸‹ï¼Œå¯èƒ½ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„æ”¶è·ï¼Œä¸€ç‚¹ç‚¹å¾®å°çš„åŠªåŠ›å°±å¸¦æ¥å·¨å¤§çš„æå‡ã€‚</p>

<p>æœ€åå†æ‘˜ä¸¤æ®µ matklad <a href="https://matklad.github.io/2021/09/04/fast-rust-builds.html">blog</a> é‡Œçš„è¯ä½œç»“ï¼š</p>

<blockquote>
  <p>Compilation time is a <em>multiplier</em> for basically everything. Whether you want to ship more features, to make code faster, to adapt to a change of requirements, or to attract new contributors, build time is a factor in that.</p>

  <p>It also is a non-linear factor. Just waiting for the compiler is the smaller problem. The big one is losing the state of the flow or (worse) mental context switch to do something else while the code is compiling. One minute of work for the compiler wastes more than one minute of work for the human.</p>
</blockquote>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#cs" class="page__taxonomy-item p-category" rel="tag">CS</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2023-02-11T00:00:00+00:00">February 11, 2023</time></p>

      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=%E6%88%91%E5%A6%82%E4%BD%95%E5%8A%A8%E5%8A%A8%E5%B0%8F%E6%89%8B%E5%B0%B1%E8%AE%A9+CI+%E6%97%B6%E9%97%B4%E5%87%8F%E5%B0%91%E4%BA%86+10+%E5%88%86%E9%92%9F%20https%3A%2F%2Fxxchan.me%2Fcs%2F2023%2F02%2F11%2Foptimize-rust-comptime.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fxxchan.me%2Fcs%2F2023%2F02%2F11%2Foptimize-rust-comptime.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fxxchan.me%2Fcs%2F2023%2F02%2F11%2Foptimize-rust-comptime.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/cs/2023/02/08/profiling-101.html" class="pagination--pager" title="Profiling 101
">Previous</a>
    
    
      <a href="/cs/2023/02/17/optimize-rust-comptime-en.html" class="pagination--pager" title="Stupidly effective ways to optimize Rust compile time
">Next</a>
    
  </nav>

    </div>
    
    <div class="page__comments">
    <script src="https://giscus.app/client.js"
        data-repo="xxchan/xxchan.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyNzM2NzY1MTE="
        data-category="Announcements"
        data-category-id="DIC_kwDOEE_4384CAfZi"
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script> 
    </div>
    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You May Also Enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/misc/2024/06/12/quotation-mark.html" rel="permalink">Why English Quote (') looks bad in my blog?
</a>
      
    </h2>
    <p class="archive__item-excerpt" itemprop="description">As you might have noticed, I write blogs in both Chinese and English. My approach to multilingual blogs is straightforward and somewhat brute-force: I simply...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/this-week-in-risingwave/2023/04/02/twirw-migration.html" rel="permalink">New site for This Week in RisingWave
</a>
      
    </h2>
    <p class="archive__item-excerpt" itemprop="description">This Week in RisingWave is now migrated to a new dedicated site: this-week-in-risingwave.vercel.app.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/cs/2023/02/17/optimize-rust-comptime-en.html" rel="permalink">Stupidly effective ways to optimize Rust compile time
</a>
      
    </h2>
    <p class="archive__item-excerpt" itemprop="description">How I reduced 10 minutes of CI time without much effort
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/cs/2023/02/08/profiling-101.html" rel="permalink">Profiling 101
</a>
      
    </h2>
    <p class="archive__item-excerpt" itemprop="description">A beginner's guide to profiling
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->
  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 XX's Blog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- start custom analytics snippet -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2MN995FKFK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2MN995FKFK');
</script>
<!-- plausible -->
<!-- <script defer data-domain="xxchan.github.io" src="https://plausible.io/js/script.js"></script> -->
<!-- tinybird -->
<script defer src="https://unpkg.com/@tinybirdco/flock.js" data-host="https://api.tinybird.co" data-token="p.eyJ1IjogIjg5YmViNjUxLTMyMDAtNDJiZS04YjhhLWNjODJlYzY1YTg1NyIsICJpZCI6ICI4NjZiMmQ1YS1iYmM4LTRiNTQtYjA2Ni01ZTA4ODdiNTY0NzUiLCAiaG9zdCI6ICJldV9zaGFyZWQifQ.dAvDGeYfY9f7pE8ezo6Ehlp-45agnU559VzuKqZMMDs"></script>
<!-- end custom analytics snippet -->








  </body>
</html>
